<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dklinity - Clinical Research Database</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');
* { box-sizing: border-box; }
:root {
  --portable-bg-photo: url('Background iimage.png') center/cover no-repeat;
  --portable-bg-texture:
    radial-gradient(circle at 20% 20%, rgba(148, 163, 184, 0.18), transparent 45%),
    radial-gradient(circle at 80% 80%, rgba(96, 165, 250, 0.16), transparent 50%),
    repeating-linear-gradient(120deg, rgba(15, 61, 92, 0.06), rgba(15, 61, 92, 0.06) 1px, transparent 1px, transparent 16px),
    linear-gradient(135deg, rgba(248, 250, 255, 0.96) 0%, rgba(237, 244, 252, 0.96) 100%);
}
body { 
  font-family: "Manrope", "Segoe UI", sans-serif; 
  background:
    /* AI / CI neural dots (teal family) */
    radial-gradient(circle at 78% 30%, rgba(31,68,90,0.18), transparent 45%),
    radial-gradient(circle at 85% 55%, rgba(25,56,75,0.14), transparent 50%),

    /* Trial network lines */
    repeating-linear-gradient(
      120deg,
      rgba(31,68,90,0.06),
      rgba(31,68,90,0.06) 1px,
      transparent 1px,
      transparent 16px
    ),

    /* DNA helix waves */
    repeating-linear-gradient(
      60deg,
      rgba(31,68,90,0.05),
      rgba(31,68,90,0.05) 2px,
      transparent 2px,
      transparent 22px
    ),

    /* Base clinical teal gradient */
    linear-gradient(
      135deg,
      #f6f9fb 0%,
      #ecf3f6 45%,
      #e3edf1 100%
    );
  background-attachment: fixed;
  background-size: cover;
  margin: 0; 
  padding: 0; 
  min-height: 100vh; 
  position: relative;
  display: flex;
  flex-direction: column;
}
body::before { content: none; }
.container { position: relative; z-index: 1; width: 100%; max-width: none; margin: 0; background: transparent; border-radius: 0; box-shadow: none; overflow: hidden; flex: 1 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
.header { background: linear-gradient(135deg, #1f445a 0%, #1c3d52 55%, #19384b 100%); color: #fff; padding: 12px 20px; text-align: center; box-shadow: 0 4px 20px rgba(9,26,36,0.35); }
.header-content { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; }
.header-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.95); padding: 4px; box-shadow: 0 3px 12px rgba(0,0,0,0.25); transition: transform 0.3s ease, box-shadow 0.3s ease; }
.header-left { display: flex; align-items: center; gap: 12px; }
.header-center { flex: 1; display: flex; align-items: center; justify-content: center; }
.header-right { display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
.header-brand-text { font-weight: 900; letter-spacing: 0.6px; text-transform: uppercase; }
.header-brand-text.home-brand { color: #10324a; font-size: 20px; }
.header-brand-text.hub-brand { color: #66c165; font-size: 18px; }
.header-nav-marketing { display: flex !important; align-items: center; gap: 20px; justify-content: flex-end; }
.header-nav-marketing.hidden { display: none !important; }
.header#mainHeader.home-mode .header-logo { width: 60px; height: 60px; border-radius: 12px; }
.header#mainHeader.hub-mode .header-logo { width: 40px; height: 40px; border-radius: 50%; }
.header#mainHeader.hub-mode { background: linear-gradient(135deg, #1f445a 0%, #1c3d52 55%, #19384b 100%) !important; }
.header#mainHeader.hub-mode > div:first-child { color: #ffffff; }
.header#mainHeader.hub-mode > div:first-child > div { color: #ffffff; }
.header#mainHeader.hub-mode .hub-home-only { color: #ffffff; }
.section-header-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; margin: 0 0 16px 0; }
.section-title { margin: 0; color: #1e3a8a; font-size: 26px; font-weight: 800; }
.section-toolbar { margin-bottom: 0; }
.section-toolbar-group { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.header-logo:hover { transform: scale(1.08); box-shadow: 0 5px 18px rgba(0,0,0,0.35); }
.header-text h1 { margin: 0; font-size: 32px; font-weight: 800; letter-spacing: -0.8px; }
.header-text p { margin: 0; font-size: 11px; opacity: 0.95; max-width: 600px; line-height: 1.3; font-weight: 500; }
.nav-tabs { display: flex; gap: 10px; padding: 0; background: transparent; border-bottom: none; overflow-x: auto; position: static; z-index: 99; box-shadow: none; justify-content: center; }
.nav-tabs.hidden { display: none; }
.nav-tab { padding: 12px 16px; border: none; background: transparent; cursor: pointer; font-size: 15px; color: #1e3a8a; border-bottom: 3px solid transparent; transition: all 0.2s; font-weight: 600; white-space: nowrap; }
.nav-tab:hover { background: rgba(30, 58, 138, 0.08); color: #1a4fb3; }
.nav-tab.active { color: #1a4fb3; border-bottom-color: #1a4fb3; font-weight: 700; }
.nav-tab.back { padding: 12px 12px; font-size: 13px; margin-right: 8px; border-right: 1px solid rgba(200,200,200,0.3); }
.header#mainHeader.hub-mode .nav-tab { color: rgba(255,255,255,0.85); }
.header#mainHeader.hub-mode .nav-tab:hover { background: rgba(255,255,255,0.12); color: #ffffff; }
.header#mainHeader.hub-mode .nav-tab.active { color: #66c165; border-bottom-color: #66c165; font-weight: 600; }
.header#mainHeader.hub-mode .nav-tab.back { border-right-color: rgba(255,255,255,0.2); }
.login-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.65); display: none; align-items: center; justify-content: center; z-index: 2000; }
.login-card { width: 380px; background: #ffffff; border-radius: 14px; padding: 26px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35); border: 1px solid #e2e8f0; }
.login-title { font-size: 20px; font-weight: 800; color: #0f172a; margin: 0 0 6px 0; }
.login-sub { font-size: 13px; color: #475569; margin: 0 0 16px 0; }
.login-field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
.login-field label { font-weight: 600; font-size: 12px; color: #1e293b; }
.login-field input { padding: 10px 12px; border: 1px solid #cbd5f5; border-radius: 8px; font-size: 14px; }
.login-error { display: none; padding: 10px 12px; border-radius: 8px; background: #fee2e2; color: #991b1b; font-size: 12px; margin-bottom: 12px; border: 1px solid #fecaca; }
.user-session { display: none; align-items: center; gap: 10px; }
.user-pill { background: rgba(15, 61, 92, 0.12); color: #0f3d5c; padding: 6px 10px; border-radius: 14px; font-size: 12px; font-weight: 700; }
.user-role { background: rgba(102, 193, 101, 0.2); color: #2f855a; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
.dash-news-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: rgba(255,255,255,0.9); border: 1px solid rgba(203, 213, 225, 0.7); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
.dash-news-item:hover { border-color: #93c5fd; box-shadow: 0 6px 16px rgba(30, 58, 138, 0.12); transform: translateY(-1px); }
.dash-news-logo { width: 72px; height: 72px; border-radius: 14px; object-fit: contain; border: 1px solid rgba(148, 163, 184, 0.6); background: #ffffff; padding: 6px; }
.dash-news-title { font-size: 13px; font-weight: 700; color: #0f3d5c; line-height: 1.4; }
.dash-news-meta { font-size: 11px; color: #64748b; margin-top: 4px; }
.news-detail-header { display: flex; align-items: center; gap: 16px; }
.news-detail-logo { width: 140px; height: 140px; border-radius: 18px; object-fit: contain; border: 1px solid rgba(148, 163, 184, 0.6); background: #ffffff; padding: 10px; }
.news-detail-title { font-size: 26px; font-weight: 800; color: #0f172a; margin: 0; line-height: 1.3; }
.news-detail-body { font-size: 14px; color: #334155; line-height: 1.7; }
.news-detail-link { margin-top: 18px; display: inline-flex; align-items: center; gap: 8px; color: #1e3a8a; font-weight: 700; text-decoration: none; }
.news-detail-link:hover { text-decoration: underline; }
.tab-content { display: none; padding: 24px; background: transparent; min-height: 60vh; }
.tab-content.active { display: block; }
.toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; flex-wrap: wrap; gap: 12px; }
.search-box { padding: 10px 14px; border: 2px solid #bfdbfe; border-radius: 8px; width: 240px; font-size: 14px; background: white; transition: all 0.2s; }
.search-box:focus { outline: none; border-color: #1e3a8a; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
.table-wrapper { overflow: auto; max-height: 520px; border: 1px solid #e6eef8; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; }
thead { background: #f0f7ff; border-top: 2px solid #1e3a8a; }
th { position: sticky; top: 0; z-index: 2; padding: 16px 14px; text-align: left; font-weight: 700; color: #1e3a8a; border-bottom: 3px solid #1e3a8a; font-size: 13px; text-transform: uppercase; letter-spacing: 0.4px; background: #f0f7ff; }
td { padding: 14px 14px; border-bottom: 1px solid #e6eef8; font-size: 14px; color: #334155; }
tbody tr:hover { background: #f0f5fa; }
.btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #1e3a8a; color: #fff; }
.btn-primary:hover { background: #1e40af; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4); }
.btn-success { background: #10b981; color: #fff; }
.btn-success:hover { background: #059669; }
.btn-danger { background: #ef4444; color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-secondary { background: #f1f5f9; color: #475569; }
.btn-secondary:hover { background: #e2e8f0; }
.btn-sm { padding: 8px 12px; font-size: 13px; }
.modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto; }
.modal.show { display: flex; align-items: center; justify-content: center; }
.modal-content { background: #fff; border-radius: 0; padding: 0; width: 100%; max-width: 100vw; max-height: 100vh; overflow-y: auto; box-shadow: none; }
.modal-header { font-size: 20px; font-weight: 700; margin-bottom: 18px; color: #1e3a8a; }
.modal-header-bar { display: flex; align-items: center; gap: 16px; background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%); color: white; padding: 20px 24px; margin: 0 0 20px 0; flex-wrap: wrap; }
.modal-header-bar button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
.modal-header-bar button:hover { background: rgba(255,255,255,0.3); }
.modal-header-bar h2 { margin: 0; font-size: 24px; color: white; flex: 1; }
.modal-inner { padding: 24px; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 18px; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-weight: 600; margin-bottom: 8px; color: #1e293b; font-size: 14px; }
.form-group input, .form-group textarea, .form-group select { padding: 10px; border: 1px solid #d0d9e8; border-radius: 6px; font-size: 14px; font-family: inherit; }
.form-group textarea { resize: vertical; min-height: 80px; }
.form-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
.badge { display: inline-block; padding: 5px 12px; border-radius: 14px; font-size: 13px; font-weight: 600; background: #dbeafe; color: #082f49; }
.badge-success { background: #dcfce7; color: #166534; }
.badge-warning { background: #fef3c7; color: #92400e; }
.alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; }
.alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
.alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
.alert-info { background: #dbeafe; color: #082f49; border: 1px solid #93c5fd; }
.alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 18px; }
.stat-card { padding: 18px; background: linear-gradient(135deg, rgba(12, 18, 45, 0.5) 0%, rgba(12, 18, 45, 0.35) 100%), var(--portable-bg-photo), var(--portable-bg-texture); border-radius: 12px; border: 2px solid rgba(191, 219, 254, 0.6); box-shadow: 0 2px 8px rgba(30, 58, 138, 0.08); transition: all 0.3s; cursor: default; }
.stat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(30, 58, 138, 0.12); border-color: #93c5fd; }
.stat-value { font-size: 26px; font-weight: 800; color: #1e3a8a; line-height: 1; }
.stat-label { font-size: 12px; color: #475569; margin-top: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
.cohort-section { background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
.cohort-item { background: #fff; padding: 10px; border: 1px solid #e6eef8; border-radius: 6px; margin-bottom: 8px; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; }
.mapping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-height: 400px; overflow-y: auto; border: 1px solid #e6eef8; padding: 12px; border-radius: 6px; }
.mapping-row { display: contents; }
.mapping-label { font-weight: 600; padding: 8px; color: #1e293b; }
.mapping-select { padding: 8px; border: 1px solid #e6eef8; border-radius: 6px; }
.sub-tabs { display: flex; gap: 4px; margin: 16px 0 12px 0; border-bottom: 2px solid #e6eef8; }
.sub-tab { padding: 10px 14px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.2s; }
.sub-tab:hover { background: #f1f5f9; }
.sub-tab.active { color: #667eea; border-bottom-color: #667eea; }
.tab-pane { display: none; }
.tab-pane.active { display: block; }
.multi-value-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 28px; }
.multi-value-tag { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 10px; border-radius: 16px; font-size: 12px; font-weight: 500; }
.multi-value-tag button { background: rgba(255,255,255,0.25); border: none; color: white; cursor: pointer; padding: 2px 5px; border-radius: 3px; font-size: 10px; }
.cohort-list { background: #f8fafc; padding: 12px; border-radius: 6px; margin: 12px 0; max-height: 300px; overflow-y: auto; }
.cohort-preview { background: #fff; border-left: 4px solid #10b981; padding: 10px; margin: 8px 0; border-radius: 4px; }
.cohort-preview.split { border-left-color: #f59e0b; }
.pagination { display: flex; gap: 8px; justify-content: center; align-items: center; margin-top: 16px; margin-bottom: 16px; }
.pagination button { padding: 8px 12px; border: 1px solid #e6eef8; background: #f8fafc; cursor: pointer; border-radius: 6px; font-size: 13px; }
.pagination button:hover { background: #e2e8f0; }
.pagination button.active { background: #1e3a8a; color: white; border-color: #1e3a8a; }
.pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination span { color: #64748b; font-size: 13px; }
.details-section { border: 1px solid #e6eef8; border-radius: 8px; margin-bottom: 10px; background: #f8fafc; }
.details-section summary { cursor: pointer; padding: 10px 12px; font-weight: 700; color: #1e3a8a; list-style: none; }
.details-section summary::-webkit-details-marker { display: none; }
.details-body { padding: 10px 12px 14px 12px; }
.diff-cell { background: #fff7ed; border-left: 3px solid #f59e0b; }
.value-note { display: inline-block; margin-left: 6px; font-size: 11px; font-weight: 700; color: #92400e; background: #fef3c7; padding: 2px 6px; border-radius: 10px; }
.modal-content.fullpage { border-radius: 0; }
.trial-layout { display: grid; grid-template-columns: 230px 1fr; gap: 16px; }
.trial-nav { border: 1px solid #e6eef8; border-radius: 10px; background: #f8fafc; padding: 12px; height: fit-content; position: sticky; top: 12px; }
.trial-nav-title { font-size: 12px; font-weight: 800; color: #0f172a; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 8px; }
.trial-nav-item { width: 100%; text-align: left; padding: 8px 10px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #475569; border-radius: 8px; margin-bottom: 4px; }
.trial-nav-item:hover { background: #e2e8f0; }
.trial-nav-item.active { background: #dbeafe; color: #1e3a8a; font-weight: 700; }
.trial-content { border: 1px solid #e6eef8; border-radius: 10px; padding: 16px; background: #fff; max-height: calc(100vh - 160px); overflow-y: auto; }
.trial-section { margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid #e6eef8; }
.trial-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.trial-section h3 { margin: 0 0 10px 0; font-size: 16px; color: #1e3a8a; }
.summary-grid { grid-template-columns: repeat(2, minmax(240px, 1fr)); }
.multi-entry-list { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 8px; }
.multi-entry-item { display: grid; grid-template-columns: 1fr auto auto; gap: 4px; align-items: center; padding: 6px; border: 1px solid #e6eef8; border-radius: 8px; background: #f8fafc; }
.multi-entry-item input { width: 100%; padding: 8px; border: 1px solid #d0d9e8; border-radius: 6px; font-size: 13px; font-family: inherit; }
.multi-entry-item .btn { padding: 4px 6px; font-size: 12px; line-height: 1; min-width: 22px; height: 22px; }
.details-layout { display: grid; grid-template-columns: 220px 1fr; gap: 16px; }
.details-nav { border: 1px solid #e6eef8; border-radius: 10px; background: #f8fafc; padding: 12px; height: fit-content; position: sticky; top: 12px; }
.details-nav-title { font-size: 12px; font-weight: 800; color: #0f172a; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 8px; }
.details-nav-item { width: 100%; text-align: left; padding: 8px 10px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #475569; border-radius: 8px; margin-bottom: 4px; }
.details-nav-item:hover { background: #e2e8f0; }
.details-nav-item.active { background: #dbeafe; color: #1e3a8a; font-weight: 700; }
.details-page { display: none; }
.details-page.active { display: block; }
.details-row-selector { display: flex; gap: 6px; flex-wrap: wrap; max-height: 140px; overflow: auto; border: 1px solid #e6eef8; padding: 8px; border-radius: 8px; background: #f8fafc; margin-bottom: 12px; }
.details-row-btn { padding: 6px 10px; border: 1px solid #e6eef8; background: #fff; cursor: pointer; border-radius: 6px; font-size: 12px; font-weight: 600; color: #1e293b; }
.details-row-btn:hover { background: #e2e8f0; }
.details-row-btn.active { background: #1e3a8a; color: #fff; border-color: #1e3a8a; }

.link-btn { background: none; border: none; color: #1e3a8a; cursor: pointer; font-weight: 700; font-size: 13px; padding: 0; text-decoration: underline; }
.link-btn:hover { color: #1e40af; }

.company-hero { display: grid; grid-template-columns: 120px 1fr; gap: 18px; align-items: center; padding: 16px; background: #f8fafc; border: 1px solid #e6eef8; border-radius: 12px; margin-bottom: 16px; }
.company-logo { width: 110px; height: 110px; border-radius: 14px; object-fit: contain; background: #fff; border: 1px solid #e6eef8; padding: 8px; box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08); }
.company-logo-placeholder { width: 110px; height: 110px; border-radius: 14px; background: #1e3a8a; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 28px; letter-spacing: 1px; }
.company-name { font-size: 22px; font-weight: 800; color: #0f172a; margin: 0; }
.company-meta { margin-top: 6px; color: #475569; font-size: 12px; font-weight: 600; }
.company-section { margin-bottom: 16px; }
.company-section-title { font-size: 14px; font-weight: 800; color: #1e3a8a; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.4px; }
.company-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
.company-card { background: #fff; border: 1px solid #e6eef8; border-radius: 10px; padding: 12px; }
.company-card-title { font-size: 13px; font-weight: 800; color: #1e293b; margin: 0 0 6px 0; }
.company-asset-table { width: 100%; border-collapse: collapse; }
.company-asset-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; color: #1e3a8a; padding: 8px; background: #f0f7ff; border-bottom: 2px solid #1e3a8a; }
.company-asset-table td { padding: 8px; font-size: 12px; border-bottom: 1px solid #e6eef8; color: #334155; }
.company-list { display: grid; gap: 6px; }
.company-list-item { background: #f8fafc; border: 1px solid #e6eef8; border-radius: 8px; padding: 8px 10px; font-size: 12px; color: #1e293b; }

.hub-hero { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 24px; padding: 20px 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); box-shadow: 0 8px 32px rgba(30,58,138,0.12); }
.hub-hero-title { font-size: 26px; font-weight: 700; color: #0f172a; letter-spacing: -0.5px; }
.hub-hero-subtitle { margin-top: 8px; font-size: 13px; color: #475569; font-weight: 500; line-height: 1.5; }
.hub-hero-pill { padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(59,130,246,0.2); background: rgba(255,255,255,0.9); font-size: 11px; font-weight: 700; color: #1e3a8a; white-space: nowrap; }
.hero-section { position: relative; overflow: hidden; border-radius: 18px; }
.hero-section.hidden-in-hub { display: none; }
/* === DKLINITY HERO BACKGROUND === */
.hero-bg {
  position: absolute;
  inset: 0;
  z-index: 0;
  pointer-events: none;

  background:
    /* AI / CI neural dots */
    radial-gradient(circle at 78% 30%, rgba(31,68,90,0.20), transparent 45%),
    radial-gradient(circle at 85% 55%, rgba(25,56,75,0.16), transparent 50%),

    /* Trial network lines */
    repeating-linear-gradient(
      120deg,
      rgba(31,68,90,0.065),
      rgba(31,68,90,0.065) 1px,
      transparent 1px,
      transparent 16px
    ),

    /* DNA helix waves */
    repeating-linear-gradient(
      60deg,
      rgba(31,68,90,0.055),
      rgba(31,68,90,0.055) 2px,
      transparent 2px,
      transparent 22px
    ),

    /* Base clinical blue gradient */
    linear-gradient(
      135deg,
      #f6f9fb 0%,
      #ecf3f6 45%,
      #e3edf1 100%
    );

  mask-image: radial-gradient(
    circle at 75% 50%,
    rgba(0,0,0,1),
    rgba(0,0,0,0) 80%
  );
  opacity: 1;
  filter: blur(1px);
}
.hero-content { position: relative; z-index: 2; padding: 48px 56px; }
.dashboard-hero { display: grid; grid-template-columns: minmax(240px, 1.2fr) minmax(200px, 0.8fr); gap: 24px; align-items: stretch; margin-bottom: 22px; padding: 24px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.6); background: linear-gradient(135deg, rgba(255,255,255,0.92), rgba(239,246,255,0.8)); box-shadow: 0 10px 28px rgba(30,58,138,0.14); position: relative; overflow: hidden; }
.dashboard-hero::before { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.1), transparent 45%), radial-gradient(circle at 80% 10%, rgba(14,116,144,0.08), transparent 50%); pointer-events: none; }
.dashboard-hero-copy { position: relative; z-index: 1; }
.dashboard-hero-tag { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 999px; background: rgba(59,130,246,0.12); color: #1e3a8a; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; }
.dashboard-hero-welcome { margin-top: 10px; font-size: 14px; font-weight: 700; color: #1e3a8a; letter-spacing: 0.4px; text-transform: uppercase; }
.dashboard-hero-title { margin: 12px 0 0 0; font-size: 30px; font-weight: 800; color: #0f172a; letter-spacing: -0.6px; }
.dashboard-hero-subtitle { margin-top: 10px; font-size: 14px; color: #475569; line-height: 1.6; max-width: 560px; }
.dashboard-hero-actions { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 10px; }
.dashboard-hero-cta { display: inline-flex; align-items: center; justify-content: center; padding: 10px 16px; border-radius: 10px; border: 1px solid transparent; background: transparent; color: #1e3a8a; font-size: 12px; font-weight: 700; letter-spacing: 0.4px; text-transform: uppercase; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border 0.2s ease; text-decoration: none; }
.dashboard-hero-cta:hover { transform: translateY(-1px); }
.dashboard-hero-cta.primary { background: #1e3a8a; color: #fff; border-color: rgba(30,58,138,0.6); box-shadow: 0 6px 16px rgba(30,58,138,0.2); }
.dashboard-hero-cta.primary:hover { box-shadow: 0 10px 22px rgba(30,58,138,0.28); }
.dashboard-hero-cta.outline { background: rgba(255,255,255,0.8); border-color: rgba(37,99,235,0.3); }
.dashboard-hero-cta.ghost { border-color: transparent; color: #1e3a8a; box-shadow: none; padding-left: 8px; padding-right: 8px; }
.dashboard-hero-pill { padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(59,130,246,0.2); background: rgba(255,255,255,0.95); font-size: 11px; font-weight: 700; color: #1e3a8a; }
.dashboard-hero-panel { position: relative; z-index: 1; border-radius: 16px; padding: 18px; background: rgba(255,255,255,0.9); border: 1px solid rgba(148,163,184,0.35); box-shadow: 0 6px 18px rgba(15,23,42,0.1); display: flex; flex-direction: column; justify-content: center; gap: 8px; }
.dashboard-hero-panel-title { font-size: 15px; font-weight: 800; color: #0f172a; letter-spacing: 0.2px; }
.dashboard-hero-panel-subtitle { font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.7px; }
.dashboard-section { margin-bottom: 8px; display: flex; align-items: flex-end; justify-content: space-between; gap: 12px; }
.dashboard-section-title { font-size: 18px; font-weight: 800; color: #0f172a; letter-spacing: -0.2px; }
.dashboard-section-subtitle { margin-top: 6px; font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; opacity: 0.7; }
.home-welcome { display: flex; justify-content: center; align-items: center; text-align: center; margin: 4px 0 18px 0; }
.home-welcome-text { font-size: 22px; font-weight: 800; color: #0f172a; letter-spacing: -0.3px; animation: welcomeRise 0.8s ease both; }
.hub-home-intro { margin: 10px 0 16px 0; padding: 14px 16px; border-radius: 14px; background: linear-gradient(135deg, rgba(239,246,255,0.9), rgba(226,232,240,0.8)); border: 1px solid rgba(148,163,184,0.35); }
.hub-home-title { font-size: 16px; font-weight: 800; color: #0f172a; margin-bottom: 6px; letter-spacing: -0.2px; }
.hub-home-subtitle { font-size: 13px; color: #475569; font-weight: 600; line-height: 1.5; }
.hub-intro-line { margin: 8px 0 10px 0; font-size: 13px; font-weight: 600; color: #1e293b; }

:root {
  --oneci-ink: #0f172a;
  --oneci-blue: #0b3c5d;
  --oneci-teal: #0ea5a4;
  --oneci-sky: #0ea5e9;
  --oneci-ice: #eaf4f8;
  --oneci-line: #d7e6ee;
}

.landing-nav { display: none; }

.landing-hero { display: grid; grid-template-columns: 1fr 1fr; gap: 0; padding: 60px 40px 60px 40px; background: linear-gradient(135deg, rgba(20, 25, 60, 0.7) 0%, rgba(20, 25, 60, 0.6) 100%), var(--portable-bg-photo), var(--portable-bg-texture); backdrop-filter: blur(10px); position: relative; overflow: hidden; border-radius: 0; margin: 0; border: 2px solid rgba(150, 180, 220, 0.4); border-right: 0; transition: all 0.3s ease; }
.landing-hero:hover { border-color: rgba(200, 200, 255, 0.7); box-shadow: 0 20px 40px rgba(50, 100, 200, 0.25); }
.landing-hero::before { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at top, rgba(150, 200, 255, 0.05), transparent 70%); pointer-events: none; z-index: 1; }
.landing-hero::after { content: ""; position: absolute; inset: -50%; opacity: 0; background: radial-gradient(circle at center, rgba(200, 150, 255, 0.2), transparent); animation: float 6s ease-in-out infinite; z-index: 1; }
#top { border-color: rgba(100, 150, 255, 0.5); }
#top::after { animation: float 6s ease-in-out infinite; }
.landing-hero-copy { position: relative; z-index: 2; display: flex; flex-direction: column; justify-content: center; padding-right: 40px; }
.landing-hero-title { font-size: 48px; font-weight: 800; color: #ffffff; letter-spacing: -0.8px; margin: 0; }
.landing-hero-sub { font-size: 28px; color: #66c165; margin-top: 12px; line-height: 1.4; font-weight: 600; }
.landing-hero-subtitle { font-size: 14px; color: #ffffff; margin-top: 16px; line-height: 1.8; }
.landing-hero-cta { margin-top: 24px; display: flex; flex-wrap: wrap; gap: 14px; }
.landing-btn { padding: 12px 28px; border-radius: 999px; border: 2px solid transparent; font-size: 13px; font-weight: 700; cursor: pointer; letter-spacing: 0.3px; transition: all 0.3s; }
.landing-btn.primary { background: #66c165; color: #0f3d5c; box-shadow: none; border-color: #66c165; }
.landing-btn.primary:hover { background: #58b050; border-color: #58b050; }
.landing-btn.ghost { background: transparent; border-color: #ffffff; color: #ffffff; }
.landing-btn.ghost:hover { background: rgba(255,255,255,0.15); }
.landing-hero-visual { position: relative; z-index: 2; width: 100%; height: 400px; background-size: cover; background-position: center; background-repeat: no-repeat; border: none; border-radius: 12px; }
.network-grid { width: 100%; height: 100%; position: relative; }
.network-node { position: absolute; width: 12px; height: 12px; border-radius: 50%; background: var(--oneci-teal); box-shadow: 0 0 0 6px rgba(14,165,164,0.15); }
.network-node.big { width: 18px; height: 18px; background: var(--oneci-blue); }
.network-label { position: absolute; font-size: 11px; font-weight: 700; color: var(--oneci-blue); }
.network-line { position: absolute; height: 1px; background: rgba(14,165,233,0.45); transform-origin: left center; }

.landing-section { margin-top: 24px; padding: 26px 28px; border-radius: 20px; background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(246, 250, 255, 0.98) 55%, rgba(242, 248, 255, 0.98) 100%); border: 1px solid rgba(190, 210, 230, 0.8); box-shadow: 0 16px 40px rgba(15, 60, 93, 0.08); }
.use-cases-section { position: relative; overflow: hidden; background: var(--portable-bg-photo), var(--portable-bg-texture); border: none; }
.use-cases-section::before { content: ""; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(248, 249, 255, 0.85) 0%, rgba(236, 244, 255, 0.9) 45%, rgba(249, 240, 255, 0.9) 100%); }
.use-cases-section > * { position: relative; z-index: 1; }
.use-cases-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
.use-case-card { background: rgba(255,255,255,0.85); border: 1px solid rgba(203, 213, 225, 0.7); border-radius: 16px; padding: 16px; box-shadow: 0 10px 24px rgba(79, 70, 229, 0.08); }
.use-case-title { font-size: 13px; font-weight: 800; color: #1e3a8a; margin: 0 0 6px 0; }
.use-case-sub { font-size: 12px; font-weight: 700; color: #475569; margin: 0 0 6px 0; }
.use-case-text { font-size: 12px; color: #64748b; line-height: 1.5; }
.use-case-cta { display: inline-flex; align-items: center; justify-content: center; margin-top: 10px; padding: 6px 14px; border-radius: 999px; border: 1px solid #c7d2fe; background: #eef2ff; color: #1e3a8a; font-size: 11px; font-weight: 700; text-decoration: none; }
.use-case-cta:hover { background: #dbe7ff; border-color: #93c5fd; }
#request-demo { background: linear-gradient(135deg, rgba(14, 80, 120, 0.15) 0%, rgba(30, 90, 117, 0.1) 100%), rgba(255,255,255,0.9); border: 1px solid rgba(30, 117, 162, 0.4); }
#about { background: linear-gradient(135deg, rgba(20, 25, 60, 0.7) 0%, rgba(20, 25, 60, 0.6) 100%), var(--portable-bg-photo), var(--portable-bg-texture); border: 1px solid rgba(190, 210, 230, 0.8); position: relative; overflow: hidden; }
#about .landing-section-sub,
#about .landing-section-title,
#about .landing-card-text {
  color: #ffffff;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.35);
}
#hubs .landing-section-sub {
  color: #b6f3d1;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.35);
}
#coverage .landing-section-sub,
#coverage .landing-section-title,
#coverage .landing-card-text,
#coverage .stat-label,
#coverage .stat-value {
  color: #ffffff;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.35);
}
#coverage::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(15, 61, 92, 0.55) 0%, rgba(15, 61, 92, 0.4) 100%), radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.18), transparent 55%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.14), transparent 55%);
  pointer-events: none;
}
#coverage > * {
  position: relative;
  z-index: 1;
}
.landing-section-title { font-size: 22px; font-weight: 900; color: var(--oneci-ink); margin: 0 0 10px 0; letter-spacing: -0.2px; }
.landing-section-sub { font-size: 13px; color: #475569; margin: 0 0 18px 0; text-transform: uppercase; letter-spacing: 0.9px; font-weight: 800; }
.landing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
.landing-card { background: linear-gradient(135deg, rgba(255,255,255,0.96) 0%, rgba(248, 250, 255, 0.98) 100%); border: 1px solid rgba(190, 210, 230, 0.9); border-radius: 14px; padding: 16px; box-shadow: 0 10px 24px rgba(15, 60, 93, 0.08); }
.landing-card-title { font-size: 14px; font-weight: 900; color: #1e3a8a; margin: 0 0 8px 0; }
.landing-card-text { font-size: 13px; color: #334155; line-height: 1.6; }
.landing-pill { display: none; }
.landing-hub-card { 
  padding: 28px 20px; 
  display: grid; 
  grid-template-rows: auto auto 1fr auto; 
  gap: 18px; 
  border-radius: 16px; 
  border: 2px solid rgba(150, 180, 220, 0.4); 
  transition: all 0.4s ease; 
  position: relative; 
  overflow: hidden; 
  align-items: center; 
  text-align: center; 
  background: linear-gradient(135deg, rgba(20, 25, 60, 0.7) 0%, rgba(20, 25, 60, 0.6) 100%), var(--portable-bg-photo), var(--portable-bg-texture); 
  backdrop-filter: blur(10px);
  perspective: 1000px;
  transform-style: preserve-3d;
  animation: hubFloat 8s ease-in-out infinite, rotateHub 12s linear infinite;
}

@keyframes hubFloat {
  0% { transform: translateY(0px) rotateX(0deg); }
  50% { transform: translateY(-8px) rotateX(1deg); }
  100% { transform: translateY(0px) rotateX(0deg); }
}

@keyframes rotateHub {
  0% { transform: translateY(0px) rotateY(0deg); }
  50% { transform: translateY(-8px) rotateY(8deg); }
  100% { transform: translateY(0px) rotateY(0deg); }
}

.landing-hub-card::before { 
  content: ""; 
  position: absolute; 
  inset: -2px; 
  border-radius: 16px; 
  background: linear-gradient(120deg, transparent, rgba(76,175,80,0.2), transparent); 
  pointer-events: none;
  opacity: 0;
  transition: 0.4s;
  z-index: 0;
}

.landing-hub-card:hover::before {
  opacity: 1;
}

.landing-hub-card::after { 
  content: ""; 
  position: absolute; 
  top: 0;
  left: -75%; 
  width: 50%; 
  height: 100%;
  background: linear-gradient(120deg, transparent, rgba(255,255,255,0.4), transparent);
  transform: skewX(-20deg);
  animation: lightSweep 6s infinite;
  z-index: 1;
}
@keyframes lightSweep {
  0% { left: -75%; }
  100% { left: 125%; }
}

.landing-hub-card:nth-child(1) { 
  border-color: rgba(100, 150, 255, 0.5);
  animation: hubFloat 7s ease-in-out infinite, rotateHub 12s linear infinite;
}

.landing-hub-card:nth-child(2) { 
  border-color: rgba(100, 200, 180, 0.5);
  animation: hubFloat 9s ease-in-out infinite, rotateHub 14s linear infinite;
}

.landing-hub-card:nth-child(3) { 
  border-color: rgba(180, 120, 255, 0.5);
  animation: hubFloat 8s ease-in-out infinite, rotateHub 12s linear infinite;
}
.landing-hub-card:hover { transform: translateY(-6px); border-color: rgba(200, 200, 255, 0.7); box-shadow: 0 20px 40px rgba(50, 100, 200, 0.25); }
.landing-hub-title { font-size: 24px; font-weight: 800; color: #ffffff; position: relative; z-index: 2; margin: 0; line-height: 1.3; }
.landing-hub-list { font-size: 14px; color: rgba(255,255,255,0.9); display: block; gap: 0; position: relative; z-index: 2; line-height: 1.8; }
.landing-hub-cta { background: rgba(255,255,255,0.2); color: #ffffff; border: 2px solid rgba(255,255,255,0.5); border-radius: 24px; padding: 10px 22px; font-size: 13px; font-weight: 700; cursor: pointer; justify-self: center; transition: all 0.3s; position: relative; z-index: 2; }
.landing-hub-cta:hover { background: rgba(255,255,255,0.35); border-color: #ffffff; box-shadow: 0 8px 16px rgba(255,255,255,0.2); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
.stat-card { padding: 18px; background: linear-gradient(135deg, rgba(20, 25, 60, 0.7) 0%, rgba(20, 25, 60, 0.6) 100%), var(--portable-bg-photo), var(--portable-bg-texture); border-radius: 12px; border: 2px solid rgba(150, 180, 220, 0.4); box-shadow: 0 8px 18px rgba(15, 23, 42, 0.22); transition: all 0.3s ease; cursor: default; position: relative; overflow: hidden; animation: statFloat 7s ease-in-out infinite; }
.stat-card::before {
  content: "";
  position: absolute;
  inset: -2px;
  border-radius: 12px;
  background: linear-gradient(120deg, transparent, rgba(76,175,80,0.2), transparent);
  opacity: 0;
  transition: 0.4s;
  pointer-events: none;
}
.stat-card::after {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(120deg, transparent, rgba(255,255,255,0.35), transparent);
  transform: skewX(-20deg);
  animation: lightSweep 6s infinite;
  pointer-events: none;
}
.stat-card:hover::before { opacity: 1; }
.stat-card:hover { transform: translateY(-6px); box-shadow: 0 16px 28px rgba(15, 23, 42, 0.25); border-color: rgba(200, 200, 255, 0.7); }
.stat-card:nth-child(2) { animation-duration: 8s; }
.stat-card:nth-child(3) { animation-duration: 9s; }
.stat-card:nth-child(4) { animation-duration: 8.5s; }
@keyframes statFloat {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0px); }
}
.request-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
.request-form input, .request-form select, .request-form textarea { padding: 10px; border: 1px solid #d0d9e8; border-radius: 8px; font-size: 13px; font-family: inherit; }
.request-form textarea { grid-column: 1 / -1; min-height: 90px; }

@media (max-width: 960px) {
  .landing-hero { grid-template-columns: 1fr; }
}
.trust-strip { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; padding: 8px 12px; border-radius: 999px; background: rgba(226,232,240,0.6); border: 1px solid rgba(148,163,184,0.35); font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 14px; }
.trust-strip span { display: inline-flex; align-items: center; gap: 6px; }
.trust-strip span::before { content: "â€¢"; color: #1e3a8a; font-weight: 800; }
.hub-grid-wrap { background: linear-gradient(180deg, #f4f8fc 0%, #eef4fa 100%); border-radius: 18px; padding: 18px; }
.hub-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; margin-bottom: 8px; }
.hub-card { position: relative; border: 2px solid rgba(122,196,210,0.45); border-radius: 28px; padding: 22px 20px; text-align: center; background: linear-gradient(180deg, #1f445a 0%, #19384b 100%); color: #eef8fb; box-shadow: 0 18px 36px rgba(9,26,36,0.35); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease; animation: hubReveal 0.5s ease both; overflow: hidden; min-height: 260px; }
.hub-card:nth-child(2) { animation-delay: 0.05s; }
.hub-card:nth-child(3) { animation-delay: 0.1s; }
.hub-card:hover { transform: translateY(-5px); box-shadow: 0 24px 44px rgba(9,26,36,0.45); border-color: rgba(144,215,228,0.75); }
.hub-card.active { box-shadow: 0 0 0 3px rgba(120,200,214,0.5), 0 22px 40px rgba(9,26,36,0.4); }
.hub-card.adc { --hub-accent: #78d4b0; --hub-accent-rgb: 120,212,176; }
.hub-card.io { --hub-accent: #8ad2ff; --hub-accent-rgb: 138,210,255; }
.hub-card.checkpoint { --hub-accent: #9fc3ff; --hub-accent-rgb: 159,195,255; }
.hub-card::before { content: ""; position: absolute; inset: -50% -10% auto -10%; height: 70%; background: radial-gradient(circle at top, rgba(120,200,214,0.22), transparent 70%); opacity: 1; }
.hub-card::after { content: ""; position: absolute; inset: 0; border-radius: 26px; border: 1px solid rgba(122,196,210,0.28); pointer-events: none; background-image: none; }
.hub-media { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px; }
.hub-icon { width: 56px; height: 56px; border-radius: 16px; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; background: rgba(255,255,255,0.12); border: 1px solid rgba(122,196,210,0.45); color: #dff6fb; box-shadow: inset 0 0 10px rgba(120,200,214,0.2); }
.hub-logo { font-size: 20px; font-weight: 800; letter-spacing: 0.6px; color: #e7f7fb; text-transform: uppercase; }
.hub-divider { height: 1px; width: 100%; margin: 6px 0 2px 0; background: rgba(255,255,255,0.08); }
.hub-title { margin-top: 10px; font-size: 20px; font-weight: 700; color: #f1fbfe; letter-spacing: -0.2px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.hub-line { margin-top: 6px; font-size: 12px; font-weight: 700; color: rgba(220,242,248,0.7); text-transform: uppercase; letter-spacing: 0.8px; }
.hub-desc { margin-top: 10px; font-size: 13px; color: rgba(232,248,252,0.9); line-height: 1.6; }
.hub-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 8px; margin-top: 14px; }
.hub-metric { padding: 6px; border-radius: 10px; background: rgba(255,255,255,0.92); border: 1px solid rgba(122,196,210,0.5); text-align: center; }
.hub-metric-value { font-size: 14px; font-weight: 600; color: #1b2f3d; line-height: 1; }
.hub-metric-value.loading { color: transparent; background: linear-gradient(90deg, rgba(15,23,42,0.18), rgba(15,23,42,0.55), rgba(15,23,42,0.18)); background-size: 200% 100%; background-clip: text; -webkit-background-clip: text; animation: metricShimmer 1.6s linear infinite; }
.hub-metric-label { margin-top: 4px; font-size: 9px; font-weight: 700; color: rgba(55,74,92,0.7); text-transform: uppercase; letter-spacing: 0.3px; }
.hub-cta { margin-top: 14px; display: inline-flex; align-items: center; justify-content: center; padding: 8px 18px; border-radius: 999px; border: 1px solid rgba(215,242,248,0.9); color: #f4fbfe; background: rgba(12,40,54,0.55); font-size: 12px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; box-shadow: 0 6px 14px rgba(9,26,36,0.35); transition: all 0.2s ease; }
.hub-card:hover .hub-cta { background: rgba(12,40,54,0.7); box-shadow: 0 8px 18px rgba(9,26,36,0.4); transform: translateY(-1px); }
.hub-card .hub-cta { border-color: rgba(215,242,248,0.9); }
.hub-card .hub-cta { color: #f4fbfe; }
.nav-tabs.hidden { display: none; }
.hub-only { display: none; }
.hub-banner { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px; border-radius: 10px; background: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(30,64,175,0.08)); border: 1px solid rgba(94,234,212,0.4); margin-bottom: 14px; font-size: 12px; font-weight: 700; color: #0f172a; }
.hub-banner-btn { padding: 6px 10px; border-radius: 999px; border: 1px solid #93c5fd; background: #eff6ff; color: #1e3a8a; font-size: 11px; font-weight: 700; cursor: pointer; }
.hub-dashboard { display: none; padding: 24px 0; }
.hub-dashboard.active { display: block; }
.hub-dashboard-title { font-size: 22px; font-weight: 800; color: #0f172a; margin-bottom: 20px; letter-spacing: -0.3px; }
.hub-dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
.hub-stat-card { padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #f0f4ff 100%); border-radius: 14px; border: 2px solid #bfdbfe; box-shadow: 0 3px 12px rgba(30, 58, 138, 0.1); transition: all 0.3s ease; }
.hub-stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(30, 58, 138, 0.15); border-color: #93c5fd; }
.hub-stat-value { font-size: 32px; font-weight: 800; color: #1e3a8a; line-height: 1; margin-bottom: 8px; }
.hub-stat-label { font-size: 13px; color: #475569; font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; }
.hub-news-section { margin-top: 32px; }
.hub-news-title { font-size: 18px; font-weight: 800; color: #0f172a; margin-bottom: 16px; letter-spacing: -0.2px; }
.hub-news-list { display: grid; gap: 12px; }
.hub-news-item { padding: 14px 16px; background: linear-gradient(135deg, #fef3c7 0%, #fef08a 100%); border-radius: 10px; border-left: 4px solid #f59e0b; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1); }
.hub-news-item-title { font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 4px; }
.hub-news-item-date { font-size: 11px; color: #b45309; font-weight: 500; }
.site-footer { margin-top: auto; padding: 16px 20px; background: linear-gradient(135deg, #1f445a 0%, #1c3d52 55%, #19384b 100%); color: #ffffff; text-align: center; font-size: 13px; font-weight: 700; letter-spacing: 0.4px; width: 100%; }
.site-footer a { color: #ffffff; text-decoration: none; }
.site-footer a:hover { text-decoration: underline; }
@keyframes hubReveal { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes metricShimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
@keyframes welcomeRise { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

@media (max-width: 1024px) {
  .hero-bg { opacity: 0.5; }
}
@media (prefers-reduced-motion: reduce) {
  .hub-metric-value.loading { animation: none; }
}

/* ============================= */
/* DKLINITY ENTERPRISE THEME v1.0 */
/* ============================= */

:root {
  /* Brand Colors */
  --primary-navy: #0B1F2E;
  --clinical-blue: #1E3A8A;
  --innovation-teal: #0E5C63;
  --oncology-green: #4CAF50;
  --slate: #64748B;
  --bg-light: #F2F5F8;
  --bg-section: #F8FAFC;
  --border-light: #E2E8F0;
  --text-dark: #0F172A;
  --text-light: #FFFFFF;
}

/* ============================= */
/* ANIMATED WELCOME MESSAGE */
/* ============================= */

.welcome-text {
  font-size: 52px;
  font-weight: 700;
  background: linear-gradient(90deg, #FFFFFF, #4CAF50, #FFFFFF);
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: floatWelcome 6s ease-in-out infinite, gradientShift 8s linear infinite, glowPulse 4s ease-in-out infinite;
  margin: 0;
}

@keyframes floatWelcome {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0px); }
}

@keyframes gradientShift {
  from { background-position: 0% center; }
  to { background-position: 200% center; }
}

@keyframes glowPulse {
  0%, 100% { text-shadow: 0 0 10px rgba(76,175,80,0.4); }
  50% { text-shadow: 0 0 25px rgba(76,175,80,0.7); }
}

/* ============================= */
/* DNA HELIX ANIMATION */
/* ============================= */

.dna-container {
  position: absolute;
  right: 5%;
  top: 50%;
  transform: translateY(-50%);
  width: 220px;
  height: 400px;
  perspective: 1000px;
  opacity: 0.15;
  pointer-events: none;
}

.dna-helix {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(30, 58, 138, 0.3));
  border-radius: 50%;
  animation: rotateDNA 20s linear infinite;
  box-shadow: 0 0 60px rgba(76, 175, 80, 0.15);
}

@keyframes rotateDNA {
  from { transform: rotateY(0deg) rotateX(45deg); }
  to { transform: rotateY(360deg) rotateX(45deg); }
}

/* ============================= */
/* ANIMATED CI VISUAL - DNA HELIX WITH ICONS */
/* ============================= */

.ci-visual {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: visible !important;
  background: none !important;
}

.ci-helix-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* DNA SVG Styling */
.dna-svg {
  width: 200px;
  height: 400px;
  filter: drop-shadow(0 0 30px rgba(76, 175, 80, 0.4));
  animation: dnaRotate 8s linear infinite;
}

@keyframes dnaRotate {
  from { transform: rotateZ(0deg); }
  to { transform: rotateZ(360deg); }
}

.dna-strand {
  stroke-linecap: round;
  filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.5));
  animation: strandGlow 3s ease-in-out infinite;
}

@keyframes strandGlow {
  0%, 100% { filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.5)); }
  50% { filter: drop-shadow(0 0 16px rgba(30, 58, 138, 0.8)); }
}

.dna-rungs {
  animation: rungsFlash 2s ease-in-out infinite;
}

@keyframes rungsFlash {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.dna-glow {
  animation: glowPulse 2.5s ease-in-out infinite;
}

@keyframes glowPulse {
  0%, 100% { r: 60px; opacity: 0.2; }
  50% { r: 90px; opacity: 0.5; }
}

/* CI Rings Container */
.ci-rings-container {
  position: absolute;
  width: 500px;
  height: 500px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

/* Individual CI Rings */
.ci-ring {
  position: absolute;
  width: 90px;
  height: 90px;
  border: 2px solid rgba(76, 175, 80, 0.6);
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(11, 31, 46, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
  animation: ringFloat 4s ease-in-out infinite;
  transition: all 0.3s ease;
}

.ci-ring:hover {
  border-color: rgba(76, 175, 80, 1);
  box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
}

@keyframes ringFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-15px); }
}

/* Ring Positions */
.ring-1 {
  top: -40px;
  left: 50%;
  transform: translateX(-50%);
  animation: ringFloat 4s ease-in-out infinite, ring1Pulse 3s ease-in-out infinite;
}

.ring-2 {
  top: 50%;
  right: -40px;
  transform: translateY(-50%);
  animation: ringFloat 4s ease-in-out infinite 0.5s, ring2Pulse 3s ease-in-out infinite 0.5s;
}

.ring-3 {
  bottom: -40px;
  left: 50%;
  transform: translateX(-50%);
  animation: ringFloat 4s ease-in-out infinite 1s, ring3Pulse 3s ease-in-out infinite 1s;
}

.ring-4 {
  top: 50%;
  left: -40px;
  transform: translateY(-50%);
  animation: ringFloat 4s ease-in-out infinite 1.5s, ring4Pulse 3s ease-in-out infinite 1.5s;
}

@keyframes ring1Pulse { 0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); } 50% { box-shadow: 0 0 40px rgba(76, 175, 80, 0.6); } }
@keyframes ring2Pulse { 0%, 100% { box-shadow: 0 0 20px rgba(30, 58, 138, 0.3); } 50% { box-shadow: 0 0 40px rgba(30, 58, 138, 0.6); } }
@keyframes ring3Pulse { 0%, 100% { box-shadow: 0 0 20px rgba(14, 92, 99, 0.3); } 50% { box-shadow: 0 0 40px rgba(14, 92, 99, 0.6); } }
@keyframes ring4Pulse { 0%, 100% { box-shadow: 0 0 20px rgba(199, 210, 254, 0.3); } 50% { box-shadow: 0 0 40px rgba(199, 210, 254, 0.6); } }

.ci-ring-icon {
  font-size: 32px;
  margin-bottom: 4px;
  animation: iconBounce 2s ease-in-out infinite;
}

.ci-ring-label {
  font-size: 10px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.9);
  text-align: center;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

@keyframes iconBounce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* Modality Badges */
.ci-modalities {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  gap: 8px;
  z-index: 10;
  animation: modalitiesReveal 1s ease forwards;
}

@keyframes modalitiesReveal {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

.modality-badge {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 12px;
  color: white;
  border: 2px solid white;
  box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
  animation: badgeSpin 6s linear infinite;
}

.modality-badge.io {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  animation-delay: 0s;
}

.modality-badge.adc {
  background: linear-gradient(135deg, #1E3A8A, #1e2c5a);
  animation-delay: 2s;
}

.modality-badge.cp {
  background: linear-gradient(135deg, #0E5C63, #0a3d45);
  animation-delay: 4s;
}

@keyframes badgeSpin {
  from { transform: rotate(0deg) translateX(0px); }
  50% { transform: rotate(180deg) translateX(40px); }
  to { transform: rotate(360deg) translateX(0px); }
}

/* ============================= */
/* CARD SYSTEM - PREMIUM */
/* ============================= */

.card {
  background: linear-gradient(135deg, #ffffff 0%, #f4f8ff 100%), var(--portable-bg-photo), var(--portable-bg-texture);
  border-radius: 16px;
  padding: 28px;
  border: 1px solid var(--border-light);
  box-shadow: 0 6px 20px rgba(15, 23, 42, 0.05);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: 0 14px 35px rgba(15, 23, 42, 0.08);
}

.card.core { border-left: 4px solid var(--clinical-blue); }
.card.adc { border-left: 4px solid var(--innovation-teal); }
.card.checkpoint { border-left: 4px solid var(--oncology-green); }

/* ============================= */
/* HUB CARD FLOAT ANIMATION */
/* ============================= */

.hub-card {
  animation: floatCard 6s ease-in-out infinite;
}

@keyframes floatCard {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0px); }
}

/* ============================= */
/* SCROLL REVEAL SECTIONS */
/* ============================= */

.reveal {
  opacity: 0;
  transform: translateY(40px);
  transition: all 0.8s ease;
}

.reveal.active {
  opacity: 1;
  transform: translateY(0);
}

/* ============================= */
/* DASHBOARD DARK THEME */
/* ============================= */

.dashboard {
  background: #0F172A;
  color: white;
  min-height: 100vh;
}

.dashboard-card {
  background: var(--portable-bg-photo), var(--portable-bg-texture);
  border-radius: 14px;
  padding: 24px;
  border: 1px solid #334155;
  transition: 0.3s ease;
}

.dashboard-card:hover {
  box-shadow: 0 0 20px rgba(76, 175, 80, 0.25);
  border-color: rgba(76, 175, 80, 0.3);
}

.dashboard-number {
  font-size: 44px;
  font-weight: 700;
  color: var(--oncology-green);
}

/* ============================= */
/* ADMIN LAYOUT SYSTEM */
/* ============================= */

.admin-layout {
  display: flex;
  min-height: 100vh;
  background: #0F172A;
  color: white;
}

.admin-sidebar {
  width: 250px;
  background: #111827;
  padding: 30px 20px;
  border-right: 1px solid #1E293B;
  overflow-y: auto;
}

.admin-sidebar a {
  display: block;
  padding: 12px 16px;
  color: #94A3B8;
  text-decoration: none;
  border-radius: 8px;
  margin-bottom: 8px;
  transition: 0.3s ease;
  font-weight: 500;
}

.admin-sidebar a:hover {
  background: #1E293B;
  color: var(--oncology-green);
}

.admin-content {
  flex: 1;
  padding: 40px;
  overflow-y: auto;
}

.admin-card {
  background: var(--portable-bg-photo), var(--portable-bg-texture);
  padding: 24px;
  border-radius: 14px;
  border: 1px solid #334155;
  transition: 0.3s ease;
  margin-bottom: 20px;
}

.admin-card:hover {
  box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
  border-color: rgba(76, 175, 80, 0.3);
}

.admin-card h3 {
  margin: 0 0 16px 0;
  color: white;
  font-size: 18px;
}

/* ============================= */
/* BUTTON SYSTEM - ENTERPRISE */
/* ============================= */

.btn-primary {
  background: var(--oncology-green);
  color: white;
  border-radius: 30px;
  padding: 12px 28px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s ease;
  font-size: 14px;
}

.btn-primary:hover {
  background: #3E9443;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.3);
}

.btn-primary:active {
  transform: scale(0.95);
}

/* ============================= */
/* SECTION BACKGROUNDS */
/* ============================= */

.section-light {
  background: var(--bg-section);
}

.section-muted {
  background: #EEF2F7;
}

.section-dark {
  background: var(--primary-navy);
  color: white;
}

/* ============================= */
/* DATA PARTICLES BACKGROUND */
/* ============================= */

.hub-section {
  position: relative;
  overflow: hidden;
}

.hub-bg {
  position: absolute;
  width: 200%;
  height: 200%;
  top: 0;
  left: 0;
  background-image: radial-gradient(circle, rgba(14,92,99,0.15) 1px, transparent 1px);
  background-size: 50px 50px;
  animation: moveData 40s linear infinite;
  opacity: 0.2;
  pointer-events: none;
  z-index: 0;
}

@keyframes moveData {
  from { transform: translate(0,0); }
  to { transform: translate(-300px,-300px); }
}

/* ============================= */
/* GLASS MORPHISM EFFECT */
/* ============================= */

.glass {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(14px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
}

/* ============================= */
/* PARTICLE ANIMATION */
/* ============================= */

.particles {
  position: absolute;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.particle {
  position: absolute;
  background: rgba(76, 175, 80, 0.1);
  border-radius: 50%;
  animation: float 20s infinite ease-in-out;
}

@keyframes float {
  0%, 100% { transform: translateY(0px) translateX(0px); }
  50% { transform: translateY(-30px) translateX(20px); }
}

</style>
</head>
<body>

<div class="container" style="margin-top: 60px;">
  <div class="header home-mode" id="mainHeader" style="background: rgba(255,255,255,0.95); padding: 12px 40px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; border: none; border-radius: 0; margin: 0; box-shadow: 0 2px 12px rgba(15, 60, 93, 0.1); transition: all 0.3s;">
    <!-- Left: Logo -->
    <div class="header-left">
      <img src="https://image2url.com/r2/default/images/1771264407799-886609b6-8b7c-42fc-b8be-5d8aeb0b6a2e.png" alt="Dklinity Logo" class="header-logo" />
      <div class="header-brand-text home-brand hub-home-only">Dklinity-OneCIâ„¢</div>
    </div>
    
    <!-- Center: Tabs (hub mode) or Marketing Nav (home) -->
    <div class="header-center">
      <div class="nav-tabs hidden">
        <div class="nav-tab back" onclick="exitHubToCards()">â† Back</div>
        <div class="nav-tab active" onclick="switchTab(event, 'dashboard')">ðŸ“Š Dashboard</div>
        <div class="nav-tab" onclick="switchTab(event, 'drugs')">ðŸ’Š Drugs</div>
        <div class="nav-tab" onclick="switchTab(event, 'trials')">ðŸ§ª Trials</div>
        <div class="nav-tab" onclick="switchTab(event, 'companies')">ðŸ¢ Companies</div>
        <div class="nav-tab" id="navImportTab" onclick="switchTab(event, 'import')">ðŸ“¤ Import/Export</div>
      </div>
    </div>
    
    <!-- Right: Brand Name -->
    <div class="header-right">
      <div class="hub-home-only header-nav-marketing">
        <a href="DKLinITY-Database3.html#top" style="color: #1e3a8a; font-weight: 600; font-size: 14px; text-decoration: none;">Home</a>
        <a href="ai-edge.html" style="color: #1e3a8a; font-weight: 600; font-size: 14px; text-decoration: none;">The AI Edge</a>
        <a href="request-demo.html" style="color: #1e3a8a; font-weight: 600; font-size: 14px; text-decoration: none;">Subscription</a>
        <a href="resources.html" style="color: #1e3a8a; font-weight: 600; font-size: 14px; text-decoration: none;">Resources</a>
        <a href="contact.html" style="color: #1e3a8a; font-weight: 600; font-size: 14px; text-decoration: none;">Contact Us</a>
        <a href="legal.html" style="color: #1e3a8a; font-weight: 600; font-size: 14px; text-decoration: none;">Legal</a>
        <button onclick="window.location.href='request-demo.html'" style="background: #0f3d5c; color: white; border: none; border-radius: 20px; padding: 8px 20px; font-weight: 700; font-size: 14px; cursor: pointer;">Sign Up</button>
      </div>
      <div class="header-brand-text hub-brand hub-only">Dklinity-OneCIâ„¢</div>
      <div class="user-session" id="userSessionBox">
        <div class="user-pill" id="userSessionName">User</div>
        <div class="user-role" id="userSessionRole">user</div>
        <button class="btn btn-secondary btn-sm" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </div>

  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <div class="login-title">Dklinity-OneCI Login</div>
      <div class="login-sub">Sign in to access hub data.</div>
      <div id="loginError" class="login-error"></div>
      <div class="login-field">
        <label for="loginUsername">Username</label>
        <input id="loginUsername" type="text" placeholder="Enter username" />
      </div>
      <div class="login-field">
        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="Enter password" />
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Sign in</button>
    </div>
  </div>

  <!-- Dashboard Tab -->
  <div id="dashboard" class="tab-content active" style="padding-top: 24px;">
    <div class="hub-only" style="margin-bottom: 30px; padding: 20px 20px; background: linear-gradient(135deg, rgba(14, 80, 120, 0.15) 0%, rgba(30, 90, 117, 0.1) 100%); border: 1px solid rgba(30, 117, 162, 0.4); border-radius: 14px;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <div style="padding: 16px; background: rgba(255,255,255,0.9); border-radius: 10px; text-align: center; border: 1px solid rgba(14, 80, 120, 0.2);">
          <div style="font-size: 28px; font-weight: 800; color: #0f3d5c;" id="dashDrugsCount">-</div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px; font-weight: 600;">Total Drugs</div>
        </div>
        <div style="padding: 16px; background: rgba(255,255,255,0.9); border-radius: 10px; text-align: center; border: 1px solid rgba(14, 80, 120, 0.2);">
          <div style="font-size: 28px; font-weight: 800; color: #0f3d5c;" id="dashTrialsCount">-</div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px; font-weight: 600;">Total Trials</div>
        </div>
        <div style="padding: 16px; background: rgba(255,255,255,0.9); border-radius: 10px; text-align: center; border: 1px solid rgba(14, 80, 120, 0.2);">
          <div style="font-size: 28px; font-weight: 800; color: #0f3d5c;" id="dashCompaniesCount">-</div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px; font-weight: 600;">Total Companies</div>
        </div>
      </div>
      <div>
        <h3 style="font-size: 14px; font-weight: 800; color: #0f3d5c; margin: 0 0 12px 0;">ðŸ“‹ Top Regulatory News</h3>
        <div id="dashRegulatoryNews" style="display: grid; gap: 10px;">
          <div style="padding: 12px; background: rgba(255, 243, 224, 0.8); border-left: 4px solid #f59e0b; border-radius: 6px;">
            <div style="font-size: 12px; font-weight: 600; color: #92400e;">No regulatory news available</div>
            <div style="font-size: 11px; color: #b45309; margin-top: 2px;">Import data to see updates</div>
          </div>
        </div>
      </div>
    </div>
    <div class="hub-home-only">
      <section class="landing-hero reveal" id="top">
        <div class="dna-container">
          <div class="dna-helix"></div>
        </div>
        <div class="landing-hero-copy">
          <h1 class="landing-hero-title welcome-text">Welcome to <strong>Dklinity OneCIâ„¢</strong></h1>
          <div class="landing-hero-sub">Powering Oncology Decisions with Connected Intelligence</div>
          <div class="landing-hero-subtitle">
            Dklinity OneCI integrates clinical trials, drug pipelines, and company landscapes into a single AI-ready ecosystem.
            <br/><br/>
            Track developments across IO, ADCs, and Checkpoint therapies, with deep visibility into regulatory progress and scientific conferences.
          </div>
          <div class="landing-hero-cta">
            <button class="landing-btn ghost">ðŸ”µ Know More</button>
            <button class="landing-btn primary" onclick="window.location.href='request-demo.html'">ðŸŸ¢ Request Demo</button>
          </div>
        </div>
        <div class="landing-hero-visual ci-visual">
          <!-- Animated DNA Helix with CI Icons -->
          <div class="ci-helix-wrapper">
            <!-- Central DNA Helix -->
            <svg class="dna-svg" viewBox="0 0 200 400" preserveAspectRatio="xMidYMid meet">
              <defs>
                <linearGradient id="dnaGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#1E3A8A;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#0E5C63;stop-opacity:1" />
                </linearGradient>
              </defs>
              <!-- Left helix strand -->
              <path d="M 80 20 Q 60 80 80 140 Q 100 160 120 180 Q 140 200 120 260 Q 100 300 80 360" stroke="url(#dnaGradient)" stroke-width="3" fill="none" class="dna-strand" />
              <!-- Right helix strand -->
              <path d="M 120 20 Q 140 80 120 140 Q 100 160 80 180 Q 60 200 80 260 Q 100 300 120 360" stroke="url(#dnaGradient)" stroke-width="3" fill="none" class="dna-strand" />
              <!-- Connecting rungs -->
              <g class="dna-rungs" opacity="0.7">
                <line x1="80" y1="40" x2="120" y2="40" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="75" y1="80" x2="125" y2="80" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="80" y1="120" x2="120" y2="120" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="90" y1="160" x2="110" y2="160" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="80" y1="200" x2="120" y2="200" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="75" y1="240" x2="125" y2="240" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="80" y1="280" x2="120" y2="280" stroke="url(#dnaGradient)" stroke-width="2" />
                <line x1="85" y1="320" x2="115" y2="320" stroke="url(#dnaGradient)" stroke-width="2" />
              </g>
              <!-- Glow effect -->
              <circle cx="100" cy="200" r="80" fill="none" stroke="url(#dnaGradient)" stroke-width="0.5" opacity="0.3" class="dna-glow" />
            </svg>

            <!-- CI-Related Floating Rings with Icons -->
            <div class="ci-rings-container">
              <!-- Top Left: Clinical Trials -->
              <div class="ci-ring ring-1">
                <div class="ci-ring-icon">ðŸ“‹</div>
                <div class="ci-ring-label">Clinical Trials</div>
              </div>
              
              <!-- Top Right: Drug Pipelines -->
              <div class="ci-ring ring-2">
                <div class="ci-ring-icon">ðŸ’Š</div>
                <div class="ci-ring-label">Drug Pipelines</div>
              </div>
              
              <!-- Bottom Left: Company Intelligence -->
              <div class="ci-ring ring-3">
                <div class="ci-ring-icon">ðŸ¢</div>
                <div class="ci-ring-label">Intelligence</div>
              </div>
              
              <!-- Bottom Right: Regulatory Data -->
              <div class="ci-ring ring-4">
                <div class="ci-ring-icon">ðŸ“Š</div>
                <div class="ci-ring-label">Regulatory</div>
              </div>

              <!-- Center: Modality Icons -->
              <div class="ci-modalities">
                <div class="modality-badge io">IO</div>
                <div class="modality-badge adc">ADC</div>
                <div class="modality-badge cp">CP</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="landing-section reveal" id="platform">
        <div class="landing-section-sub">Dklinity - OneCI</div>
        <h2 class="landing-section-title">Your Trusted Clinical Intelligence Platform</h2>
        <div class="landing-card-text">
          Dklinity OneCI is the Clinical Intelligence Operating System â€” connecting structured data on global clinical trials,
          drug pipelines, company portfolios, and modalities like ADCs, checkpoint inhibitors, and IO.
          With OneCIâ„¢, teams in R&D, CI, BD, and strategy move faster with confidence.
        </div>
      </section>


      <section class="landing-section reveal" id="hubs" style="background: linear-gradient(135deg, rgba(15, 61, 92, 0.55) 0%, rgba(15, 61, 92, 0.4) 100%), var(--portable-bg-photo), var(--portable-bg-texture); border: 1px solid rgba(30, 90, 150, 0.3); position: relative; overflow: hidden;">
        <div style="position: absolute; inset: 0; background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.25), transparent 55%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.2), transparent 55%); pointer-events: none;"></div>
        <div style="position: relative; z-index: 1;">
          <div class="landing-section-sub">Platform Modules / Hubs</div>
          <h2 class="landing-section-title" style="color: #ffffff; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">Our Dklinity Intelligence Hubs</h2>
          <p style="color: #ffffff; text-align: center; font-size: 14px; margin-bottom: 32px; line-height: 1.8; text-shadow: 0 1px 4px rgba(0,0,0,0.2);">Dklinity OneCI delivers unified, oncology-focused clinical intelligence through specialized hubs designed for deep pipeline visibility, competitive intelligence, regulatory tracking, and scientific conference across global drug development programs.</p>
          <div class="landing-grid">
          <div class="landing-hub-card">
            <div class="landing-hub-title">Dklinity IO â€” Core Intelligence</div>
            <div class="landing-hub-list">
              <div>Drugs, Trials, Companies</div>
              <div>Global oncology focus</div>
              <div>Structured data pipelines</div>
            </div>
            <div class="landing-pill">Status: Live</div>
            <button class="landing-hub-cta" onclick="enterHub('IO')">Explore IO</button>
          </div>
          <div class="landing-hub-card">
            <div class="landing-hub-title">Dklinity ADC Hub</div>
            <div class="landing-hub-list">
              <div>ADC modalities, linkers, payloads</div>
              <div>Target & tumor intelligence</div>
              <div>Clinical outcomes</div>
            </div>
            <div class="landing-pill">Status: Live</div>
            <button class="landing-hub-cta" onclick="enterHub('ADC')">Explore ADC</button>
          </div>
          <div class="landing-hub-card">
            <div class="landing-hub-title">Dklinity Checkpoint Hub</div>
            <div class="landing-hub-list">
              <div>Checkpoint inhibitors</div>
              <div>Combination strategies</div>
              <div>IO landscape overview</div>
            </div>
            <div class="landing-pill">Status: Coming Soon</div>
            <button class="landing-hub-cta" onclick="window.location.href='request-demo.html'">Notify Me</button>
          </div>
        </div>
      </section>

      <section class="landing-section use-cases-section" id="use-cases">
        <div class="landing-section-sub">Use Cases</div>
        <h2 class="landing-section-title">Who Uses OneCI?</h2>
        <div class="use-cases-grid">
          <div class="use-case-card">
            <div class="use-case-title">ðŸ§¬ Pharma & Biotech</div>
            <div class="use-case-sub">Pipeline strategy & asset positioning</div>
            <div class="use-case-text">Track competitors, MoA trends, and indication expansion</div>
            <a class="use-case-cta" href="pharma.html">Explore</a>
          </div>
          <div class="use-case-card">
            <div class="use-case-title">ðŸ§ª CROs & Research Teams</div>
            <div class="use-case-sub">Trial design & endpoint intelligence</div>
            <div class="use-case-text">Cohort mapping, comparator tracking, inclusion/exclusion insights</div>
            <a class="use-case-cta" href="cros.html">Explore</a>
          </div>
          <div class="use-case-card">
            <div class="use-case-title">ðŸ“Š Business Development</div>
            <div class="use-case-sub">Partnering & deal intelligence</div>
            <div class="use-case-text">White-space analysis, licensing signals, asset benchmarking</div>
            <a class="use-case-cta" href="bd.html">Explore</a>
          </div>
          <div class="use-case-card">
            <div class="use-case-title">ðŸ§  Consultants</div>
            <div class="use-case-sub">Fast, defensible market intelligence</div>
            <div class="use-case-text">Landscape builds, competitive narratives, pitch-ready outputs</div>
            <a class="use-case-cta" href="consultants.html">Explore</a>
          </div>
          <div class="use-case-card">
            <div class="use-case-title">ðŸ©º Medical Affairs</div>
            <div class="use-case-sub">Evidence & congress intelligence</div>
            <div class="use-case-text">Publication tracking, conference abstracts, safety & efficacy trends</div>
            <a class="use-case-cta" href="medical.html">Explore</a>
          </div>
        </div>
      </section>

      <section class="landing-section reveal" id="coverage" style="background: linear-gradient(135deg, rgba(30, 90, 117, 0.1) 0%, rgba(79, 70, 229, 0.08) 100%), var(--portable-bg-photo), var(--portable-bg-texture); border: 1px solid rgba(30, 90, 150, 0.3); position: relative; overflow: hidden;">
        <div class="landing-section-sub">Data Scale & Coverage</div>
        <h2 class="landing-section-title">Trusted Data You Can Count On</h2>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">20,000+</div><div class="stat-label">Clinical Trials</div></div>
          <div class="stat-card"><div class="stat-value">10,000+</div><div class="stat-label">Drugs & Assets</div></div>
          <div class="stat-card"><div class="stat-value">5,000+</div><div class="stat-label">Companies</div></div>
          <div class="stat-card"><div class="stat-value">ADCs Â· IO Â· Checkpoints</div><div class="stat-label">Modalities</div></div>
        </div>
      </section>

      <section class="landing-section reveal" id="request-demo">
        <div class="landing-section-sub">Request Demo</div>
        <h2 class="landing-section-title">See OneCI in Action</h2>
        <div class="landing-card-text">Tailored demo with pricing, use case mapping, and API walkthrough.</div>
        <form action="mailto:dklinity@gmail.com" method="post" enctype="text/plain">
          <div class="request-form" style="margin-top:14px">
            <input name="Full Name" type="text" placeholder="Full Name" required />
            <input name="Email" type="email" placeholder="Email" required />
            <input name="Company" type="text" placeholder="Company" required />
            <input name="Role" type="text" placeholder="Role" required />
            <select name="Interest" required>
              <option value="">Interest (Data / API / Platform)</option>
              <option>Platform</option>
              <option>API</option>
              <option>Data</option>
            </select>
            <textarea name="Message" placeholder="Message (Optional)"></textarea>
          </div>
          <div style="margin-top:12px">
            <button class="landing-btn primary" type="submit">Request Demo</button>
          </div>
        </form>
      </section>

      <section class="landing-section reveal" id="about">
        <div class="landing-section-sub">About</div>
        <h2 class="landing-section-title">Advancing Next-Generation Clinical Research Through AI-Driven Trials and Real-Time Competitive Intelligence</h2>
        <div class="landing-card-text">Dklinity is an AI-powered clinical intelligence platform advancing next-generation oncology research. We integrate real-time trial data, drug pipelines, and competitive insights to accelerate smarter decision-making across the clinical ecosystem.</div>
        <div class="landing-card-text" style="margin-top: 12px;">Focused on precision science and patient impact, Dklinity bridges innovation with integrity, transforming data into actionable intelligence.</div>
        <div class="landing-card-text" style="margin-top: 12px; font-weight: 700;">Where science meets humanity.</div>
        <div class="landing-card-text" style="margin-top: 12px;">Website: <a href="https://www.dklinity.com" target="_blank" rel="noopener noreferrer" style="color: #ffffff; text-decoration: underline;">www.dklinity.com</a></div>
      </section>
    </div>

  </div>

  <!-- Drugs Tab -->
  <div id="drugs" class="tab-content">
    <div class="section-header-row">
      <h2 class="section-title">ðŸ’Š Drugs</h2>
      <div class="toolbar section-toolbar" style="align-items:center;">
        <div class="section-toolbar-group">
          <input id="drugSearch" class="search-box" placeholder="Search by name, synonyms, or ID..." oninput="refreshAllViews()" />
          <select id="drugFilterPhase" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Phases</option>
            <option>Discovery</option>
            <option>Preclinical</option>
            <option>IND</option>
            <option>Phase 1</option>
            <option>Phase 2</option>
            <option>Phase 3</option>
            <option>Phase 4</option>
            <option>Approved</option>
          </select>
          <select id="drugFilterSponsor" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Sponsors</option>
          </select>
          <select id="drugFilterStatus" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Status</option>
            <option>Active</option>
            <option>Inactive</option>
            <option>Approved</option>
          </select>
          <select id="drugFilterDevelopment" onchange="refreshAllViews()" style="display:none;padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Development Status</option>
          </select>
          <select id="drugFilterPayload" onchange="refreshAllViews()" style="display:none;padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Payloads</option>
          </select>
          <select id="drugFilterTarget" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Targets</option>
          </select>
          <select id="drugFilterTumor" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Tumors</option>
          </select>
        </div>
        <div>
          <button class="btn btn-secondary" onclick="clearDrugFilters()">Clear Filters</button>
        </div>
      </div>
    </div>
    <div id="drugsAlert"></div>
    <div class="table-wrapper">
      <table>
        <thead id="drugsTableHead">
          <tr>
            <th>ID</th>
            <th>Product Name</th>
            <th>MOA</th>
            <th>Phase</th>
            <th>Sponsor</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="drugsList"></tbody>
      </table>
    </div>
    <div id="drugsPagination"></div>
  </div>

  <!-- Trials Tab -->
  <div id="trials" class="tab-content">
    <div class="section-header-row">
      <h2 class="section-title">ðŸ§ª Trials</h2>
      <div class="toolbar section-toolbar" style="align-items:center;">
        <div class="section-toolbar-group">
          <input id="trialSearch" class="search-box" placeholder="Search trials by ID or title..." oninput="refreshAllViews()" />
          <select id="trialFilterCondition" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Conditions</option>
          </select>
          <select id="trialFilterPhase" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Phases</option>
            <option>Phase 1</option>
            <option>Phase 2</option>
            <option>Phase 3</option>
          </select>
          <select id="trialFilterSponsor" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Sponsors</option>
          </select>
          <select id="trialFilterCollaborator" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Collaborators</option>
          </select>
          <select id="trialFilterStatus" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Status</option>
            <option>Completed</option>
            <option>Unknown</option>
          </select>
          <select id="trialFilterTarget" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Targets</option>
          </select>
          <select id="trialFilterTumor" onchange="refreshAllViews()" style="padding:10px;border:2px solid #bfdbfe;border-radius:8px;background:white;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s">
            <option value="">All Tumors</option>
          </select>
        </div>
        <div>
          <button class="btn btn-secondary" onclick="clearTrialFilters()">Clear Filters</button>
        </div>
      </div>
    </div>
    <div id="trialsAlert"></div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Trial Identifier</th>
            <th>Indication</th>
            <th>Drug</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="trialsList"></tbody>
      </table>
    </div>
    <div id="trialsPagination"></div>
  </div>

  <!-- Companies Tab -->
  <div id="companies" class="tab-content">
    <div class="toolbar" style="margin-bottom:24px">
      <h2 style="margin: 0;color:#1e3a8a;font-size:26px;font-weight:800">ðŸ¢ Companies</h2>
      <button class="btn btn-primary" onclick="openCompanyModal()">+ Add Company</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Company Name</th>
            <th>Type</th>
            <th>Profile</th>
          </tr>
        </thead>
        <tbody id="companiesList"></tbody>
      </table>
    </div>
    <div id="companiesPagination"></div>
  </div>

  <!-- Mapping Tab -->
  <div id="mapping" class="tab-content">
    <h2 style="color:#1e3a8a;font-size:26px;font-weight:800">ðŸ”— Field Mapping Configuration</h2>
    <div style="background: linear-gradient(135deg, #eff6ff 0%, #f0f4ff 100%); padding: 18px; border-radius: 12px; margin-bottom: 16px; border: 2px solid #bfdbfe;">
      <p style="margin:0;color:#1e3a8a;font-weight:600">Hub-Specific Field Schemas</p>
      <p style="margin:6px 0 0 0;font-size:13px;color:#475569">Configure which fields are available for this hub. Current hub: <strong id="mappingHubName">IO</strong></p>
    </div>
    <div style="display:grid;gap:16px;">
      <div style="border:1px solid #e6eef8;border-radius:10px;padding:16px;background:#f8fafc;">
        <h3 style="margin:0 0 12px 0;font-size:16px;color:#1e3a8a">Drug Fields</h3>
        <div id="mappingDrugFields" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;max-height:300px;overflow-y:auto;"></div>
      </div>
      <div style="border:1px solid #e6eef8;border-radius:10px;padding:16px;background:#f8fafc;">
        <h3 style="margin:0 0 12px 0;font-size:16px;color:#1e3a8a">Trial Fields</h3>
        <div id="mappingTrialFields" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
    <div style="margin-top:20px;padding:14px;background:#dbeafe;border-radius:8px;border-left:4px solid #1e3a8a;">
      <p style="margin:0;font-size:13px;color:#1e293b;font-weight:600">ðŸ’¡ Tip: The import/export will automatically use the fields configured for your current hub. Field mappings are automatically loaded when you select an Excel file.</p>
    </div>
  </div>

  <!-- Import/Export Tab -->
  <div id="import" class="tab-content">
    <h2 style="color:#1e3a8a;font-size:26px;font-weight:800">ðŸ“¤ Import / Export - <span id="importExportHubName">ADC</span> Hub</h2>
    
    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 18px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #3b82f6;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 32px;">\ud83d\udca1</span>
        <div>
          <div style="font-size: 18px; font-weight: 800; color: #1e40af; margin-bottom: 6px;">
            Current Hub: <span id="currentHubIndicator" style="color: #3b82f6;">${currentHub}</span>
          </div>
          <div style="font-size: 14px; color: #1e40af; line-height: 1.6;">
            Data will be imported to the hub specified in your Excel file's \"hub\" column, or to <strong><span id="defaultImportHub">${currentHub}</span></strong> if no hub column exists.
            <br/>Make sure you select the correct hub before importing, or include a \"hub\" column in your Excel file.
          </div>
        </div>
      </div>
    </div>

    <div style="background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%); padding: 18px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #c7d2fe;">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
        <div>
          <div style="font-size: 16px; font-weight: 800; color: #1e3a8a; margin-bottom: 4px;">Firestore Sync</div>
          <div style="font-size: 13px; color: #334155; line-height: 1.6;">
            Hub: <strong><span id="firebaseHubText">IO</span></strong> â€¢ Status: <strong><span id="firebaseStatusText">Not connected</span></strong>
            <br/>User: <span id="firebaseUserText">Not signed in</span>
          </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <button id="firebaseSignInBtn" class="btn btn-primary" onclick="signInWithGoogle()">Sign in with Google</button>
          <button id="firebaseSignOutBtn" class="btn btn-secondary" onclick="signOutFirebase()" style="display:none;">Sign out</button>
          <button id="firebaseSyncBtn" class="btn btn-success" onclick="forceFirestoreResync()" style="display:none;">Sync now</button>
        </div>
      </div>
    </div>
    
    <div id="adminUserPanel" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); padding: 18px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #fdba74; display: none;">
      <div style="font-size: 16px; font-weight: 800; color: #9a3412; margin-bottom: 6px;">Admin: User Management</div>
      <div style="font-size: 13px; color: #7c2d12; margin-bottom: 12px;">Create logins and assign hub access. Only admins can see this section.</div>
      <div class="form-grid" style="margin-bottom: 12px;">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="newUserName" placeholder="e.g., analyst1" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="newUserPassword" placeholder="Set password" />
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="newUserRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Hub Access</label>
          <select id="newUserHub">
            <option value="IO">IO</option>
            <option value="ADC">ADC</option>
            <option value="CHECKPOINT">CHECKPOINT</option>
            <option value="ALL">All Hubs</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 12px;">
        <button class="btn btn-primary" onclick="createUser()">Create User</button>
        <div id="userAdminMessage" style="font-size: 12px; color: #7c2d12;"></div>
      </div>
      <div id="userList" style="background: rgba(255,255,255,0.7); border-radius: 8px; padding: 10px; border: 1px solid #fed7aa;"></div>
    </div>
    
    <div style="background: linear-gradient(135deg, #eff6ff 0%, #f0f4ff 100%); padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #bfdbfe;">
      <h3 style="margin-top: 0;font-size:20px;font-weight:700;color:#1e293b">â¬†ï¸ Import Excel File (Current Hub Only)</h3>
      <p style="font-size:13px;color:#475569;margin:0 0 12px 0">Import data will be saved <strong>only</strong> to the <span id="importHubNameText">ADC</span> hub. Other hubs will not be affected.</p>
      <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; margin-bottom: 12px;">
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="padding:10px;border:2px solid #bfdbfe;border-radius:6px;font-size:14px" />
        <button class="btn btn-primary" onclick="handleExcelUpload()">Upload & Map</button>
        <button class="btn btn-secondary" onclick="document.getElementById('excelInput').value=''">Clear</button>
      </div>
      <div id="importStatus"></div>
    </div>

    <div id="mappingPreview"></div>

    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #f0fdf4 100%); padding: 24px; border-radius: 12px; border: 2px solid #86efac; margin-bottom: 24px;">
      <h3 style="margin-top: 0;font-size:20px;font-weight:700;color:#1e293b">ðŸ“° Import Regulatory News (All Hubs)</h3>
      <p style="font-size:13px;color:#475569;margin:0 0 12px 0">Import regulatory announcements from a separate Excel file. The file should contain columns: <strong>Title</strong>, <strong>Description</strong>, <strong>Company Logo</strong>, <strong>Source Link</strong>, <strong>Hub</strong>, and <strong>Date</strong>.</p>
      <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; margin-bottom: 12px;">
        <input type="file" id="newsExcelInput" accept=".xlsx,.xls" style="padding:10px;border:2px solid #86efac;border-radius:6px;font-size:14px" />
        <button class="btn btn-success" onclick="handleRegulatoryNewsUpload()" style="background:#22c55e;font-size:14px">Import News</button>
        <button class="btn btn-secondary" onclick="document.getElementById('newsExcelInput').value=''">Clear</button>
      </div>
      <div id="newsImportStatus"></div>
    </div>

    <div style="background: linear-gradient(135deg, #eff6ff 0%, #f0f4ff 100%); padding: 24px; border-radius: 12px; border: 2px solid #bfdbfe; margin-bottom: 24px;">
      <h3 style="margin-top: 0;font-size:20px;font-weight:700;color:#1e293b">â¬‡ï¸ Export Data (Current Hub Only)</h3>
      <p style="font-size:13px;color:#475569;margin:0 0 12px 0">Export will include <strong>only</strong> data from the <span id="exportHubNameText">ADC</span> hub.</p>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-success" onclick="exportToJSON()" style="background:#10b981;font-size:14px">Export as JSON</button>
        <button class="btn btn-success" onclick="exportToExcel()" style="background:#10b981;font-size:14px">Export as Excel</button>
      </div>
    </div>

    <div style="background: #fef2f2; padding: 24px; border-radius: 12px; border: 2px solid #ef4444; margin-top: 12px;">
      <h3 style="margin-top: 0; color: #991b1b;font-size:20px;font-weight:700">âš ï¸ Clear Data from Current Hub</h3>
      <p style="color: #7f1d1d; margin: 8px 0;font-size:14px;font-weight:500">Remove all companies, drugs, and trials from <strong><span id="clearHubNameText">ADC</span> hub only</strong>. Other hubs will not be affected. <strong>This cannot be undone.</strong></p>
      <button class="btn btn-danger" onclick="if(confirm(`Are you absolutely sure? All data in the ${currentHub} hub will be permanently deleted. Other hubs will not be affected.`)) clearHubData()" style="font-size:14px">Clear <span id="clearBtnHubName">ADC</span> Hub Data</button>
    </div>
  </div>

  <!-- Logs Tab -->
  <div id="logs" class="tab-content">
    <h2 style="color:#1e3a8a;font-size:26px;font-weight:800;margin-bottom:24px">ðŸ“‹ Activity Logs</h2>
    <button class="btn btn-danger btn-sm" onclick="clearAllLogs()" style="margin-bottom: 16px;font-size:14px">Clear Logs</button>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Action</th>
            <th>Entity Type</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="logsList"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Modals -->
<div id="drugDetailsModal" class="modal">
  <div class="modal-content fullpage">
    <div class="modal-header-bar">
      <button onclick="closeAllModals()">â† Back</button>
      <h2 id="drugDetailsTitle">Drug Details</h2>
    </div>
    <div class="modal-inner">
      <div id="drugDetailsContainer"></div>
    </div>
  </div>
</div>

<div id="trialDetailsModal" class="modal">
  <div class="modal-content fullpage">
    <div class="modal-header-bar">
      <button onclick="closeAllModals()">â† Back</button>
      <h2 id="trialDetailsTitle">Trial Details (Imported Rows)</h2>
    </div>
    <div class="modal-inner">
      <div id="trialDetailsContainer"></div>
    </div>
  </div>
</div>

<div id="companyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header-bar">
      <button onclick="closeAllModals()">â† Back</button>
      <h2 id="companyModalTitle">Company Details</h2>
    </div>
    <div class="modal-inner">
      <div id="companyFormContainer"></div>
    </div>
  </div>
</div>

<div id="companyDetailsModal" class="modal">
  <div class="modal-content fullpage">
    <div class="modal-header-bar">
      <button onclick="closeAllModals()">â† Back</button>
      <h2 id="companyDetailsTitle">Company Profile</h2>
    </div>
    <div class="modal-inner">
      <div id="companyDetailsContainer"></div>
    </div>
  </div>
</div>

<div id="regulatoryNewsModal" class="modal">
  <div class="modal-content fullpage">
    <div class="modal-header-bar">
      <button onclick="closeAllModals()">â† Back</button>
      <h2 id="regulatoryNewsModalTitle">Dklinity-OneCI | Regulatory Announcement</h2>
    </div>
    <div class="modal-inner" id="regulatoryNewsModalBody"></div>
  </div>
</div>

<script>
// ============ IndexedDB Setup ============
const DB_NAME = 'DKLinityDB2';
const DB_VERSION = 3;
let db;

// Pagination variables
let currentDrugPage = 1;
let currentTrialPage = 1;
let currentCompanyPage = 1;
let itemsPerPageDrug = 20;
let itemsPerPageTrial = 20;
const itemsPerPageCompany = 20;
let lastDrugFilterKey = '';
let lastTrialFilterKey = '';
let lastDrugTotalPages = 1;
let lastTrialTotalPages = 1;
let currentHub = 'IO';

const HUB_LABELS = {
  ADC: 'Dklinity ADC Connect',
  IO: 'Dklinity IO Connect',
  CHECKPOINT: 'Dklinity Checkpoint Connect'
};

const HUB_FILTER_DEFAULTS = {
  ADC: { phase: 'Phase 2', status: 'Active', condition: '', sponsor: '', drug: '' },
  IO: { phase: 'Phase 2', status: 'Active', condition: '', sponsor: '', drug: '' },
  CHECKPOINT: { phase: 'Phase 2', status: 'Active', condition: '', sponsor: '', drug: '' }
};

const FIREBASE_CONFIGS = {
  IO: {
    apiKey: "AIzaSyCfszeBhCuD1XA-to-eUxYSrgUT6Kf7Ito",
    authDomain: "dklinityio-8f482.firebaseapp.com",
    projectId: "dklinityio-8f482",
    storageBucket: "dklinityio-8f482.firebasestorage.app",
    messagingSenderId: "790841004494",
    appId: "1:790841004494:web:988c453d6f7effb14e9b9f",
    measurementId: "G-Z9JC398ELF"
  },
  ADC: {
    apiKey: "AIzaSyADobUYZ2nP3sTlOcQUL1qLbA6Qp07nnWU",
    authDomain: "dklinity-58744.firebaseapp.com",
    projectId: "dklinity-58744",
    storageBucket: "dklinity-58744.firebasestorage.app",
    messagingSenderId: "717125080157",
    appId: "1:717125080157:web:0cf46444bdb2a00234e9b4",
    measurementId: "G-QFGR85Q7TH"
  }
};

const FIRESTORE_COLLECTIONS = {
  companies: { store: 'companies', key: 'company_id' },
  drugs: { store: 'drugs', key: 'drug_id' },
  trials: { store: 'trials', key: 'trial_id' },
  regulatory_announcements: { store: 'regulatory_announcements', key: 'news_id' },
  users: { store: 'users', key: 'username' }
};

let firebaseState = {
  app: null,
  auth: null,
  db: null,
  hub: null,
  user: null,
  unsubscribers: []
};
let suppressFirestoreWrites = false;
let refreshTimer = null;
let currentUser = null;
let pendingHub = null;

function isFirestoreEnabledForHub(hub) {
  return !!FIREBASE_CONFIGS[hub];
}

function scheduleRefreshAllViews() {
  if (refreshTimer) clearTimeout(refreshTimer);
  refreshTimer = setTimeout(() => refreshAllViews(), 300);
}

function updateFirebaseStatusUI() {
  const hubEl = document.getElementById('firebaseHubText');
  const statusEl = document.getElementById('firebaseStatusText');
  const userEl = document.getElementById('firebaseUserText');
  const signInBtn = document.getElementById('firebaseSignInBtn');
  const signOutBtn = document.getElementById('firebaseSignOutBtn');
  const syncBtn = document.getElementById('firebaseSyncBtn');

  if (hubEl) hubEl.textContent = currentHub;

  if (!isFirestoreEnabledForHub(currentHub)) {
    if (statusEl) statusEl.textContent = 'Not configured';
    if (userEl) userEl.textContent = 'N/A';
    if (signInBtn) signInBtn.style.display = 'none';
    if (signOutBtn) signOutBtn.style.display = 'none';
    if (syncBtn) syncBtn.style.display = 'none';
    return;
  }

  const user = firebaseState.user;
  if (user) {
    if (statusEl) statusEl.textContent = user.isAnonymous ? 'Connected (anonymous)' : 'Connected';
    if (userEl) userEl.textContent = user.isAnonymous ? 'Anonymous' : (user.email || user.displayName || 'Signed in');
    if (signInBtn) signInBtn.style.display = 'none';
    if (signOutBtn) signOutBtn.style.display = 'none';
    if (syncBtn) syncBtn.style.display = 'inline-flex';
  } else {
    if (statusEl) statusEl.textContent = 'Connecting...';
    if (userEl) userEl.textContent = 'Initializing';
    if (signInBtn) signInBtn.style.display = 'none';
    if (signOutBtn) signOutBtn.style.display = 'none';
    if (syncBtn) syncBtn.style.display = 'none';
  }
}

function stopFirestoreSync(silent = false) {
  if (firebaseState.unsubscribers.length) {
    firebaseState.unsubscribers.forEach(unsub => { try { unsub(); } catch (e) {} });
    firebaseState.unsubscribers = [];
  }
  if (!silent) scheduleRefreshAllViews();
}

async function runWithFirestoreSuppressed(fn) {
  suppressFirestoreWrites = true;
  try {
    return await fn();
  } finally {
    suppressFirestoreWrites = false;
  }
}

function normalizeTrialIdentifier(value) {
  return (value || '').toString().trim().toUpperCase();
}

function buildTrialDocId(hub, trialIdentifier) {
  const normalized = normalizeTrialIdentifier(trialIdentifier);
  if (!normalized) return null;
  const safe = normalized.replace(/[\\/\s#?]+/g, '_');
  return `trials_${normalizeHub(hub)}__${safe}`;
}

function buildFirestoreDocId(storeName, id, data = null) {
  if (storeName === 'trials' && data && data.trial_identifier) {
    const trialDocId = buildTrialDocId(data.hub || currentHub, data.trial_identifier);
    if (trialDocId) return trialDocId;
  }
  return `${storeName}_${id}`;
}

function getFirestoreCollectionRef(storeName) {
  if (!firebaseState.db) return null;
  return firebaseState.db.collection(storeName);
}

async function syncRecordToFirestore(storeName, data, id) {
  if (!FIRESTORE_COLLECTIONS[storeName]) {
    console.warn('âš ï¸ Collection not configured:', storeName);
    return;
  }
  if (suppressFirestoreWrites) {
    console.log('â¸ï¸ Firestore writes suppressed (syncing):', storeName);
    return;
  }
  if (!firebaseState.db) {
    console.error('âŒ Firebase DB not initialized for:', storeName);
    return;
  }
  if (!firebaseState.user) {
    console.warn('âš ï¸ Firebase user not authenticated for:', storeName, '- will retry when authenticated');
    return;
  }
  
  try {
    const ref = getFirestoreCollectionRef(storeName);
    if (!ref) {
      console.error('âŒ Could not get collection ref:', storeName);
      return;
    }
    const keyField = FIRESTORE_COLLECTIONS[storeName]?.key;
    const payload = { ...data };
    if (keyField && payload[keyField] === undefined) payload[keyField] = id;
    payload.local_id = id;
    if (!payload.hub) payload.hub = currentHub;
    
    const docId = buildFirestoreDocId(storeName, id, payload);
    await ref.doc(docId).set(payload, { merge: true });
    if (storeName === 'trials') {
      const legacyDocId = `${storeName}_${id}`;
      if (legacyDocId !== docId) {
        await ref.doc(legacyDocId).delete();
      }
    }
    console.log('âœ… Synced to Firestore:', { storeName, docId, hub: currentHub });
  } catch (err) {
    console.error('âŒ Firestore sync error:', { storeName, id, error: err.code, message: err.message });
    if (err.code === 'permission-denied') {
      console.warn('âš ï¸ Firestore permission denied - check Firestore rules allow writes');
    } else if (err.code === 'unauthenticated') {
      console.warn('âš ï¸ Not authenticated - waiting for auth to complete');
    }
  }
}

async function batchSyncToFirestore(records) {
  if (!firebaseState.db || !firebaseState.user) {
    console.warn('âš ï¸ Firebase not ready for batch sync');
    return;
  }
  
  if (!records || records.length === 0) return;
  
  try {
    let batch = firebaseState.db.batch();
    let opCount = 0;
    let totalOps = 0;
    let trialCount = 0;
    let batchNumber = 0;

    const commitBatch = async () => {
      if (opCount === 0) return;
      batchNumber += 1;
      console.log('ðŸ“¦ Committing batch', batchNumber, 'ops:', opCount);
      await batch.commit();
      totalOps += opCount;
      batch = firebaseState.db.batch();
      opCount = 0;
    };
    
    for (const record of records) {
      const { storeName, data, id } = record;
      
      if (!FIRESTORE_COLLECTIONS[storeName]) {
        console.warn('âš ï¸ Skipping unknown collection:', storeName);
        continue;
      }
      
      const ref = getFirestoreCollectionRef(storeName);
      if (!ref) {
        console.warn('âš ï¸ No collection ref for:', storeName);
        continue;
      }
      
      const keyField = FIRESTORE_COLLECTIONS[storeName]?.key;
      const payload = { ...data };
      if (keyField && payload[keyField] === undefined) payload[keyField] = id;
      payload.local_id = id;
      if (!payload.hub) payload.hub = currentHub;
      
      const docId = buildFirestoreDocId(storeName, id, payload);
      batch.set(ref.doc(docId), payload, { merge: true });
      opCount++;

      if (storeName === 'trials') {
        trialCount++;
        if (trialCount <= 3) console.log('âœ“ Queued trial:', id);
        const legacyDocId = `${storeName}_${id}`;
        if (legacyDocId !== docId) {
          batch.delete(ref.doc(legacyDocId));
          opCount++;
        }
      }

      if (opCount >= 450) {
        await commitBatch();
      }
    }
    
    await commitBatch();
    if (totalOps > 0) {
      console.log('âœ… Batch sync complete:', totalOps, 'ops (', trialCount, 'trials)');
    }
  } catch (err) {
    console.error('âŒ Batch sync error:', err.message);
    console.error('   Error code:', err.code);
    throw err;
  }
}

async function batchDeleteFromFirestore(deleteQueries) {
  if (!firebaseState.db || !firebaseState.user) {
    console.warn('âš ï¸ Firebase not ready for batch delete');
    return;
  }
  
  if (!deleteQueries || deleteQueries.length === 0) return;
  
  try {
    let totalDeleted = 0;
    
    for (const query of deleteQueries) {
      const snapshot = await query.get();
      console.log(`  Deleting ${snapshot.docs.length} records from collection...`);
      
      // Delete in batches of 500 (Firestore limit)
      const batch = firebaseState.db.batch();
      let batchSize = 0;
      
      for (const doc of snapshot.docs) {
        batch.delete(doc.ref);
        batchSize++;
        totalDeleted++;
        
        // Commit batch if it reaches 500
        if (batchSize === 500) {
          console.log('  Committing batch of 500...');
          await batch.commit();
          batchSize = 0;
        }
      }
      
      // Commit remaining records in batch
      if (batchSize > 0) {
        console.log(`  Committing final batch of ${batchSize}...`);
        await batch.commit();
      }
    }
    
    console.log('âœ… Batch delete complete: deleted', totalDeleted, 'records total');
  } catch (err) {
    console.error('âŒ Batch delete error:', err.message);
  }
}

async function deleteRecordFromFirestore(storeName, id, data = null) {
  if (!FIRESTORE_COLLECTIONS[storeName]) return;
  if (suppressFirestoreWrites) return;
  if (!firebaseState.db || !firebaseState.user) return;
  const ref = getFirestoreCollectionRef(storeName);
  if (!ref) return;
  const docIds = new Set();
  docIds.add(buildFirestoreDocId(storeName, id, data));
  if (storeName === 'trials') {
    docIds.add(`${storeName}_${id}`); // legacy cleanup
  }
  for (const docId of docIds) {
    if (!docId) continue;
    await ref.doc(docId).delete();
  }
}

async function clearFirestoreCollection(storeName) {
  if (!FIRESTORE_COLLECTIONS[storeName]) return;
  if (suppressFirestoreWrites) return;
  if (!firebaseState.db || !firebaseState.user) return;
  const ref = getFirestoreCollectionRef(storeName);
  if (!ref) return;
  const snapshot = await ref.get();
  const batch = firebaseState.db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}

async function startFirestoreSync(options = {}) {
  if (!firebaseState.db || !firebaseState.user) {
    console.warn('âš ï¸ Firebase not ready for sync');
    return;
  }
  
  const resetLocal = !!options.resetLocal;
  console.log('ðŸ”„ Starting Firestore sync, resetLocal:', resetLocal);

  stopFirestoreSync(true);

  // If resetting, clear stores AFTER listeners are set up (not before)
  const willReset = resetLocal;
  let syncedCollections = 0;
  
  Object.keys(FIRESTORE_COLLECTIONS).forEach(collectionName => {
    const storeName = FIRESTORE_COLLECTIONS[collectionName].store;
    const keyField = FIRESTORE_COLLECTIONS[collectionName].key;
    const ref = getFirestoreCollectionRef(collectionName);
    if (!ref) return;

    let isFirstSnapshot = true;
    const unsub = ref.onSnapshot(async (snapshot) => {
      console.log(`ðŸ“¥ Firestore snapshot for ${collectionName}:`, snapshot.docs.length, 'docs');
      
      await runWithFirestoreSuppressed(async () => {
        let trialKeyMap = null;
        if (storeName === 'trials') {
          const existingTrials = await getAllRecords('trials');
          trialKeyMap = {};
          existingTrials.forEach(t => {
            const key = `${normalizeHub(t.hub || currentHub)}::${normalizeTrialIdentifier(t.trial_identifier)}`;
            if (key && !trialKeyMap[key]) trialKeyMap[key] = t.trial_id;
          });
        }

        // Only clear on first snapshot if resetLocal is true
        if (isFirstSnapshot && willReset) {
          console.log(`  ðŸ—‘ï¸  Clearing local ${storeName} for fresh sync...`);
          await clearStore(storeName);
        }
        isFirstSnapshot = false;
        
        for (const change of snapshot.docChanges()) {
          const docData = change.doc.data() || {};
          let localId = docData.local_id || docData[keyField];

          if (!localId) {
            const idParts = change.doc.id.split('_');
            const rawId = idParts.slice(1).join('_');
            const parsedId = parseInt(rawId, 10);
            localId = Number.isNaN(parsedId) ? rawId : parsedId;
          }

          if (localId === null || localId === undefined || localId === '') continue;

          const record = { ...docData };
          record[keyField] = localId;
          if (!record.hub) record.hub = currentHub;

          if (change.type === 'removed') {
            await deleteRecord(storeName, localId);
          } else {
            if (storeName === 'trials' && trialKeyMap) {
              const trialKey = `${normalizeHub(record.hub || currentHub)}::${normalizeTrialIdentifier(record.trial_identifier)}`;
              const existingId = trialKey ? trialKeyMap[trialKey] : null;
              if (existingId && existingId !== localId) {
                await deleteRecord('trials', existingId);
              }
              if (trialKey) trialKeyMap[trialKey] = localId;
            }
            await putRecord(storeName, record);
          }
        }
      });

      syncedCollections++;
      scheduleRefreshAllViews();
    });

    firebaseState.unsubscribers.push(unsub);
  });
  
  console.log('âœ… Firestore listeners attached for', syncedCollections, 'collections');
}

async function initFirebaseForHub(hub) {
  if (!isFirestoreEnabledForHub(hub)) {
    console.log('âŒ Firestore not enabled for hub:', hub);
    updateFirebaseStatusUI();
    return;
  }

  if (firebaseState.hub === hub && firebaseState.auth && firebaseState.db && firebaseState.user) {
    console.log('âœ… Firebase already initialized for hub:', hub);
    updateFirebaseStatusUI();
    return;
  }

  console.log('ðŸ”µ Initializing Firebase for hub:', hub);
  stopFirestoreSync(true);

  let app = null;
  const config = FIREBASE_CONFIGS[hub];
  const existing = firebase.apps ? firebase.apps.find(a => a.name === hub) : null;
  if (existing) {
    app = existing;
    console.log('âœ… Using existing Firebase app for hub:', hub);
  } else {
    app = firebase.initializeApp(config, hub);
    console.log('âœ… Initialized new Firebase app for hub:', hub);
  }

  firebaseState.app = app;
  firebaseState.auth = app.auth();
  firebaseState.db = app.firestore();
  firebaseState.hub = hub;

  firebaseState.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => console.log('âœ… Persistence enabled for hub:', hub))
    .catch(err => console.warn('âš ï¸ Persistence error:', err));

  // Wait for auth to be ready and ensure anonymous authentication
  await new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
      console.warn('âš ï¸ Auth state change timeout for hub:', hub);
      // If auth doesn't fire after 3 seconds, continue anyway (auth might be disabled)
      firebaseState.user = firebaseState.user || null;
      console.log('ðŸ’¾ Starting Firestore sync (keeping local data as fallback)...');
      startFirestoreSync({ resetLocal: false });
      resolve();
    }, 3000);

    const unsubscribe = firebaseState.auth.onAuthStateChanged(async user => {
      clearTimeout(timeout);
      firebaseState.user = user || null;
      console.log('ðŸ”µ Auth state changed:', {
        hub: hub,
        authenticated: !!user,
        isAnonymous: user?.isAnonymous || false,
        uid: user?.uid || 'none'
      });
      updateFirebaseStatusUI();
      
      if (user) {
        console.log('âœ… User authenticated for hub:', hub);
        console.log('ðŸ’¾ Syncing Firestore data (merging with local data)...');
        startFirestoreSync({ resetLocal: false });
        await ensureDefaultAdminInFirestore();
        resolve();
      } else {
        console.log('ðŸ”µ Attempting anonymous sign-in for hub:', hub);
        try {
          const anonUser = await firebaseState.auth.signInAnonymously();
          firebaseState.user = anonUser.user;
          console.log('âœ… Anonymous sign-in successful for hub:', hub, 'UID:', anonUser.user.uid);
          console.log('ðŸ’¾ Syncing Firestore data (merging with local data)...');
          startFirestoreSync({ resetLocal: false });
          await ensureDefaultAdminInFirestore();
          resolve();
        } catch (err) {
          console.error('âŒ Anonymous sign-in failed for hub:', hub);
          console.error('   Error:', err.code, '-', err.message);
          console.warn('âš ï¸ Continuing with local data + read-only Firestore mode');
          // Continue anyway - Firestore might still work if rules allow
          firebaseState.user = { isAnonymous: true, uid: 'offline' };
          console.log('ðŸ’¾ Using local data only (Firestore read-only mode)...');
          startFirestoreSync({ resetLocal: false });
          resolve();
        }
      }
    });
  });

  console.log('âœ… Firebase fully initialized for hub:', hub);
}

function signInWithGoogle() {
  if (!firebaseState.auth || firebaseState.hub !== currentHub) {
    initFirebaseForHub(currentHub);
  }
  if (!firebaseState.auth) return;
  const provider = new firebase.auth.GoogleAuthProvider();
  firebaseState.auth.signInWithPopup(provider)
    .catch(err => alert('Firebase sign-in error: ' + err.message));
}

function signOutFirebase() {
  if (!firebaseState.auth) return;
  firebaseState.auth.signOut();
}

function forceFirestoreResync() {
  if (!firebaseState.user) return;
  startFirestoreSync({ resetLocal: true });
}

async function ensureDefaultAdminUser() {
  const users = await getAllRecords('users');
  const exists = users.some(u => (u.username || '').toLowerCase() === 'dilip');
  if (!exists) {
    const adminUser = {
      username: 'Dilip',
      password: 'Dilip321',
      role: 'admin',
      hubs: ['IO', 'ADC', 'CHECKPOINT'],
      created_at: new Date().toISOString()
    };
    await addRecord('users', adminUser);
    if (firebaseState.db && firebaseState.user) {
      await syncRecordToFirestore('users', adminUser, 'Dilip');
    }
  }
}

async function ensureDefaultAdminInFirestore() {
  if (!firebaseState.db || !firebaseState.user) return;
  const ref = getFirestoreCollectionRef('users');
  if (!ref) return;
  const docId = buildFirestoreDocId('users', 'Dilip');
  const doc = await ref.doc(docId).get();
  if (!doc.exists) {
    const adminUser = {
      username: 'Dilip',
      password: 'Dilip321',
      role: 'admin',
      hubs: ['IO', 'ADC', 'CHECKPOINT'],
      created_at: new Date().toISOString(),
      hub: currentHub
    };
    await ref.doc(docId).set(adminUser, { merge: true });
  }
}

async function initAuth() {
  await ensureDefaultAdminUser();
  const stored = sessionStorage.getItem('dklinity.user');
  if (stored) {
    try {
      currentUser = JSON.parse(stored);
    } catch (e) {
      currentUser = null;
    }
  }
  updateUserSessionUI();
  updateAdminUi();
}

function showLoginOverlay(message) {
  const overlay = document.getElementById('loginOverlay');
  if (overlay) overlay.style.display = 'flex';
  setLoginError(message || '');
}

function hideLoginOverlay() {
  const overlay = document.getElementById('loginOverlay');
  if (overlay) overlay.style.display = 'none';
  setLoginError('');
}

function setLoginError(message) {
  const el = document.getElementById('loginError');
  if (!el) return;
  if (message) {
    el.textContent = message;
    el.style.display = 'block';
  } else {
    el.textContent = '';
    el.style.display = 'none';
  }
}

async function handleLogin() {
  const username = (document.getElementById('loginUsername')?.value || '').trim();
  const password = (document.getElementById('loginPassword')?.value || '').trim();
  if (!username || !password) {
    setLoginError('Username and password are required.');
    return;
  }

  const users = await getAllRecords('users');
  const user = users.find(u => (u.username || '').toLowerCase() === username.toLowerCase());
  if (!user || user.password !== password) {
    setLoginError('Invalid username or password.');
    return;
  }

  currentUser = {
    username: user.username,
    role: user.role || 'user',
    hubs: Array.isArray(user.hubs) ? user.hubs : ['IO']
  };
  sessionStorage.setItem('dklinity.user', JSON.stringify(currentUser));
  hideLoginOverlay();
  updateUserSessionUI();
  updateAdminUi();

  if (pendingHub) {
    const hubToOpen = pendingHub;
    pendingHub = null;
    enterHub(hubToOpen);
  }
}

function logoutUser() {
  currentUser = null;
  sessionStorage.removeItem('dklinity.user');
  updateUserSessionUI();
  updateAdminUi();
  exitHubToCards();
  hideLoginOverlay();
}

function userCanAccessHub(hub) {
  if (!currentUser) return false;
  if (currentUser.role === 'admin') return true;
  const hubs = Array.isArray(currentUser.hubs) ? currentUser.hubs : [];
  return hubs.includes(hub);
}

function requireAdminAction() {
  if (!currentUser || currentUser.role !== 'admin') {
    alert('Admin access required for this action.');
    return false;
  }
  return true;
}

function updateUserSessionUI() {
  const box = document.getElementById('userSessionBox');
  const nameEl = document.getElementById('userSessionName');
  const roleEl = document.getElementById('userSessionRole');
  if (!box) return;
  if (currentUser) {
    if (nameEl) nameEl.textContent = currentUser.username;
    if (roleEl) roleEl.textContent = currentUser.role || 'user';
    box.style.display = 'flex';
  } else {
    box.style.display = 'none';
  }
}

function updateAdminUi() {
  const isAdmin = currentUser && currentUser.role === 'admin';
  const importTab = document.getElementById('import');
  const navImportTab = document.getElementById('navImportTab');
  const adminPanel = document.getElementById('adminUserPanel');

  if (navImportTab) navImportTab.style.display = isAdmin ? 'block' : 'none';
  if (adminPanel) adminPanel.style.display = isAdmin ? 'block' : 'none';

  if (!isAdmin && importTab && importTab.classList.contains('active')) {
    activateTab('dashboard');
  }

  renderUserList();
}

async function createUser() {
  if (!requireAdminAction()) return;
  const username = (document.getElementById('newUserName')?.value || '').trim();
  const password = (document.getElementById('newUserPassword')?.value || '').trim();
  const role = (document.getElementById('newUserRole')?.value || 'user').trim();
  const hubSelection = (document.getElementById('newUserHub')?.value || 'IO').trim();
  const messageEl = document.getElementById('userAdminMessage');

  if (!username || !password) {
    if (messageEl) messageEl.textContent = 'Username and password are required.';
    return;
  }

  const users = await getAllRecords('users');
  if (users.some(u => (u.username || '').toLowerCase() === username.toLowerCase())) {
    if (messageEl) messageEl.textContent = 'Username already exists.';
    return;
  }

  const hubs = hubSelection === 'ALL' ? ['IO', 'ADC', 'CHECKPOINT'] : [hubSelection];
  const userData = {
    username,
    password,
    role,
    hubs,
    created_at: new Date().toISOString()
  };
  await addRecord('users', userData);
  
  // Explicitly sync to Firestore for each hub the user has access to
  if (firebaseState.db && firebaseState.user) {
    for (const hub of hubs) {
      if (isFirestoreEnabledForHub(hub)) {
        const ref = firebaseState.db.collection('users');
        if (ref) {
          await ref.doc(username).set(userData, { merge: true });
          console.log('âœ… User synced to Firestore:', username);
        }
      }
    }
  } else {
    console.log('âš ï¸ Firebase not initialized. User only saved to local DB.');
  }

  if (messageEl) messageEl.textContent = 'User created successfully. Syncing to cloud...';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserPassword').value = '';
  document.getElementById('newUserRole').value = 'user';
  document.getElementById('newUserHub').value = 'IO';

  renderUserList();
}

function checkFirebaseStatus() {
  console.log('ðŸ” Firebase Status Check:');
  console.log('  Hub:', currentHub);
  console.log('  Firebase Enabled:', isFirestoreEnabledForHub(currentHub));
  console.log('  DB Initialized:', !!firebaseState.db);
  console.log('  User Authenticated:', !!firebaseState.user);
  console.log('  Anonymous Auth:', firebaseState.user?.isAnonymous || false);
  console.log('  Suppress Writes:', suppressFirestoreWrites);
  if (firebaseState.user) {
    console.log('  Firebase UID:', firebaseState.user.uid);
  }
  return {
    hub: currentHub,
    enabled: isFirestoreEnabledForHub(currentHub),
    db: !!firebaseState.db,
    auth: !!firebaseState.user,
    anonymous: firebaseState.user?.isAnonymous || false
  };
}

async function deleteUser(username) {
  if (!requireAdminAction()) return;
  if (!username || username.toLowerCase() === 'dilip') {
    alert('Default admin user cannot be deleted.');
    return;
  }
  await deleteRecord('users', username);
  
  // Explicitly delete from Firestore
  if (firebaseState.db && firebaseState.user) {
    const ref = firebaseState.db.collection('users');
    if (ref) {
      await ref.doc(username).delete();
      console.log('âœ… User deleted from Firestore:', username);
    }
  } else {
    console.log('âš ï¸ Firebase not initialized. User only deleted from local DB.');
  }
  
  renderUserList();
}

async function renderUserList() {
  const listEl = document.getElementById('userList');
  if (!listEl) return;
  const users = await getAllRecords('users');
  if (!users.length) {
    listEl.innerHTML = '<div style="font-size:12px;color:#7c2d12;">No users found.</div>';
    return;
  }

  const rows = users.map(u => {
    const hubs = Array.isArray(u.hubs) ? u.hubs.join(', ') : '';
    const canDelete = (u.username || '').toLowerCase() !== 'dilip';
    const deleteBtn = canDelete ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${escapeHtml(u.username)}')">Delete</button>` : '';
    return `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 6px;border-bottom:1px solid #fed7aa;gap:8px;">
        <div style="font-size:12px;color:#7c2d12;">
          <strong>${escapeHtml(u.username)}</strong> â€¢ ${escapeHtml(u.role || 'user')} â€¢ ${escapeHtml(hubs)}
        </div>
        ${deleteBtn}
      </div>
    `;
  }).join('');

  listEl.innerHTML = rows;
}

// ============ HUB-SPECIFIC SCHEMAS ============
const HUB_DRUG_FIELDS = {
  IO: [
    'hub', 'product_name', 'pd_l1', 'asset_synonyms', 'drug_class', 'moa', 'target', 'modality',
    'highest_phase', 'development_status', 'asset_status', 'active_inactive', 'sponsor',
    'company_type', 'company_logo',
    'sponsor_logo', 'collaborator_logo',
    'moa_modality_source', 'asset_status_source', 'evidence_vitro', 'evidence_vivo', 'preclinical_pub_source',
    'sales_millions', 'sales_source', 'upcoming_clinical', 'upcoming_clinical_source',
    'upcoming_regulatory', 'upcoming_regulatory_source', 'partnerships', 'partnerships_source',
    'news_regulatory', 'news_commercial', 'news_source', 'approved_region', 'regulatory_agency',
    'regulatory_designations', 'regulatory_designations_source', 'boxed_warning', 'boxed_warning_source',
    'clinical_failure', 'clinical_failure_source'
  ],
  ADC: [
    'hub', 'asset_name', 'product_name', 'asset_synonyms', 'sponsor', 'collaborator', 'highest_phase', 'development_status', 'asset_status', 'active_inactive',
    'company_type', 'company_logo',
    'sponsor_logo', 'collaborator_logo',
    'clinical_preclinical',
    'conjugate_type', 'conjugate_subtype', 'moa', 'antibody_carrier', 'target', 'target_synonyms',
    'combined_target_list', 'payload_class', 'payload_group', 'payload', 'linker_type', 'linker',
    'conjugation_type', 'conjugation', 'dar_loading_ratio', 'platform_technology',
    'antibody_target_source', 'dar_loading_ratio_source', 'platform_technology_source',
    'payloads_source', 'linker_source', 'conjugation_source', 'adc_structure_url', 'adc_structure_source',
    'asset_status_source', 'approved_region', 'regulatory_agency', 'approval_year', 'regulatory_designation', 
    'regulatory_designations_source', 'boxed_warning', 'boxed_warning_source', 'evidence_vitro', 'evidence_vivo', 
    'preclinical_pub_source', 'sales_millions', 'sales_source', 'partnerships', 'partnerships_source', 'upcoming_clinical', 'upcoming_clinical_source',
    'upcoming_regulatory', 'upcoming_regulatory_source', 'news_regulatory', 'news_commercial', 'news_source',
    'trials_with_results', 'clinical_failure', 'clinical_failure_source', 'remarks', 'additional_comments', 
    'last_updated_on', 'analyst_name'
  ],
  CHECKPOINT: []
};

const HUB_TRIAL_FIELDS = {
  IO: [
    'hub', 'trial_identifier', 'trial_title', 'trial_acronym', 'trial_design', 'development_status',
    'recruitment_status', 'registrational', 'tumor_group', 'tumors', 'patient_age_group',
    'patient_number', 'study_start_date', 'primary_completion_date', 'study_completion_date',
    'stage', 'line_of_therapy', 'mutations', 'prospective_biomarkers',
    'dx_assay', 'dx_cutoff_value', 'sponsor', 'collaborator', 'location', 'region',
    'clinical_failure', 'trials_with_results', 'mono_combo', 'regimens',
    'regimen_moa', 'comparator_arm', 'primary_endpoint', 'secondary_endpoint',
    'included_based_on_prior', 'excluded_based_on_prior', 'patients_brain_cns_mets',
    'approved_region', 'regulatory_agency', 'approval_year', 'regulatory_designation',
    'efficacy_evaluable', 'data_review_committee', 'orr', 'dcr', 'cr', 'pr', 'sd', 'pd',
    'mdor_months', 'pfs_months', 'mpfs_months', 'os_months', 'mos_months', 'dfs',
    'mdfs_months', 'os_percent', 'pfs_percent', 'dfs_percent', 'pfs_hr', 'os_hr', 'efficacy_others', 'publication_source_clinical',
    'safety_evaluable', 'grade_3_ae', 'grade_3_traes', 'immune_related_aes', 'sae',
    'any_grade_aes', 'deaths', 'tx_related_mortality', 'safety_others', 'publication_source_safety',
    'study_identifier_source', 'registrational_trial_source', 'clinical_failure_source',
    'approval_labels_source', 'regulatory_designations_source', 'reference',
    'other_registry_trial_id'
  ],
  ADC: [
    'hub', 'trial_identifier', 'trial_title', 'trial_acronym', 'trial_design', 'development_status',
    'recruitment_status', 'registrational', 'tumors', 'mutation_biomarker', 'patient_age_group', 'patient_number',
    'study_start_date', 'primary_completion_date', 'study_completion_date', 'stage', 'line_of_therapy',
    'sponsor', 'collaborator', 'location', 'region',
    'mono_combo', 'regimens', 'regimen_moa',
    'included_based_on_prior', 'excluded_based_on_prior',
    'primary_endpoint', 'approved_region', 'regulatory_agency',
    'approval_year', 'boxed_warning', 'regulatory_designation', 'upcoming_clinical', 'upcoming_regulatory',
    'efficacy_evaluable', 'data_review_committee', 'orr', 'dcr', 'cr', 'pr',
    'sd', 'pd', 'mdor_months', 'pfs_months', 'mpfs_months', 'os_months', 'mos_months',
    'dfs', 'mdfs_months', 'os_percent', 'pfs_percent', 'dfs_percent',
    'efficacy_others', 'publication_source_clinical',
    'safety_evaluable', 'grade_3_ae', 'grade_3_traes', 'any_grade_aes', 'sae',
    'immune_related_aes', 'deaths', 'tx_related_mortality', 'safety_others', 'publication_source_safety',
    'trials_with_results', 'clinical_failure',
    'study_identifier_source', 'registrational_trial_source', 'clinical_failure_source',
    'approval_labels_source', 'regulatory_designations_source', 'upcoming_clinical_source', 'upcoming_regulatory_source',
    'boxed_warning_source', 'reference',
    'other_registry_trial_id'
  ],
  CHECKPOINT: []
};

// Auto-detect hub type from Excel headers
function autoDetectHub(headers) {
  const headerStr = headers.map(h => String(h || '').toLowerCase()).join('|');
  
  // ADC-specific keywords
  const adcKeywords = ['conjugate', 'payload', 'linker', 'dar', 'antibody', 'adc'];
  const adcMatches = adcKeywords.filter(kw => headerStr.includes(kw)).length;
  
  // IO-specific keywords
  const ioKeywords = ['immuno', 'checkpoint', 'pd-l1', 'pd_l1'];
  const ioMatches = ioKeywords.filter(kw => headerStr.includes(kw)).length;
  
  if (adcMatches >= 2) return 'ADC';
  if (ioMatches >= 1) return 'IO';
  return 'IO'; // default
}

function normalizeHub(value) {
  const v = String(value || '').trim().toUpperCase();
  if (v === 'ADC') return 'ADC';
  if (v === 'IO' || v === 'IMMUNO-ONCOLOGY' || v === 'IMMUNO ONCOLOGY') return 'IO';
  if (v === 'CHECKPOINT') return 'CHECKPOINT';
  return 'IO';
}

function getRecordHub(record) {
  return normalizeHub(record?.hub);
}

function getDrugDisplayName(drug) {
  const hub = getRecordHub(drug);
  if (hub === 'ADC') return (drug.asset_name || drug.product_name || '').toString().trim();
  return (drug.product_name || drug.asset_name || '').toString().trim();
}

async function setCurrentHub(hub, options = {}) {
  currentHub = normalizeHub(hub);
  try { localStorage.setItem('dklinity.activeHub', currentHub); } catch (e) {}
  updateHubUi();
  console.log('â³ Initializing Firebase for hub:', currentHub);
  await initFirebaseForHub(currentHub);
  console.log('âœ… Firebase initialized, refreshing views...');
  if (!options.silent) refreshAllViews();
}

async function enterHub(hub, tabName = 'drugs') {
  const targetHub = normalizeHub(hub);
  if (!currentUser) {
    pendingHub = targetHub;
    showLoginOverlay('Please sign in to access this hub.');
    return;
  }
  if (!userCanAccessHub(targetHub)) {
    alert('You do not have access to this hub. Please contact admin.');
    return;
  }
  console.log('ðŸ”µ ENTERING HUB:', hub);
  try { sessionStorage.setItem('dklinity.inHub', 'true'); } catch (e) {}
  
  // Change header to dark mode when in hub
  const header = document.getElementById('mainHeader');
  if (header) {
    header.classList.add('hub-mode');
    header.classList.remove('home-mode');
  }
  
  console.log('â³ Loading hub data...');
  await setCurrentHub(hub);
  
  // Wait a moment for Firestore listeners to be set up
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  console.log('âœ… Hub loaded, displaying data...');
  setNavTabsVisible(true);
  activateTab(tabName === 'drugs' ? 'dashboard' : tabName);
  applyFilterDefaults();
  updateHubDashboard();
  setTimeout(() => checkDailyMonitoringAlert(), 500);
}

function exitHubToCards() {
  // Change header back to light mode
  const header = document.getElementById('mainHeader');
  if (header) {
    header.classList.remove('hub-mode');
    header.classList.add('home-mode');
  }
  
  // Hide all other tabs
  document.querySelectorAll('.tab-content').forEach(el => {
    if (el.id !== 'dashboard') {
      el.style.display = 'none';
    }
  });
  
  // Show the dashboard tab (which contains home page content)
  const dashboardTab = document.getElementById('dashboard');
  if (dashboardTab) {
    dashboardTab.style.display = 'block';
    dashboardTab.classList.add('active');
  }
  
  // Hide all hub-dashboard content
  document.querySelectorAll('.hub-dashboard').forEach(el => {
    el.style.display = 'none';
  });
  
  // Go back to home page
  setNavTabsVisible(false);
  try {
    localStorage.removeItem('dklinity.activeTab');
    localStorage.removeItem('dklinity.activeHub');
    sessionStorage.removeItem('dklinity.inHub');
  } catch (e) {}
  clearDashboardFilters();
}

function setNavTabsVisible(isVisible) {
  const nav = document.querySelector('.nav-tabs');
  if (!nav) return;
  const headerCenter = document.querySelector('.header-center');
  
  if (isVisible) {
    nav.classList.remove('hidden');
  } else {
    nav.classList.add('hidden');
  }
  
  document.querySelectorAll('.hub-only').forEach(el => {
    el.style.display = isVisible ? 'block' : 'none';
  });
  
  // Handle marketing nav in header with class toggle
  const headerNav = document.querySelector('.header-nav-marketing');
  if (headerNav) {
    if (isVisible) {
      headerNav.classList.add('hidden');
    } else {
      headerNav.classList.remove('hidden');
    }
  }
  if (headerCenter) {
    if (isVisible) {
      headerCenter.classList.remove('home-left');
    } else {
      headerCenter.classList.add('home-left');
    }
  }
  
  // Handle other hub-home-only elements with style
  document.querySelectorAll('.hub-home-only:not(.header-nav-marketing)').forEach(el => {
    el.style.display = isVisible ? 'none' : 'block';
  });
}

function updateHubUi() {
  const label = HUB_LABELS[currentHub] || HUB_LABELS.IO;
  const labelTargets = [
    document.getElementById('activeHubLabel'),
    document.getElementById('activeHubLabelDashboard'),
    document.getElementById('activeHubLabelDrugs'),
    document.getElementById('activeHubLabelTrials'),
    document.getElementById('activeHubLabelCompanies'),
    document.getElementById('activeHubLabelImport')
  ];
  labelTargets.forEach(el => { if (el) el.textContent = label; });
  const dashTitle = document.getElementById('hubDashboardTitle');
  if (dashTitle) dashTitle.textContent = label + ' Dashboard';
  document.querySelectorAll('.hub-card').forEach(card => {
    const hub = normalizeHub(card.getAttribute('data-hub'));
    if (hub === currentHub) card.classList.add('active');
    else card.classList.remove('active');
  });
  
  // Update import/export tab labels
  const importExportHubName = document.getElementById('importExportHubName');
  if (importExportHubName) importExportHubName.textContent = currentHub;
  const importHubNameText = document.getElementById('importHubNameText');
  if (importHubNameText) importHubNameText.textContent = currentHub;
  const exportHubNameText = document.getElementById('exportHubNameText');
  if (exportHubNameText) exportHubNameText.textContent = currentHub;
  const clearHubNameText = document.getElementById('clearHubNameText');
  if (clearHubNameText) clearHubNameText.textContent = currentHub;
  const clearBtnHubName = document.getElementById('clearBtnHubName');
  if (clearBtnHubName) clearBtnHubName.textContent = currentHub;
  const currentHubIndicator = document.getElementById('currentHubIndicator');
  if (currentHubIndicator) currentHubIndicator.textContent = currentHub;
  const defaultImportHub = document.getElementById('defaultImportHub');
  if (defaultImportHub) defaultImportHub.textContent = currentHub;
  updateFirebaseStatusUI();
  updateAdminUi();
}

function applyFilterDefaults() {
  const defaults = HUB_FILTER_DEFAULTS[currentHub] || HUB_FILTER_DEFAULTS.IO;
  const phaseEl = document.getElementById('dashboardFilterPhase');
  const statusEl = document.getElementById('dashboardFilterStatus');
  const condEl = document.getElementById('dashboardFilterCondition');
  const sponsorEl = document.getElementById('dashboardFilterSponsor');
  const drugEl = document.getElementById('dashboardFilterDrug');
  
  if (phaseEl) phaseEl.value = defaults.phase || '';
  if (statusEl) statusEl.value = defaults.status || '';
  if (condEl) condEl.value = defaults.condition || '';
  if (sponsorEl) sponsorEl.value = defaults.sponsor || '';
  if (drugEl) drugEl.value = defaults.drug || '';
  
  updateDashboardStats().catch(err => console.error('Error updating dashboard:', err));
}

function dismissAlert(alertId) {
  const alertEl = document.getElementById(alertId);
  if (alertEl) alertEl.style.display = 'none';
}

function checkDailyMonitoringAlert() {
  const today = new Date().toISOString().split('T')[0];
  const lastCheckKey = 'regulatoryLastCheck_' + currentHub;
  const lastCheck = localStorage.getItem(lastCheckKey) || '';
  
  if (lastCheck !== today) {
    const alertEl = document.getElementById('regulatoryMonitoringAlert');
    if (alertEl) {
      alertEl.style.display = 'block';
      const hubName = HUB_LABELS[currentHub] || currentHub;
      const hubNameSpan = document.getElementById('regulatoryAlertHubName');
      if (hubNameSpan) hubNameSpan.textContent = hubName;
    }
    localStorage.setItem(lastCheckKey, today);
  }
}

async function ensureHubFieldsOnRecords() {
  // This function ensures all records have a hub field set
  // If a record doesn't have a hub, we need to identify it based on context
  // For now, we'll set it to 'IO' as default for safety
  
  console.log('ðŸ”„ Ensuring hub fields on all records...');
  
  const companies = await getAllRecords('companies');
  const drugs = await getAllRecords('drugs');
  const trials = await getAllRecords('trials');
  
  let companiesFixed = 0, drugsFixed = 0, trialsFixed = 0;
  
  // Fix companies
  for (const company of companies) {
    if (!company.hub) {
      company.hub = 'IO';
      await putRecord('companies', company);
      companiesFixed++;
    }
  }
  
  // Fix drugs
  for (const drug of drugs) {
    if (!drug.hub) {
      // Try to detect based on fields
      const isADC = drug.asset_name && (drug.conjugate_type || drug.payload || drug.linker);
      drug.hub = isADC ? 'ADC' : 'IO';
      await putRecord('drugs', drug);
      drugsFixed++;
    }
  }
  
  // Fix trials
  for (const trial of trials) {
    if (!trial.hub) {
      // Try to detect based on associated drug
      let detectedHub = 'IO';
      if (trial.asset_id) {
        const drug = drugs.find(d => d.drug_id === trial.asset_id);
        if (drug && drug.hub) {
          detectedHub = drug.hub;
        }
      }
      trial.hub = detectedHub;
      await putRecord('trials', trial);
      trialsFixed++;
    }
  }
  
  if (companiesFixed > 0 || drugsFixed > 0 || trialsFixed > 0) {
    console.log(`âœ… Fixed hub fields: ${companiesFixed} companies, ${drugsFixed} drugs, ${trialsFixed} trials`);
  }
}

async function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => reject(req.error);
    req.onsuccess = () => { db = req.result; resolve(db); };
    req.onupgradeneeded = (e) => {
      const database = e.target.result;
      if (!database.objectStoreNames.contains('companies')) {
        database.createObjectStore('companies', { keyPath: 'company_id', autoIncrement: true });
      }
      if (!database.objectStoreNames.contains('drugs')) {
        database.createObjectStore('drugs', { keyPath: 'drug_id', autoIncrement: true });
      }
      if (!database.objectStoreNames.contains('trials')) {
        database.createObjectStore('trials', { keyPath: 'trial_id', autoIncrement: true });
      }
      if (!database.objectStoreNames.contains('logs')) {
        database.createObjectStore('logs', { keyPath: 'log_id', autoIncrement: true });
      }
      if (!database.objectStoreNames.contains('regulatory_announcements')) {
        database.createObjectStore('regulatory_announcements', { keyPath: 'news_id', autoIncrement: true });
      }
      if (!database.objectStoreNames.contains('users')) {
        database.createObjectStore('users', { keyPath: 'username' });
      }
    };
  });
}

function getStore(storeName, mode = 'readonly') {
  const tx = db.transaction([storeName], mode);
  return tx.objectStore(storeName);
}

async function addRecord(storeName, data) {
  const id = await new Promise((resolve, reject) => {
    const store = getStore(storeName, 'readwrite');
    const req = store.add(data);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });

  // Only sync to Firestore if suppression is not enabled (much faster during import)
  if (!suppressFirestoreWrites) {
    await syncRecordToFirestore(storeName, data, id);
  }
  return id;
}

async function putRecord(storeName, data) {
  const result = await new Promise((resolve, reject) => {
    const store = getStore(storeName, 'readwrite');
    const req = store.put(data);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });

  const keyField = FIRESTORE_COLLECTIONS[storeName]?.key;
  const id = keyField ? data[keyField] : result;
  
  // Only sync to Firestore if suppression is not enabled (much faster during import)
  if (id !== undefined && id !== null && !suppressFirestoreWrites) {
    await syncRecordToFirestore(storeName, data, id);
  }

  return result;
}

async function getAllRecords(storeName) {
  return new Promise((resolve, reject) => {
    const store = getStore(storeName, 'readonly');
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function getRecordByKey(storeName, key) {
  return new Promise((resolve, reject) => {
    const store = getStore(storeName, 'readonly');
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function deleteRecord(storeName, key) {
  const existingRecord = await getRecordByKey(storeName, key);
  await new Promise((resolve, reject) => {
    const store = getStore(storeName, 'readwrite');
    const req = store.delete(key);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });

  await deleteRecordFromFirestore(storeName, key, existingRecord);
}

// ============ Logging ============
async function addLog(action, entityType, details) {
  const logEntry = {
    timestamp: new Date().toLocaleString(),
    action: action,
    entityType: entityType,
    details: details || ''
  };
  await addRecord('logs', logEntry);
  await refreshAllViews();
}

function splitFilterValues(value) {
  if (value === null || value === undefined) return [];
  if (Array.isArray(value)) {
    return value.map(v => String(v || '').trim()).filter(Boolean);
  }
  return String(value).split(/[,;|]/).map(v => v.trim()).filter(Boolean);
}

function getDrugTargetValuesForFilter(drug) {
  if (!drug) return [];
  const values = [
    ...splitFilterValues(drug.target),
    ...splitFilterValues(drug.combined_target_list),
    ...splitFilterValues(drug.target_synonyms)
  ];
  return Array.from(new Set(values));
}

function getTrialTumorValuesForFilter(trial) {
  if (!trial) return [];
  const values = [
    ...splitFilterValues(trial.tumor_group),
    ...splitFilterValues(trial.tumor_group_values),
    ...splitFilterValues(trial.tumors)
  ];
  return Array.from(new Set(values));
}

// ============ Data Refresh & Render ============
async function refreshAllViews() {
  const companies = await getAllRecords('companies');
  const drugs = await getAllRecords('drugs');
  const trials = await getAllRecords('trials');
  const logs = await getAllRecords('logs');

  const hubCompanies = companies.filter(c => getRecordHub(c) === currentHub);
  const hubDrugs = drugs.filter(d => getRecordHub(d) === currentHub);
  const hubTrials = trials.filter(t => getRecordHub(t) === currentHub);

  // Update stats (if elements exist)
  const statDrugs = document.getElementById('statDrugs');
  if (statDrugs) statDrugs.textContent = hubDrugs.length;
  const statTrials = document.getElementById('statTrials');
  if (statTrials) statTrials.textContent = hubTrials.length;
  const statCompanies = document.getElementById('statCompanies');
  if (statCompanies) statCompanies.textContent = hubCompanies.length;
  let rowVariantCount = 0;
  hubTrials.forEach(t => { if (t.import_row_details) rowVariantCount += t.import_row_details.length; });
  const statCohorts = document.getElementById('statCohorts');
  if (statCohorts) statCohorts.textContent = rowVariantCount;
  const statLogs = document.getElementById('statLogs');
  if (statLogs) statLogs.textContent = logs.length;

  // Render recent logs
  renderRecentLogs(logs.slice(-5).reverse());

  // Preserve filter selections
  const prevDrugSponsor = document.getElementById('drugFilterSponsor')?.value || '';
  const prevTrialSponsor = document.getElementById('trialFilterSponsor')?.value || '';
  const prevDashSponsor = document.getElementById('dashboardFilterSponsor')?.value || '';
  const prevDashCondition = document.getElementById('dashboardFilterCondition')?.value || '';
  const prevDashPhase = document.getElementById('dashboardFilterPhase')?.value || '';
  const prevDashStatus = document.getElementById('dashboardFilterStatus')?.value || '';
  const prevDashDrug = document.getElementById('dashboardFilterDrug')?.value || '';
  const prevDrugPhase = document.getElementById('drugFilterPhase')?.value || '';
  const prevDrugStatus = document.getElementById('drugFilterStatus')?.value || '';
  const prevDrugDevelopment = document.getElementById('drugFilterDevelopment')?.value || '';
  const prevDrugPayload = document.getElementById('drugFilterPayload')?.value || '';
  const prevDrugTarget = document.getElementById('drugFilterTarget')?.value || '';
  const prevDrugTumor = document.getElementById('drugFilterTumor')?.value || '';
  const prevCondition = document.getElementById('trialFilterCondition')?.value || '';
  const prevTrialPhase = document.getElementById('trialFilterPhase')?.value || '';
  const prevCollaborator = document.getElementById('trialFilterCollaborator')?.value || '';
  const prevTrialStatus = document.getElementById('trialFilterStatus')?.value || '';
  const prevTrialTarget = document.getElementById('trialFilterTarget')?.value || '';
  const prevTrialTumor = document.getElementById('trialFilterTumor')?.value || '';

  const drugFilterSponsor = document.getElementById('drugFilterSponsor');
  const trialFilterSponsor = document.getElementById('trialFilterSponsor');
  const dashboardFilterSponsor = document.getElementById('dashboardFilterSponsor');
  const trialFilterCondition = document.getElementById('trialFilterCondition');
  const dashboardFilterCondition = document.getElementById('dashboardFilterCondition');
  const drugFilterTumor = document.getElementById('drugFilterTumor');
  const trialFilterTumor = document.getElementById('trialFilterTumor');
  const drugFilterTarget = document.getElementById('drugFilterTarget');
  const trialFilterTarget = document.getElementById('trialFilterTarget');
  const drugFilterDevelopment = document.getElementById('drugFilterDevelopment');
  const drugFilterPayload = document.getElementById('drugFilterPayload');
  const drugFilterPhase = document.getElementById('drugFilterPhase');
  const drugFilterStatus = document.getElementById('drugFilterStatus');
  const trialFilterCollaborator = document.getElementById('trialFilterCollaborator');
  const trialFilterPhase = document.getElementById('trialFilterPhase');
  const trialFilterStatus = document.getElementById('trialFilterStatus');
  const dashboardFilterPhase = document.getElementById('dashboardFilterPhase');
  const dashboardFilterStatus = document.getElementById('dashboardFilterStatus');
  const dashboardFilterDrug = document.getElementById('dashboardFilterDrug');

  const companyMap = {};
  hubCompanies.forEach(c => { companyMap[c.company_id] = c.company_name; });

  const getDrugSponsorName = (drug) => {
    const fromCompany = companyMap[drug.sponsor_id] || '';
    const fromRecord = String(drug.sponsor || '').trim();
    return fromCompany || fromRecord;
  };

  const drugTumorMap = {};
  hubTrials.forEach(t => {
    if (!t || !t.asset_id) return;
    if (!drugTumorMap[t.asset_id]) drugTumorMap[t.asset_id] = new Set();
    getTrialTumorValuesForFilter(t).forEach(v => drugTumorMap[t.asset_id].add(v));
  });

  const drugTargetsById = {};
  hubDrugs.forEach(d => {
    drugTargetsById[d.drug_id] = new Set(getDrugTargetValuesForFilter(d));
  });

  const drugSearch = (document.getElementById('drugSearch')?.value || '').toString().toLowerCase().trim();
  const trialSearch = (document.getElementById('trialSearch')?.value || '').toString().toLowerCase().trim();

  const drugSelection = {
    phase: prevDrugPhase,
    sponsor: prevDrugSponsor,
    status: prevDrugStatus,
    development: prevDrugDevelopment,
    payload: prevDrugPayload,
    target: prevDrugTarget,
    tumor: prevDrugTumor
  };

  const trialSelection = {
    condition: prevCondition,
    phase: prevTrialPhase,
    sponsor: prevTrialSponsor,
    collaborator: prevCollaborator,
    status: prevTrialStatus,
    target: prevTrialTarget,
    tumor: prevTrialTumor
  };

  const matchesDrugForOptions = (d, ignoreKey) => {
    if (!d || getRecordHub(d) !== currentHub) return false;
    if (drugSearch) {
      const name = (currentHub === 'ADC' ? (d.asset_name || '') : (d.product_name || '')).toString().toLowerCase();
      const altName = (currentHub === 'ADC' ? (d.product_name || '') : (d.asset_name || '')).toString().toLowerCase();
      const syn = splitFilterValues(d.asset_synonyms).join(' ').toLowerCase();
      const idStr = String(d.drug_id || '').toLowerCase();
      if (!(name.includes(drugSearch) || altName.includes(drugSearch) || syn.includes(drugSearch) || idStr.includes(drugSearch))) return false;
    }
    if (ignoreKey !== 'phase' && drugSelection.phase && currentHub !== 'ADC' && String(d.highest_phase || '').trim() !== drugSelection.phase) return false;
    if (ignoreKey !== 'sponsor' && drugSelection.sponsor && getDrugSponsorName(d) !== drugSelection.sponsor) return false;
    if (ignoreKey !== 'status' && drugSelection.status && currentHub !== 'ADC') {
      const st = String(d.active_inactive || d.asset_status || '').trim();
      const phase = String(d.highest_phase || '').trim();
      if (st !== drugSelection.status && phase !== drugSelection.status) return false;
    }
    if (ignoreKey !== 'development' && drugSelection.development && currentHub === 'ADC' && String(d.development_status || '').trim() !== drugSelection.development) return false;
    if (ignoreKey !== 'payload' && drugSelection.payload && currentHub === 'ADC') {
      const payloads = splitFilterValues(d.payload);
      if (!payloads.includes(drugSelection.payload)) return false;
    }
    if (ignoreKey !== 'target' && drugSelection.target) {
      const targets = getDrugTargetValuesForFilter(d);
      if (!targets.includes(drugSelection.target)) return false;
    }
    if (ignoreKey !== 'tumor' && drugSelection.tumor) {
      const tumors = Array.from(drugTumorMap[d.drug_id] || []);
      if (!tumors.includes(drugSelection.tumor)) return false;
    }
    return true;
  };

  const matchesTrialForOptions = (t, ignoreKey) => {
    if (!t || getRecordHub(t) !== currentHub) return false;
    if (trialSearch) {
      const id = String(t.trial_identifier || '').toLowerCase();
      const title = String(t.trial_title || '').toLowerCase();
      const otherId = String(t.other_registry_trial_id || '').toLowerCase();
      if (!(id.includes(trialSearch) || title.includes(trialSearch) || otherId.includes(trialSearch))) return false;
    }
    const tumorValues = getTrialTumorValuesForFilter(t);
    if (ignoreKey !== 'condition' && trialSelection.condition && !tumorValues.includes(trialSelection.condition)) return false;
    if (ignoreKey !== 'phase' && trialSelection.phase && String(t.development_status || '').trim() !== trialSelection.phase) return false;
    if (ignoreKey !== 'sponsor' && trialSelection.sponsor && String(t.sponsor || '').trim() !== trialSelection.sponsor) return false;
    if (ignoreKey !== 'collaborator' && trialSelection.collaborator) {
      const collaboratorValues = [String(t.collaborator || '').trim(), String(t.sponsor || '').trim()].filter(Boolean);
      if (!collaboratorValues.includes(trialSelection.collaborator)) return false;
    }
    if (ignoreKey !== 'status' && trialSelection.status && String(t.recruitment_status || '').trim() !== trialSelection.status) return false;
    if (ignoreKey !== 'target' && trialSelection.target) {
      const linkedTargets = Array.from(drugTargetsById[t.asset_id] || []);
      if (!linkedTargets.includes(trialSelection.target)) return false;
    }
    if (ignoreKey !== 'tumor' && trialSelection.tumor && !tumorValues.includes(trialSelection.tumor)) return false;
    return true;
  };

  const buildOptions = (label, values) => {
    const sorted = Array.from(values).sort((a, b) => a.localeCompare(b));
    return `<option value="">${escapeHtml(label)}</option>` + sorted.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  };

  const applyOptions = (el, label, values, selectedValue) => {
    if (!el) return;
    const cleanedValues = new Set(Array.from(values).map(v => String(v || '').trim()).filter(Boolean));
    el.innerHTML = buildOptions(label, cleanedValues);
    if (selectedValue && cleanedValues.has(selectedValue)) {
      el.value = selectedValue;
    } else {
      el.value = '';
    }
  };

  const collectDrugValues = (ignoreKey, extractor) => {
    const out = new Set();
    hubDrugs.forEach(d => {
      if (!matchesDrugForOptions(d, ignoreKey)) return;
      const values = extractor(d);
      const list = Array.isArray(values) ? values : [values];
      list.forEach(v => {
        const x = String(v || '').trim();
        if (x) out.add(x);
      });
    });
    return out;
  };

  const collectTrialValues = (ignoreKey, extractor) => {
    const out = new Set();
    hubTrials.forEach(t => {
      if (!matchesTrialForOptions(t, ignoreKey)) return;
      const values = extractor(t);
      const list = Array.isArray(values) ? values : [values];
      list.forEach(v => {
        const x = String(v || '').trim();
        if (x) out.add(x);
      });
    });
    return out;
  };

  applyOptions(drugFilterSponsor, 'All Sponsors', collectDrugValues('sponsor', d => getDrugSponsorName(d)), prevDrugSponsor);
  applyOptions(drugFilterPhase, 'All Phases', collectDrugValues('phase', d => String(d.highest_phase || '').trim()), prevDrugPhase);
  applyOptions(drugFilterStatus, 'All Status', collectDrugValues('status', d => [String(d.active_inactive || d.asset_status || '').trim(), String(d.highest_phase || '').trim()]), prevDrugStatus);
  applyOptions(drugFilterDevelopment, 'All Development Status', collectDrugValues('development', d => String(d.development_status || '').trim()), prevDrugDevelopment);
  applyOptions(drugFilterPayload, 'All Payloads', collectDrugValues('payload', d => splitFilterValues(d.payload)), prevDrugPayload);
  applyOptions(drugFilterTarget, 'All Targets', collectDrugValues('target', d => getDrugTargetValuesForFilter(d)), prevDrugTarget);
  applyOptions(drugFilterTumor, 'All Tumors', collectDrugValues('tumor', d => Array.from(drugTumorMap[d.drug_id] || [])), prevDrugTumor);

  applyOptions(trialFilterCondition, 'All Conditions', collectTrialValues('condition', t => getTrialTumorValuesForFilter(t)), prevCondition);
  applyOptions(trialFilterPhase, 'All Phases', collectTrialValues('phase', t => String(t.development_status || '').trim()), prevTrialPhase);
  applyOptions(trialFilterSponsor, 'All Sponsors', collectTrialValues('sponsor', t => String(t.sponsor || '').trim()), prevTrialSponsor);
  applyOptions(trialFilterCollaborator, 'All Collaborators', collectTrialValues('collaborator', t => [String(t.collaborator || '').trim(), String(t.sponsor || '').trim()]), prevCollaborator);
  applyOptions(trialFilterStatus, 'All Status', collectTrialValues('status', t => String(t.recruitment_status || '').trim()), prevTrialStatus);
  applyOptions(trialFilterTarget, 'All Targets', collectTrialValues('target', t => Array.from(drugTargetsById[t.asset_id] || [])), prevTrialTarget);
  applyOptions(trialFilterTumor, 'All Tumors', collectTrialValues('tumor', t => getTrialTumorValuesForFilter(t)), prevTrialTumor);

  const allSponsors = new Set(hubCompanies.map(c => String(c.company_name || '').trim()).filter(Boolean));
  applyOptions(dashboardFilterSponsor, 'All Sponsors', allSponsors, prevDashSponsor);

  const allConditions = new Set();
  hubTrials.forEach(t => getTrialTumorValuesForFilter(t).forEach(v => allConditions.add(v)));
  applyOptions(dashboardFilterCondition, 'All Conditions', allConditions, prevDashCondition);

  const allPhases = new Set(hubTrials.map(t => String(t.development_status || '').trim()).filter(Boolean));
  applyOptions(dashboardFilterPhase, 'All Phases', allPhases, prevDashPhase);

  const allStatuses = new Set(hubTrials.map(t => String(t.recruitment_status || '').trim()).filter(Boolean));
  applyOptions(dashboardFilterStatus, 'All Status', allStatuses, prevDashStatus);

  const allDrugs = new Set(hubDrugs.map(d => getDrugDisplayName(d)).map(v => String(v || '').trim()).filter(Boolean));
  applyOptions(dashboardFilterDrug, 'All Drugs', allDrugs, prevDashDrug);

  if (currentHub === 'ADC') {
    if (drugFilterPhase) drugFilterPhase.style.display = 'none';
    if (drugFilterStatus) drugFilterStatus.style.display = 'none';
    if (drugFilterDevelopment) drugFilterDevelopment.style.display = '';
    if (drugFilterPayload) drugFilterPayload.style.display = '';
  } else {
    if (drugFilterPhase) drugFilterPhase.style.display = '';
    if (drugFilterStatus) drugFilterStatus.style.display = '';
    if (drugFilterDevelopment) drugFilterDevelopment.style.display = 'none';
    if (drugFilterPayload) drugFilterPayload.style.display = 'none';
  }

  // Restore filter selections when possible
  if (drugFilterSponsor) drugFilterSponsor.value = prevDrugSponsor;
  if (trialFilterSponsor) trialFilterSponsor.value = prevTrialSponsor;
  if (dashboardFilterSponsor) dashboardFilterSponsor.value = prevDashSponsor;
  if (drugFilterPhase) drugFilterPhase.value = prevDrugPhase;
  if (drugFilterStatus) drugFilterStatus.value = prevDrugStatus;
  if (drugFilterDevelopment) drugFilterDevelopment.value = prevDrugDevelopment;
  if (drugFilterPayload) drugFilterPayload.value = prevDrugPayload;
  if (trialFilterCondition) trialFilterCondition.value = prevCondition;
  if (dashboardFilterCondition) dashboardFilterCondition.value = prevDashCondition;
  if (trialFilterCollaborator) trialFilterCollaborator.value = prevCollaborator;
  if (drugFilterTarget) drugFilterTarget.value = prevDrugTarget;
  if (drugFilterTumor) drugFilterTumor.value = prevDrugTumor;
  if (trialFilterTarget) trialFilterTarget.value = prevTrialTarget;
  if (trialFilterTumor) trialFilterTumor.value = prevTrialTumor;
  if (dashboardFilterPhase) dashboardFilterPhase.value = prevDashPhase;
  if (dashboardFilterStatus) dashboardFilterStatus.value = prevDashStatus;
  if (dashboardFilterDrug) dashboardFilterDrug.value = prevDashDrug;

  // Update dashboard stats
  updateHubCardMetrics(drugs, trials);
  updateHubUi();

  // Render tables (will apply active filters)
  renderDrugs(hubDrugs, hubCompanies, hubTrials);
  renderTrials(hubTrials, hubDrugs);
  renderCompanies(hubCompanies);
  renderLogs(logs);
}

function setItemsPerPage(type, value) {
  const perPage = parseInt(value, 10) === 40 ? 40 : 20;
  if (type === 'drug') {
    itemsPerPageDrug = perPage;
    currentDrugPage = 1;
  } else {
    itemsPerPageTrial = perPage;
    currentTrialPage = 1;
  }
  refreshAllViews();
}

function renderRecentLogs(logs) {
  const recentLogsEl = document.getElementById('recentLogs');
  if (!recentLogsEl) return;
  const html = logs.map(l => `
    <div style="padding: 8px; border-bottom: 1px solid #e6eef8; font-size: 12px;">
      <strong>${l.action}</strong> - ${l.entityType} <br/>
      <small style="color: #64748b;">${l.timestamp} ${l.details ? '- ' + l.details : ''}</small>
    </div>
  `).join('');
  recentLogsEl.innerHTML = html || '<div style="padding: 8px; color: #64748b;">No activity</div>';
}

function renderCompanies(companies) {
  const tbody = document.getElementById('companiesList');
  if (!tbody) return; // Skip rendering if element doesn't exist (e.g., on home page)
  
  if (!companies.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #64748b;">No companies found</td></tr>';
    document.getElementById('companiesPagination').innerHTML = '';
    return;
  }
  const totalPages = Math.max(1, Math.ceil(companies.length / itemsPerPageCompany));
  currentCompanyPage = Math.min(currentCompanyPage, totalPages);
  const start = (currentCompanyPage - 1) * itemsPerPageCompany;
  const end = start + itemsPerPageCompany;
  const pageItems = companies.slice(start, end);

  tbody.innerHTML = pageItems.map(c => `
    <tr>
      <td>${c.company_id}</td>
      <td><button class="link-btn" onclick="openCompanyDetails(${c.company_id})">${escapeHtml(c.company_name || '')}</button></td>
      <td>${c.company_type || ''}</td>
      <td><button class="btn btn-sm btn-secondary" onclick="openCompanyDetails(${c.company_id})">View</button></td>
    </tr>
  `).join('');

  let paginationHtml = '';
  if (totalPages > 1) {
    paginationHtml = '<div class="pagination">';
    paginationHtml += `<button onclick="goToCompanyPage(${currentCompanyPage - 1})" ${currentCompanyPage === 1 ? 'disabled' : ''}>â† Previous</button>`;
    paginationHtml += `<span>Page ${currentCompanyPage} of ${totalPages}</span>`;
    paginationHtml += `<button onclick="goToCompanyPage(${currentCompanyPage + 1})" ${currentCompanyPage === totalPages ? 'disabled' : ''}>Next â†’</button>`;
    paginationHtml += '</div>';
  }
  document.getElementById('companiesPagination').innerHTML = paginationHtml;
}

function goToCompanyPage(page) {
  const totalPages = Math.max(1, Math.ceil(document.getElementById('companiesList').parentElement.parentElement.parentElement.querySelector('tbody').childElementCount / itemsPerPageCompany)) || 1;
  currentCompanyPage = Math.max(1, Math.min(page, totalPages));
  refreshAllViews();
}

function renderDrugs(drugs, companies, trials) {
  const tbody = document.getElementById('drugsList');
  if (!tbody) return;
  
  // Update table headers based on hub
  const HeadRow = document.getElementById('drugsTableHead');
  if (HeadRow) {
    if (currentHub === 'ADC') {
      HeadRow.innerHTML = `
        <tr>
          <th>ID</th>
          <th>Asset Name</th>
          <th>Product Name</th>
          <th>Company</th>
          <th>Conjugate Type</th>
          <th>Payload</th>
          <th>Target</th>
          <th>Linker</th>
          <th>DAR/Ratio</th>
          <th>Phase</th>
          <th>Details</th>
        </tr>
      `;
    } else {
      HeadRow.innerHTML = `
        <tr>
          <th>ID</th>
          <th>Product Name</th>
          <th>MOA</th>
          <th>Phase</th>
          <th>Sponsor</th>
          <th>Status</th>
          <th>Details</th>
        </tr>
      `;
    }
  }
  
  const companyMap = {};
  companies.forEach(c => companyMap[c.company_id] = c.company_name);
  // Apply filters
  const search = (document.getElementById('drugSearch')?.value || '').toString().toLowerCase().trim();
  const phaseFilter = (document.getElementById('drugFilterPhase')?.value || '').toString().trim();
  const sponsorFilter = (document.getElementById('drugFilterSponsor')?.value || '').toString().trim();
  const statusFilter = (document.getElementById('drugFilterStatus')?.value || '').toString().trim();
  const developmentFilter = (document.getElementById('drugFilterDevelopment')?.value || '').toString().trim();
  const payloadFilter = (document.getElementById('drugFilterPayload')?.value || '').toString().trim();
  const targetFilter = (document.getElementById('drugFilterTarget')?.value || '').toString().trim();
  const tumorFilter = (document.getElementById('drugFilterTumor')?.value || '').toString().trim();

  const drugTumorMap = {};
  (trials || []).forEach(t => {
    if (!t || !t.asset_id) return;
    if (!drugTumorMap[t.asset_id]) drugTumorMap[t.asset_id] = new Set();
    String(t.tumor_group || '').split(/[,;|]/).map(v => v.trim()).filter(Boolean).forEach(v => drugTumorMap[t.asset_id].add(v));
    if (Array.isArray(t.tumors)) {
      t.tumors.map(v => String(v || '').trim()).filter(Boolean).forEach(v => drugTumorMap[t.asset_id].add(v));
    }
  });

  const filtered = drugs.filter(d => {
    if (getRecordHub(d) !== currentHub) return false;
    if (search) {
      const name = (currentHub === 'ADC' ? (d.asset_name || '') : (d.product_name || '')).toString().toLowerCase();
      const altName = (currentHub === 'ADC' ? (d.product_name || '') : (d.asset_name || '')).toString().toLowerCase();
      const syn = (d.asset_synonyms || []).join(' ').toLowerCase();
      const idStr = String(d.drug_id || '').toLowerCase();
      if (!(name.includes(search) || altName.includes(search) || syn.includes(search) || idStr.includes(search))) return false;
    }
    if (phaseFilter && currentHub !== 'ADC') {
      if ((d.highest_phase || '').toString() !== phaseFilter) return false;
    }
    if (sponsorFilter) {
      const sponsorName = (companyMap[d.sponsor_id] || d.sponsor || '').toString().trim();
      if (sponsorName !== sponsorFilter) return false;
    }
    if (statusFilter && currentHub !== 'ADC') {
      const st = (d.active_inactive || d.asset_status || '').toString();
      if (st !== statusFilter && (d.highest_phase || '') !== statusFilter) return false;
    }
    if (developmentFilter && currentHub === 'ADC') {
      const dev = (d.development_status || '').toString().trim();
      if (dev !== developmentFilter) return false;
    }
    if (payloadFilter && currentHub === 'ADC') {
      const payloads = String(d.payload || '').split(/[,;|]/).map(v => v.trim()).filter(Boolean);
      if (!payloads.includes(payloadFilter)) return false;
    }
    if (targetFilter) {
      const targetValues = [];
      if (d.target) targetValues.push(d.target);
      if (d.combined_target_list) targetValues.push(d.combined_target_list);
      const splitTargets = targetValues.flatMap(v => String(v).split(/[,;|]/).map(x => x.trim()).filter(Boolean));
      const synTargets = Array.isArray(d.target_synonyms) ? d.target_synonyms.map(x => String(x || '').trim()).filter(Boolean) : [];
      if (![...splitTargets, ...synTargets].includes(targetFilter)) return false;
    }
    if (tumorFilter) {
      const drugTumors = Array.from(drugTumorMap[d.drug_id] || []);
      if (!drugTumors.includes(tumorFilter)) return false;
    }
    return true;
  });

  if (!filtered.length) {
    const colspan = currentHub === 'ADC' ? 11 : 7;
    tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: #64748b;">No drugs found</td></tr>`;
    document.getElementById('drugsAlert').innerHTML = '<div class="alert alert-info">No drugs match the current filters.</div>';
    document.getElementById('drugsPagination').innerHTML = '';
    return;
  }
  document.getElementById('drugsAlert').innerHTML = '';
  
  const filterKey = [search, phaseFilter, sponsorFilter, statusFilter, developmentFilter, payloadFilter, targetFilter, tumorFilter, currentHub].join('|');
  if (filterKey !== lastDrugFilterKey) {
    currentDrugPage = 1;
    lastDrugFilterKey = filterKey;
  }
  
  // Pagination
  const perPage = itemsPerPageDrug === Infinity ? filtered.length : itemsPerPageDrug;
  const totalPages = Math.max(1, Math.ceil(filtered.length / Math.max(1, perPage)));
  lastTrialTotalPages = totalPages;
  lastDrugTotalPages = totalPages;
  currentDrugPage = Math.min(currentDrugPage, totalPages);
  const start = (currentDrugPage - 1) * perPage;
  const end = start + perPage;
  const pageItems = filtered.slice(start, end);
  
  // Render hub-specific columns
  if (currentHub === 'ADC') {
    tbody.innerHTML = pageItems.map(d => `
      <tr>
        <td><a href="#" onclick="event.preventDefault();openDrugDetails(${d.drug_id})" style="color:#1e3a8a;text-decoration:none;font-weight:600">${d.drug_id}</a></td>
        <td><a href="#" onclick="event.preventDefault();openDrugDetails(${d.drug_id})" style="color:#1e3a8a;text-decoration:none;font-weight:600">${escapeHtml(d.asset_name || '')}</a></td>
        <td>${escapeHtml(d.product_name || '')}</td>
        <td>${escapeHtml(d.sponsor || companyMap[d.sponsor_id] || '')}</td>
        <td>${escapeHtml(d.conjugate_type || '')}</td>
        <td>${escapeHtml(d.payload || '')}</td>
        <td>${escapeHtml(d.target || '')}</td>
        <td>${escapeHtml(d.linker || '')}</td>
        <td>${escapeHtml(d.dar_loading_ratio || '')}</td>
        <td>${escapeHtml(d.highest_phase || 'N/A')}</td>
        <td><button class="btn btn-secondary btn-sm" onclick="openDrugDetails(${d.drug_id})">View</button></td>
      </tr>
    `).join('');
  } else {
    tbody.innerHTML = pageItems.map(d => `
      <tr>
        <td><a href="#" onclick="event.preventDefault();openDrugDetails(${d.drug_id})" style="color:#1e3a8a;text-decoration:none;font-weight:600">${d.drug_id}</a></td>
        <td><a href="#" onclick="event.preventDefault();openDrugDetails(${d.drug_id})" style="color:#1e3a8a;text-decoration:none;font-weight:600">${escapeHtml(d.product_name || '')}</a></td>
        <td>${escapeHtml(d.moa || '')}</td>
        <td><span class="badge">${escapeHtml(d.highest_phase || 'N/A')}</span></td>
        <td>${companyMap[d.sponsor_id] || ''}</td>
        <td>${escapeHtml(d.active_inactive || d.asset_status || 'Active')}</td>
        <td><button class="btn btn-secondary btn-sm" onclick="openDrugDetails(${d.drug_id})">View</button></td>
      </tr>
    `).join('');
  }
  
  // Render pagination controls (prev/next only)
  let paginationHtml = '';
  if (itemsPerPageDrug !== Infinity && totalPages > 1) {
    paginationHtml = '<div class="pagination">';
    paginationHtml += `<button onclick="goToDrugPage(${currentDrugPage - 1})" ${currentDrugPage === 1 ? 'disabled' : ''}>â† Previous</button>`;
    paginationHtml += `<span>Page ${currentDrugPage} of ${totalPages}</span>`;
    paginationHtml += `<button onclick="goToDrugPage(${currentDrugPage + 1})" ${currentDrugPage === totalPages ? 'disabled' : ''}>Next â†’</button>`;
    paginationHtml += `<select onchange="setItemsPerPage('drug', this.value)" style="padding:6px 8px;border:1px solid #e6eef8;border-radius:6px;background:white;font-size:12px;">
      <option value="20" ${itemsPerPageDrug === 20 ? 'selected' : ''}>20 rows</option>
      <option value="40" ${itemsPerPageDrug === 40 ? 'selected' : ''}>40 rows</option>
    </select>`;
    paginationHtml += '</div>';
  }
  document.getElementById('drugsPagination').innerHTML = paginationHtml;
}

function goToDrugPage(page) {
  const tbody = document.getElementById('drugsList');
  if (!tbody) return;
  const totalPages = Math.max(1, lastDrugTotalPages || 1);
  currentDrugPage = Math.max(1, Math.min(page, totalPages));
  refreshAllViews();
}

function renderTrials(trials, drugs) {
  const tbody = document.getElementById('trialsList');
  if (!tbody) return; // Skip rendering if element doesn't exist (e.g., on home page)
  
  const drugMap = {};
  drugs.forEach(d => drugMap[d.drug_id] = getDrugDisplayName(d));
  // Apply filters
  const search = (document.getElementById('trialSearch')?.value || '').toString().toLowerCase().trim();
  const conditionFilter = (document.getElementById('trialFilterCondition')?.value || '').toString().trim();
  const phaseFilter = (document.getElementById('trialFilterPhase')?.value || '').toString().trim();
  const sponsorFilter = (document.getElementById('trialFilterSponsor')?.value || '').toString().trim();
  const collaboratorFilter = (document.getElementById('trialFilterCollaborator')?.value || '').toString().trim();
  const statusFilter = (document.getElementById('trialFilterStatus')?.value || '').toString().trim();
  const targetFilter = (document.getElementById('trialFilterTarget')?.value || '').toString().trim();
  const tumorFilter = (document.getElementById('trialFilterTumor')?.value || '').toString().trim();

  const drugTargetById = {};
  drugs.forEach(d => {
    const values = [];
    if (d.target) values.push(d.target);
    if (d.combined_target_list) values.push(d.combined_target_list);
    const splitValues = values.flatMap(v => String(v).split(/[,;|]/).map(x => x.trim()).filter(Boolean));
    const synValues = Array.isArray(d.target_synonyms) ? d.target_synonyms.map(x => String(x || '').trim()).filter(Boolean) : [];
    drugTargetById[d.drug_id] = new Set([...splitValues, ...synValues]);
  });

  const filtered = trials.filter(t => {
    if (getRecordHub(t) !== currentHub) return false;
    if (search) {
      const id = (t.trial_identifier || '').toString().toLowerCase();
      const title = (t.trial_title || '').toString().toLowerCase();
      const otherId = (t.other_registry_trial_id || '').toString().toLowerCase();
      if (!(id.includes(search) || title.includes(search) || otherId.includes(search))) return false;
    }
    if (conditionFilter) {
      const tg = (t.tumor_group || '').toString().trim();
      const tgValues = tg ? tg.split(/[,;|]/).map(v => v.trim()).filter(Boolean) : [];
      const tumors = (t.tumors || []).map(tu => tu.toString().trim());
      if (!tumors.includes(conditionFilter) && !tgValues.includes(conditionFilter)) return false;
    }
    if (phaseFilter) {
      const dev = (t.development_status || '').toString();
      if (dev !== phaseFilter) return false;
    }
    if (sponsorFilter) {
      const s = (t.sponsor || '').toString();
      if (s !== sponsorFilter) return false;
    }
    if (collaboratorFilter) {
      const c = (t.collaborator || '').toString().trim();
      const s = (t.sponsor || '').toString().trim();
      if (c !== collaboratorFilter && s !== collaboratorFilter) return false;
    }
    if (statusFilter) {
      const dev = (t.recruitment_status || '').toString();
      if (dev !== statusFilter) return false;
    }
    if (targetFilter) {
      const linkedTargets = Array.from(drugTargetById[t.asset_id] || []);
      if (!linkedTargets.includes(targetFilter)) return false;
    }
    if (tumorFilter) {
      const tg = (t.tumor_group || '').toString().trim();
      const tgValues = tg ? tg.split(/[,;|]/).map(v => v.trim()).filter(Boolean) : [];
      const tumors = (t.tumors || []).map(tu => tu.toString().trim());
      if (!tumors.includes(tumorFilter) && !tgValues.includes(tumorFilter)) return false;
    }
    return true;
  });

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">No trials found</td></tr>';
    document.getElementById('trialsAlert').innerHTML = '<div class="alert alert-info">No trials match the current filters.</div>';
    document.getElementById('trialsPagination').innerHTML = '';
    return;
  }
  document.getElementById('trialsAlert').innerHTML = '';
  
  const filterKey = [search, conditionFilter, phaseFilter, sponsorFilter, collaboratorFilter, statusFilter, targetFilter, tumorFilter].join('|');
  if (filterKey !== lastTrialFilterKey) {
    currentTrialPage = 1;
    lastTrialFilterKey = filterKey;
  }
  
  // Pagination
  const perPage = itemsPerPageTrial === Infinity ? filtered.length : itemsPerPageTrial;
  const totalPages = Math.max(1, Math.ceil(filtered.length / Math.max(1, perPage)));
  currentTrialPage = Math.min(currentTrialPage, totalPages);
  const start = (currentTrialPage - 1) * perPage;
  const end = start + perPage;
  const pageItems = filtered.slice(start, end);
  
  tbody.innerHTML = pageItems.map(t => {
    const indication = (t.tumors && t.tumors.length) ? t.tumors.join('; ') : (t.tumor_group || '');
    return `
    <tr>
      <td><a href="#" onclick="event.preventDefault();openTrialDetails(${t.trial_id})" style="color:#1e3a8a;text-decoration:none;font-weight:600">${t.trial_id}</a></td>
      <td><a href="#" onclick="event.preventDefault();openTrialDetails(${t.trial_id})" style="color:#1e3a8a;text-decoration:none;font-weight:600">${escapeHtml(t.trial_identifier || '')}</a></td>
      <td>${escapeHtml(indication)}</td>
      <td>${drugMap[t.asset_id] || 'N/A'}</td>
      <td><span class="badge-success">${escapeHtml(t.development_status || 'Unknown')}</span></td>
      <td><button class="btn btn-secondary btn-sm" onclick="openTrialDetails(${t.trial_id})">View</button></td>
    </tr>
  `;
  }).join('');
  
  // Render pagination controls (prev/next only)
  let paginationHtml = '';
  if (itemsPerPageTrial !== Infinity && totalPages > 1) {
    paginationHtml = '<div class="pagination">';
    paginationHtml += `<button onclick="goToTrialPage(${currentTrialPage - 1})" ${currentTrialPage === 1 ? 'disabled' : ''}>â† Previous</button>`;
    paginationHtml += `<span>Page ${currentTrialPage} of ${totalPages}</span>`;
    paginationHtml += `<button onclick="goToTrialPage(${currentTrialPage + 1})" ${currentTrialPage === totalPages ? 'disabled' : ''}>Next â†’</button>`;
    paginationHtml += `<select onchange="setItemsPerPage('trial', this.value)" style="padding:6px 8px;border:1px solid #e6eef8;border-radius:6px;background:white;font-size:12px;">
      <option value="20" ${itemsPerPageTrial === 20 ? 'selected' : ''}>20 rows</option>
      <option value="40" ${itemsPerPageTrial === 40 ? 'selected' : ''}>40 rows</option>
    </select>`;
    paginationHtml += '</div>';
  }
  document.getElementById('trialsPagination').innerHTML = paginationHtml;
}

function goToTrialPage(page) {
  const tbody = document.getElementById('trialsList');
  if (!tbody) return;
  const totalPages = Math.max(1, lastTrialTotalPages || 1);
  currentTrialPage = Math.max(1, Math.min(page, totalPages));
  refreshAllViews();
}

function renderLogs(logs) {
  const tbody = document.getElementById('logsList');
  if (!tbody) return; // Skip rendering if element doesn't exist (e.g., on home page)
  
  if (!logs.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #64748b;">No logs</td></tr>';
    return;
  }
  tbody.innerHTML = logs.slice().reverse().map(l => `
    <tr>
      <td style="font-size: 12px;">${l.timestamp}</td>
      <td><strong>${l.action}</strong></td>
      <td>${l.entityType}</td>
      <td style="font-size: 12px;">${escapeHtml(l.details || '')}</td>
    </tr>
  `).join('');
}

function clearDrugFilters(){
  const s = document.getElementById('drugSearch'); if(s) s.value = '';
  const p = document.getElementById('drugFilterPhase'); if(p) p.value = '';
  const sp = document.getElementById('drugFilterSponsor'); if(sp) sp.value = '';
  const st = document.getElementById('drugFilterStatus'); if(st) st.value = '';
  const dv = document.getElementById('drugFilterDevelopment'); if(dv) dv.value = '';
  const pl = document.getElementById('drugFilterPayload'); if(pl) pl.value = '';
  const tg = document.getElementById('drugFilterTarget'); if(tg) tg.value = '';
  const tu = document.getElementById('drugFilterTumor'); if(tu) tu.value = '';
  refreshAllViews();
}

function clearTrialFilters(){
  const s = document.getElementById('trialSearch'); if(s) s.value = '';
  const c = document.getElementById('trialFilterCondition'); if(c) c.value = '';
  const p = document.getElementById('trialFilterPhase'); if(p) p.value = '';
  const sp = document.getElementById('trialFilterSponsor'); if(sp) sp.value = '';
  const col = document.getElementById('trialFilterCollaborator'); if(col) col.value = '';
  const st = document.getElementById('trialFilterStatus'); if(st) st.value = '';
  const tg = document.getElementById('trialFilterTarget'); if(tg) tg.value = '';
  const tu = document.getElementById('trialFilterTumor'); if(tu) tu.value = '';
  refreshAllViews();
}

async function updateDashboardStats() {
  // This function updates dashboard-specific statistics
  // It's used to refresh dashboard views when filters change
  await updateHubDashboard();
}

async function updateHubDashboard() {
  const drugs = await getAllRecords('drugs');
  const trials = await getAllRecords('trials');
  const companies = await getAllRecords('companies');
  const regNews = await getAllRecords('regulatory_announcements');
  
  const hubDrugs = drugs.filter(d => getRecordHub(d) === currentHub);
  const hubTrials = trials.filter(t => getRecordHub(t) === currentHub);
  const hubCompanies = companies.filter(c => getRecordHub(c) === currentHub);
  
  // Update dashboard cards
  const drugsEl = document.getElementById('dashDrugsCount');
  const trialsEl = document.getElementById('dashTrialsCount');
  const companiesEl = document.getElementById('dashCompaniesCount');
  
  if (drugsEl) drugsEl.textContent = hubDrugs.length;
  if (trialsEl) trialsEl.textContent = hubTrials.length;
  if (companiesEl) companiesEl.textContent = hubCompanies.length;
  
  // Extract and display regulatory news
  const hubNewsItems = regNews.filter(n => normalizeHub(n.hub) === currentHub);
  const sortedNews = hubNewsItems.slice().sort((a, b) => {
    const da = new Date(a.news_date || a.created_at || 0).getTime();
    const db = new Date(b.news_date || b.created_at || 0).getTime();
    return db - da;
  });
  
  // Display top news
  const newsList = document.getElementById('dashRegulatoryNews');
  if (!newsList) return;
  
  if (sortedNews.length === 0) {
    newsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No regulatory updates available yet</div>';
  } else {
    newsList.innerHTML = sortedNews.slice(0, 5).map(item => {
      const logo = item.company_logo
        ? `<img src="${escapeHtml(item.company_logo)}" alt="Logo" class="dash-news-logo" />`
        : `<div class="dash-news-logo" style="display:flex;align-items:center;justify-content:center;font-size:11px;color:#64748b;">N/A</div>`;
      const dateText = item.news_date ? `<div class="dash-news-meta">${escapeHtml(item.news_date)}</div>` : '';
      return `
        <div class="dash-news-item" onclick="openRegulatoryNewsModal(${item.news_id})">
          ${logo}
          <div>
            <div class="dash-news-title">${escapeHtml(item.title)}</div>
            ${dateText}
          </div>
        </div>
      `;
    }).join('');
  }
}

function updateHubCardMetrics(drugs, trials) {
  const getTargets = (items) => {
    const s = new Set();
    items.forEach(d => {
      const vals = String(d.target || '').split(/[,;|]/).map(v => v.trim()).filter(Boolean);
      vals.forEach(v => s.add(v));
    });
    return s.size;
  };
  const getMoas = (items) => {
    const s = new Set();
    items.forEach(d => {
      const vals = String(d.moa || '').split(/[,;|]/).map(v => v.trim()).filter(Boolean);
      vals.forEach(v => s.add(v));
    });
    return s.size;
  };
  const getIndications = (items) => {
    const s = new Set();
    items.forEach(t => {
      const tg = String(t.tumor_group || '').split(/[,;|]/).map(v => v.trim()).filter(Boolean);
      tg.forEach(v => s.add(v));
      if (Array.isArray(t.tumors)) t.tumors.forEach(v => { if (v) s.add(String(v).trim()); });
    });
    return s.size;
  };
  const getRegulatoryNews = (items) => {
    return items.filter(d => {
      const regNews = d.regulatory_news || d.regulatory_designation || '';
      return regNews && String(regNews).trim().length > 0;
    }).length;
  };

  const adcDrugs = drugs.filter(d => getRecordHub(d) === 'ADC');
  const adcTrials = trials.filter(t => getRecordHub(t) === 'ADC');
  const ioDrugs = drugs.filter(d => getRecordHub(d) === 'IO');
  const ioTrials = trials.filter(t => getRecordHub(t) === 'IO');
  const cpDrugs = drugs.filter(d => getRecordHub(d) === 'CHECKPOINT');
  const cpTrials = trials.filter(t => getRecordHub(t) === 'CHECKPOINT');

  const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
  setText('hubAdcDrugs', adcDrugs.length);
  setText('hubAdcTrials', adcTrials.length);
  setText('hubAdcTargets', getTargets(adcDrugs));
  setText('hubAdcRegNews', getRegulatoryNews(adcDrugs.concat(adcTrials)));
  setText('hubIoDrugs', ioDrugs.length);
  setText('hubIoTrials', ioTrials.length);
  setText('hubIoMoas', getMoas(ioDrugs));
  setText('hubIoRegNews', getRegulatoryNews(ioDrugs.concat(ioTrials)));
  setText('hubCheckpointDrugs', cpDrugs.length);
  setText('hubCheckpointTrials', cpTrials.length);
  setText('hubCheckpointIndications', getIndications(cpTrials));
  setText('hubCheckpointRegNews', getRegulatoryNews(cpDrugs.concat(cpTrials)));
}

function clearDashboardFilters(){
  const sp = document.getElementById('dashboardFilterSponsor'); if(sp) sp.value = '';
  const c = document.getElementById('dashboardFilterCondition'); if(c) c.value = '';
  const ph = document.getElementById('dashboardFilterPhase'); if(ph) ph.value = '';
  const st = document.getElementById('dashboardFilterStatus'); if(st) st.value = '';
  const d = document.getElementById('dashboardFilterDrug'); if(d) d.value = '';
  updateDashboardStats().catch(err => console.error('Error updating dashboard:', err));
}

// ============ Modal Control ============
function closeAllModals() {
  const drugDetailsModal = document.getElementById('drugDetailsModal');
  if (drugDetailsModal) drugDetailsModal.classList.remove('show');
  const trialDetailsModal = document.getElementById('trialDetailsModal');
  if (trialDetailsModal) trialDetailsModal.classList.remove('show');
  const companyModal = document.getElementById('companyModal');
  if (companyModal) companyModal.classList.remove('show');
  const companyDetailsModal = document.getElementById('companyDetailsModal');
  if (companyDetailsModal) companyDetailsModal.classList.remove('show');
  const regulatoryNewsModal = document.getElementById('regulatoryNewsModal');
  if (regulatoryNewsModal) regulatoryNewsModal.classList.remove('show');
}

function switchTab(e, tabName) {
  e.preventDefault();
  activateTab(tabName);
}

function activateTab(tabName) {
  // Hide all tabs and nav-tabs first
  document.querySelectorAll('.tab-content').forEach(el => {
    el.classList.remove('active');
    el.style.display = 'none';
  });
  
  document.querySelectorAll('.nav-tab').forEach(el => {
    el.classList.remove('active');
  });
  
  document.querySelectorAll('.hub-dashboard').forEach(el => {
    el.classList.remove('active');
  });
  const navTabs = document.querySelector('.nav-tabs');
  const inHubMode = !!(navTabs && !navTabs.classList.contains('hidden'));
  
  // Show the selected tab
  const tab = document.getElementById(tabName);
  if (tab) {
    tab.classList.add('active');
    tab.style.display = 'block';
    
    // If this is the dashboard tab, also activate the hub-dashboard child
    if (tabName === 'dashboard' && inHubMode) {
      const hubDash = tab.querySelector('.hub-dashboard');
      if (hubDash) {
        hubDash.classList.add('active');
        hubDash.style.display = 'block';
      }
      // Update dashboard stats when switching to dashboard tab
      updateHubDashboard();
    } else if (tabName === 'dashboard') {
      const hubDash = tab.querySelector('.hub-dashboard');
      if (hubDash) {
        hubDash.classList.remove('active');
        hubDash.style.display = 'none';
      }
    }
  }
  
  // Highlight the corresponding nav-tab
  const nav = Array.from(document.querySelectorAll('.nav-tab'))
    .find(el => (el.getAttribute('onclick') || '').indexOf(`'${tabName}'`) !== -1);
  if (nav) {
    nav.classList.add('active');
  }

  try { localStorage.setItem('dklinity.activeTab', tabName); } catch (e) {}
  
  // Update mapping tab display if switching to mapping tab
  if (tabName === 'mapping') {
    updateMappingTabUI();
  }
}

function updateMappingTabUI() {
  const hubDrugFields = HUB_DRUG_FIELDS[currentHub] || HUB_DRUG_FIELDS.IO;
  const hubTrialFields = HUB_TRIAL_FIELDS[currentHub] || HUB_TRIAL_FIELDS.IO;
  
  // Update hub name
  const hubNameEl = document.getElementById('mappingHubName');
  if (hubNameEl) hubNameEl.textContent = currentHub;
  
  // Display drug fields
  const drugFieldsEl = document.getElementById('mappingDrugFields');
  if (drugFieldsEl) {
    drugFieldsEl.innerHTML = hubDrugFields.map(field => 
      `<div style="padding:8px;background:#fff;border:1px solid #e6eef8;border-radius:6px;font-size:12px;font-weight:600;color:#1e3a8a">${field}</div>`
    ).join('');
  }
  
  // Display trial fields
  const trialFieldsEl = document.getElementById('mappingTrialFields');
  if (trialFieldsEl) {
    trialFieldsEl.innerHTML = hubTrialFields.map(field => 
      `<div style="padding:8px;background:#fff;border:1px solid #e6eef8;border-radius:6px;font-size:12px;font-weight:600;color:#1e3a8a">${field}</div>`
    ).join('');
  }
}

// ============ Company Management ============
function openCompanyModal(companyId = null) {
  const isEdit = companyId !== null;
  
  // Update modal title
  document.getElementById('companyModalTitle').textContent = isEdit ? 'Edit Company' : 'Create New Company';
  
  let html = `
    <div class="form-grid">
      <div class="form-group">
        <label>Company Name *</label>
        <input type="text" id="companyName" placeholder="e.g., Pfizer Inc." />
      </div>
      <div class="form-group">
        <label>Company Type</label>
        <select id="companyType">
          <option value="Pharmaceutical">Pharmaceutical</option>
          <option value="Biotech">Biotech</option>
          <option value="CRO">CRO</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Company Logo URL</label>
        <input type="text" id="companyLogo" placeholder="https://..." />
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" onclick="closeAllModals()">Cancel</button>
      <button class="btn btn-success" onclick="saveCompany(${companyId || 'null'})">${isEdit ? 'Update' : 'Create'} Company</button>
    </div>
  `;

  if (isEdit) {
    getAllRecords('companies').then(companies => {
      const company = companies.find(c => c.company_id === companyId);
      if (company) {
        document.getElementById('companyName').value = company.company_name || '';
        document.getElementById('companyType').value = company.company_type || 'Pharmaceutical';
        document.getElementById('companyLogo').value = company.company_logo || '';
      }
    });
  }

  document.getElementById('companyFormContainer').innerHTML = html;
  document.getElementById('companyModal').classList.add('show');
}

async function saveCompany(companyId) {
  const name = document.getElementById('companyName').value.trim();
  const type = document.getElementById('companyType').value;

  if (!name) {
    alert('Company name is required');
    return;
  }

  let hubValue = normalizeHub(currentHub);
  if (companyId !== null && companyId !== 'null') {
    const companies = await getAllRecords('companies');
    const existing = companies.find(c => c.company_id === companyId);
    if (existing?.hub) hubValue = normalizeHub(existing.hub);
  }

  const logo = document.getElementById('companyLogo')?.value.trim() || '';
  const data = { company_name: name, company_type: type, company_logo: logo, hub: hubValue };

  if (companyId !== null && companyId !== 'null') {
    data.company_id = companyId;
    await putRecord('companies', data);
    await addLog('UPDATE', 'Company', name);
  } else {
    data.created_at = new Date().toISOString();
    await addRecord('companies', data);
    await addLog('CREATE', 'Company', name);
  }

  closeAllModals();
  await refreshAllViews();
}

async function editCompany(companyId) {
  openCompanyModal(companyId);
}

async function openCompanyDetails(companyId) {
  const [companies, drugs, trials] = await Promise.all([
    getAllRecords('companies'),
    getAllRecords('drugs'),
    getAllRecords('trials')
  ]);

  const company = companies.find(c => c.company_id === companyId);
  if (!company) return;

  const companyHub = getRecordHub(company) || currentHub;
  const companyName = company.company_name || '';
  const nameKey = companyName.toLowerCase().trim();

  const companyDrugs = drugs.filter(d => {
    const dHub = getRecordHub(d) || 'IO';
    if (dHub !== companyHub) return false;
    const sponsorMatch = (d.sponsor || '').toString().toLowerCase().trim() === nameKey;
    const sponsorIdMatch = d.sponsor_id === companyId;
    return sponsorIdMatch || sponsorMatch;
  });

  const companyTrials = trials.filter(t => {
    const tHub = getRecordHub(t) || 'IO';
    if (tHub !== companyHub) return false;
    return companyDrugs.some(d => d.drug_id === t.asset_id);
  });

  const assets = companyDrugs.map(d => ({
    name: getDrugDisplayName(d),
    highest_phase: d.highest_phase || '',
    development_status: d.development_status || '',
    asset_status: d.asset_status || '',
    sales_millions: d.sales_millions
  }));

  const totalSales = companyDrugs.reduce((sum, d) => {
    const val = typeof d.sales_millions === 'number' ? d.sales_millions : parseFloat(d.sales_millions);
    return sum + (isNaN(val) ? 0 : val);
  }, 0);

  const indicationsByDrug = companyDrugs.map(d => {
    const relatedTrials = companyTrials.filter(t => t.asset_id === d.drug_id);
    const indications = new Set();
    relatedTrials.forEach(t => {
      const tumors = Array.isArray(t.tumors) ? t.tumors : (t.tumors ? String(t.tumors).split(/[,;|]/) : []);
      const tumorGroup = t.tumor_group || '';
      const tumorGroupValues = Array.isArray(t.tumor_group_values) ? t.tumor_group_values : [];
      [tumorGroup, ...tumorGroupValues, ...tumors].forEach(val => {
        const v = String(val || '').trim();
        if (v) indications.add(v);
      });
    });
    return { name: getDrugDisplayName(d), indications: Array.from(indications) };
  });

  const newsItems = [];
  companyDrugs.forEach(d => {
    const reg = splitSources(d.news_regulatory || '');
    const comm = splitSources(d.news_commercial || '');
    reg.forEach(n => newsItems.push(`Regulatory: ${n}`));
    comm.forEach(n => newsItems.push(`Commercial: ${n}`));
  });
  const uniqueNews = Array.from(new Set(newsItems)).filter(Boolean);

  const initials = companyName
    .split(' ')
    .filter(Boolean)
    .slice(0, 2)
    .map(w => w[0].toUpperCase())
    .join('') || 'CO';

  const logoUrl = (company.company_logo || '').toString().trim();
  const logoHtml = logoUrl && isUrl(logoUrl)
    ? `<img src="${escapeHtml(logoUrl)}" alt="${escapeHtml(companyName)} logo" class="company-logo" />`
    : `<div class="company-logo-placeholder">${escapeHtml(initials)}</div>`;

  let html = `
    <div class="company-hero">
      ${logoHtml}
      <div>
        <h3 class="company-name">${escapeHtml(companyName)}</h3>
        <div class="company-meta">${escapeHtml(company.company_type || 'Pharmaceutical')} | ${escapeHtml(companyHub)} Hub</div>
      </div>
    </div>
    <div class="sub-tabs" style="margin-top:4px">
      <button class="sub-tab active" onclick="switchCompanyDetailsTab('overview')">Overview</button>
      <button class="sub-tab" onclick="switchCompanyDetailsTab('assets')">Assets</button>
      <button class="sub-tab" onclick="switchCompanyDetailsTab('indications')">Indications</button>
      <button class="sub-tab" onclick="switchCompanyDetailsTab('trials')">Trials</button>
      <button class="sub-tab" onclick="switchCompanyDetailsTab('news')">News</button>
    </div>

    <div class="tab-pane active" id="company-tab-overview">
      <div class="company-section">
        <div class="company-section-title">Company Pipeline</div>
        <div class="company-card">
          <div style="font-size:12px;color:#475569">Auto-search link for pipeline details:</div>
          <div style="margin-top:6px">${createGoogleSearchLink(`${companyName} pipeline`)}</div>
        </div>
      </div>
    </div>

    <div class="tab-pane" id="company-tab-assets">
      <div class="company-section">
        <div class="company-section-title">Assets</div>
        <div class="company-card">
          <table class="company-asset-table">
            <thead>
              <tr>
                <th>Asset</th>
                <th>Highest Phase</th>
                <th>Development Status</th>
                <th>Asset Status</th>
                <th>Sales ($M)</th>
              </tr>
            </thead>
            <tbody>
              ${assets.length ? assets.map(a => `
                <tr>
                  <td>${escapeHtml(a.name || '')}</td>
                  <td>${escapeHtml(a.highest_phase || '')}</td>
                  <td>${escapeHtml(a.development_status || '')}</td>
                  <td>${escapeHtml(a.asset_status || '')}</td>
                  <td>${(typeof a.sales_millions === 'number' || String(a.sales_millions || '').trim() !== '') ? escapeHtml(String(a.sales_millions)) : ''}</td>
                </tr>
              `).join('') : '<tr><td colspan="5" style="color:#94a3b8">No assets found</td></tr>'}
            </tbody>
            ${assets.length ? `<tfoot><tr><td colspan="4" style="text-align:right;font-weight:800;color:#1e3a8a">Total Sales ($M)</td><td style="font-weight:800;color:#1e3a8a">${escapeHtml(String(totalSales.toFixed(2)))}</td></tr></tfoot>` : ''}
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane" id="company-tab-indications">
      <div class="company-section">
        <div class="company-section-title">Disease Indications</div>
        <div class="company-grid">
          ${indicationsByDrug.length ? indicationsByDrug.map(d => `
            <div class="company-card">
              <div class="company-card-title">${escapeHtml(d.name)}</div>
              <div class="company-list">
                ${d.indications.length ? d.indications.map(i => `<div class="company-list-item">${escapeHtml(i)}</div>`).join('') : '<div class="company-list-item" style="color:#94a3b8">No indications</div>'}
              </div>
            </div>
          `).join('') : '<div class="company-card" style="color:#94a3b8">No indications found</div>'}
        </div>
      </div>
    </div>

    <div class="tab-pane" id="company-tab-trials">
      <div class="company-section">
        <div class="company-section-title">Associated Trials</div>
        <div class="company-card">
          <table class="company-asset-table">
            <thead>
              <tr>
                <th>Trial ID</th>
                <th>Title</th>
                <th>Development Status</th>
                <th>Recruitment Status</th>
                <th>View</th>
              </tr>
            </thead>
            <tbody>
              ${companyTrials.length ? companyTrials.map(t => `
                <tr>
                  <td>${escapeHtml(String(t.trial_identifier || ''))}</td>
                  <td>${escapeHtml(String(t.trial_title || ''))}</td>
                  <td>${escapeHtml(String(t.development_status || ''))}</td>
                  <td>${escapeHtml(String(t.recruitment_status || ''))}</td>
                  <td><button class="btn btn-sm btn-secondary" onclick="openTrialDetails(${t.trial_id})">View</button></td>
                </tr>
              `).join('') : '<tr><td colspan="5" style="color:#94a3b8">No trials found</td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-pane" id="company-tab-news">
      <div class="company-section">
        <div class="company-section-title">Company News</div>
        <div class="company-card">
          <div class="company-list">
            ${uniqueNews.length ? uniqueNews.map(n => `<div class="company-list-item">${escapeHtml(n)}</div>`).join('') : '<div class="company-list-item" style="color:#94a3b8">No news found</div>'}
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('companyDetailsTitle').textContent = `Company Profile: ${companyName || company.company_id}`;
  document.getElementById('companyDetailsContainer').innerHTML = html;
  document.getElementById('companyDetailsModal').classList.add('show');

  window.switchCompanyDetailsTab = function(tabId) {
    document.querySelectorAll('#companyDetailsContainer .sub-tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('#companyDetailsContainer .tab-pane').forEach(p => p.classList.remove('active'));
    const btn = Array.from(document.querySelectorAll('#companyDetailsContainer .sub-tab')).find(b => (b.getAttribute('onclick') || '').includes(`'${tabId}'`));
    const pane = document.getElementById('company-tab-' + tabId);
    if (btn) btn.classList.add('active');
    if (pane) pane.classList.add('active');
  };
}

async function deleteCompany(companyId) {
  if (confirm('Are you sure you want to delete this company?')) {
    await deleteRecord('companies', companyId);
    await addLog('DELETE', 'Company', `ID ${companyId}`);
    await refreshAllViews();
  }
}

const TRIAL_ROW_SECTIONS = [
  {
    title: 'Summary',
    fields: [
      { key: 'hub', label: 'Dklinity Hub' },
      { key: 'trial_identifier', label: 'Trial Identifier' },
      { key: 'trial_title', label: 'Trial Title' },
      { key: 'trial_acronym', label: 'Trial Acronym' },
      { key: 'other_registry_trial_id', label: 'Other Registry Trial ID' },
      { key: 'trial_design', label: 'Trial Design' },
      { key: 'development_status', label: 'Development Status' },
      { key: 'recruitment_status', label: 'Recruitment Status' },
      { key: 'registrational', label: 'Registrational' },
      { key: 'tumor_group', label: 'Tumor Group' },
      { key: 'tumors', label: 'Tumor/Condition' },
      { key: 'mutation_biomarker', label: 'Mutation/Biomarker' },
      { key: 'patient_age_group', label: 'Patient Age Group' },
      { key: 'patient_number', label: 'Patient Number (N)' },
      { key: 'study_start_date', label: 'Study Start Date' },
      { key: 'primary_completion_date', label: 'Primary Completion Date' },
      { key: 'study_completion_date', label: 'Study Completion Date' },
      { key: 'stage', label: 'Stage' },
      { key: 'line_of_therapy', label: 'Line of Therapy' },
      { key: 'mutations', label: 'Mutations' },
      { key: 'prospective_biomarkers', label: 'Biomarkers' },
      { key: 'dx_assay', label: 'Dx Assay' },
      { key: 'dx_cutoff_value', label: 'Dx Cutoff Value' },
      { key: 'sponsor', label: 'Sponsor' },
      { key: 'collaborator', label: 'Collaborator' },
      { key: 'location', label: 'Location' },
      { key: 'region', label: 'Region' },
      { key: 'clinical_failure', label: 'Clinical Failure' },
      { key: 'trials_with_results', label: 'Trials With Results' }
    ]
  },
  {
    title: 'Arms & Regimen',
    fields: [
      { key: 'mono_combo', label: 'Mono/Combo' },
      { key: 'regimens', label: 'Regimen/Dosing' },
      { key: 'regimen_moa', label: 'Regimen MoA' },
      { key: 'comparator_arm', label: 'Comparator Arm' }
    ]
  },
  {
    title: 'Outcomes',
    fields: [
      { key: 'primary_endpoint', label: 'Primary Endpoint' },
      { key: 'secondary_endpoint', label: 'Secondary Endpoint' }
    ]
  },
  {
    title: 'Inclusion / Exclusion',
    fields: [
      { key: 'included_based_on_prior', label: 'Included Prior Tx' },
      { key: 'excluded_based_on_prior', label: 'Excluded Prior Tx' },
      { key: 'patients_brain_cns_mets', label: 'Brain/CNS Mets' }
    ]
  },
  {
    title: 'Efficacy',
    fields: [
      { key: 'efficacy_evaluable', label: 'Evaluable Patients' },
      { key: 'data_review_committee', label: 'Data Review Committee' },
      { key: 'orr', label: 'ORR (%)' },
      { key: 'dcr', label: 'DCR (%)' },
      { key: 'cr', label: 'CR (%)' },
      { key: 'pr', label: 'PR (%)' },
      { key: 'sd', label: 'SD (%)' },
      { key: 'pd', label: 'PD (%)' },
      { key: 'mdor_months', label: 'mDoR (months)' },
      { key: 'pfs_months', label: 'PFS (months)' },
      { key: 'mpfs_months', label: 'mPFS (months)' },
      { key: 'os_months', label: 'OS (months)' },
      { key: 'mos_months', label: 'mOS (months)' },
      { key: 'os_percent', label: 'OS (%Pts)' },
      { key: 'dfs', label: 'DFS' },
      { key: 'mdfs_months', label: 'mDFS (months)' },
      { key: 'dfs_percent', label: 'DFS (%Pts)' },
      { key: 'pfs_percent', label: 'PFS (%Pts)' },
      { key: 'pfs_hr', label: 'PFS (HR)' },
      { key: 'os_hr', label: 'OS (HR)' },
      { key: 'efficacy_others', label: 'Others (Efficacy)' },
      { key: 'publication_source_clinical', label: 'Publication Source (Clinical)' }
    ]
  },
  {
    title: 'Safety',
    fields: [
      { key: 'safety_evaluable', label: 'Evaluable Patients' },
      { key: 'grade_3_ae', label: 'Grade >=3 AEs (%)' },
      { key: 'grade_3_traes', label: 'Grade >=3 TRAEs (%)' },
      { key: 'immune_related_aes', label: 'Immune Related AEs (%)' },
      { key: 'sae', label: 'SAE (%)' },
      { key: 'any_grade_aes', label: 'Any Grade AEs (%)' },
      { key: 'deaths', label: 'No. of Deaths' },
      { key: 'tx_related_mortality', label: 'Tx Related Mortality (%)' },
      { key: 'safety_others', label: 'Others (Safety)' },
      { key: 'publication_source_safety', label: 'Publication Source (Safety)' }
    ]
  },
  {
    title: 'Regulatory',
    fields: [
      { key: 'approved_region', label: 'Approved Region' },
      { key: 'regulatory_agency', label: 'Regulatory Agency' },
      { key: 'approval_year', label: 'Approval Year' },
      { key: 'regulatory_designation', label: 'Regulatory Designation' }
    ]
  },
  {
    title: 'Sources',
    fields: [
      { key: 'study_identifier_source', label: 'Study Identifier Source' },
      { key: 'registrational_trial_source', label: 'Registrational Trial Source' },
      { key: 'clinical_failure_source', label: 'Clinical Failure Source' },
      { key: 'approval_labels_source', label: 'Approval Labels Source' },
      { key: 'regulatory_designations_source', label: 'Regulatory Designations Source' },
      { key: 'reference', label: 'Reference Notes' }
    ]
  }
];

const TRIAL_ROW_FIELDS = TRIAL_ROW_SECTIONS.flatMap(section => section.fields.map(f => f.key));

function getTrialSectionsForHub(hub) {
  const normalized = normalizeHub(hub || currentHub);
  const allowed = new Set(HUB_TRIAL_FIELDS[normalized] || []);
  const excluded = new Set();
  if (normalized === 'ADC') {
    excluded.add('comparator_arm');
    excluded.add('secondary_endpoint');
    excluded.add('dx_assay');
    excluded.add('dx_cutoff_value');
  }
  const sections = TRIAL_ROW_SECTIONS.map(section => {
    const fields = section.fields.filter(f => (allowed.size ? allowed.has(f.key) : true) && !excluded.has(f.key));
    return fields.length ? { title: section.title, fields } : null;
  }).filter(Boolean);
  return sections.length ? sections : TRIAL_ROW_SECTIONS;
}

function getTrialRowValue(row, key) {
  if (!row) return '';
  if (row.fields && Object.prototype.hasOwnProperty.call(row.fields, key)) return row.fields[key];
  return row[key];
}

function formatTrialRowValue(val) {
  if (Array.isArray(val)) return val.join('; ');
  if (val === null || val === undefined) return '';
  return String(val);
}

function isReferenceField(key) {
  const refFields = ['reference', 'study_identifier_source', 'registrational_trial_source', 
    'clinical_failure_source', 'approval_labels_source', 'regulatory_designations_source',
    'publication_source_clinical', 'publication_source_safety', 'moa_modality_source',
    'asset_status_source', 'evidence_vitro', 'evidence_vivo', 'preclinical_pub_source',
    'sales_source', 'upcoming_clinical_source', 'upcoming_regulatory_source', 'news_source',
    'antibody_target_source', 'dar_loading_ratio_source', 'platform_technology_source',
    'payloads_source', 'linker_source', 'conjugation_source', 'adc_structure_source',
    'boxed_warning_source', 'partnerships_source'];
  return refFields.includes(key);
}

function createShortUrlForReference(url) {
  const baseUrl = 'dklinity.shorturl.link';
  const encoded = btoa(url).substring(0, 8);
  return `${baseUrl}/${encoded}`;
}

function formatReferenceValue(val, fieldKey) {
  if (!val) return '';
  const str = String(val).trim();
  
  if (isReferenceField(fieldKey)) {
    const parts = splitSources(str);
    const items = [];
    if (parts.length > 1) {
      parts.forEach(part => {
        parseSourcesWithUrls(part).forEach(item => items.push(item));
      });
    } else {
      parseSourcesWithUrls(str).forEach(item => items.push(item));
    }
    if (items.length) {
      const rendered = items.map(item => {
        const url = item.url && item.url.match(/^https?:\/\//i) ? item.url : '';
        const link = url
          ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(url)}" style="color:#0066cc;text-decoration:none;font-size:12px;font-weight:600">${escapeHtml(createShortUrlForReference(url))}</a>`
          : '';
        const sourceText = item.source ? escapeHtml(item.source) : '';
        if (sourceText && link) return `${sourceText} | ${link}`;
        if (link) return link;
        return sourceText;
      }).filter(Boolean);
      if (rendered.length) return rendered.join('<br/>');
    }
  }
  
  return escapeHtml(str);
}

function formatDrugValue(drug, key, companyMap) {
  let val = drug[key];
  if (key === 'sponsor_id') {
    val = companyMap[val] || '';
  }
  if (Array.isArray(val)) {
    val = val.join('; ');
  }
  if (val === null || val === undefined || String(val).trim() === '') return '';
  if ((key === 'adc_structure_url' || key === 'company_logo' || key === 'sponsor_logo' || key === 'collaborator_logo') && isUrl(val)) {
    if (isImageUrl(val)) {
      return `
        <div style="display:flex;flex-direction:column;gap:6px">
          <img src="${escapeHtml(String(val))}" alt="ADC Structure" style="max-width:240px;max-height:180px;border:1px solid #e6eef8;border-radius:6px;background:#fff;object-fit:contain" />
          <a href="${escapeHtml(String(val))}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(String(val))}" style="color:#0066cc;text-decoration:none;font-size:12px;font-weight:600">Open image</a>
        </div>
      `;
    }
    const shortUrl = createShortUrlForReference(String(val));
    return `<a href="${escapeHtml(String(val))}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(String(val))}" style="color:#0066cc;text-decoration:none;font-size:12px;font-weight:600">${escapeHtml(shortUrl)}</a>`;
  }
  if (isReferenceField(key)) {
    return formatReferenceValue(val, key);
  }
  return escapeHtml(String(val));
}

function getDrugDetailsSections(hub) {
  const sections = [
    {
      title: 'Overview',
      fields: [
        { key: 'asset_name', label: 'Asset Name' },
        { key: 'product_name', label: 'Product Name' },
        { key: 'asset_synonyms', label: 'Asset Synonyms' },
        { key: 'sponsor_id', label: 'Sponsor' },
        { key: 'collaborator', label: 'Collaborator' },
        { key: 'sponsor_logo', label: 'Sponsor Logo' },
        { key: 'collaborator_logo', label: 'Collaborator Logo' }
      ]
    },
    {
      title: 'Classification & Development',
      fields: [
        { key: 'drug_class', label: 'Drug Class' },
        { key: 'moa', label: 'MoA' },
        { key: 'target', label: 'Target' },
        { key: 'modality', label: 'Modality' },
        { key: 'pd_l1', label: 'PD-1/L1' },
        { key: 'highest_phase', label: 'Highest Phase' },
        { key: 'clinical_preclinical', label: 'Clinical/Preclinical' },
        { key: 'asset_status', label: 'Asset Status' },
        { key: 'active_inactive', label: 'Active / Inactive' }
      ]
    },
    {
      title: 'Regulatory',
      fields: [
        { key: 'approved_region', label: 'Approved Region' },
        { key: 'regulatory_agency', label: 'Regulatory Agency' },
        { key: 'approval_year', label: 'Approval Year' },
        { key: 'regulatory_designation', label: 'Regulatory Designation' },
        { key: 'regulatory_designations', label: 'Regulatory Designations' },
        { key: 'boxed_warning', label: 'Boxed Warning' }
      ]
    },
    {
      title: 'Commercial & News',
      fields: [
        { key: 'sales_millions', label: 'Sales ($ Million)' },
        { key: 'partnerships', label: 'Partnerships' },
        { key: 'news_regulatory', label: 'News (Regulatory)' },
        { key: 'news_commercial', label: 'News (Commercial)' }
      ]
    },
    {
      title: 'Preclinical Evidence',
      fields: [
        { key: 'evidence_vitro', label: 'Evidence In Vitro' },
        { key: 'evidence_vivo', label: 'Evidence In Vivo' }
      ]
    },
    {
      title: 'Sources',
      fields: [
        { key: 'moa_modality_source', label: 'MoA / Modality Source' },
        { key: 'asset_status_source', label: 'Asset Status Source' },
        { key: 'preclinical_pub_source', label: 'Preclinical Publication Source' },
        { key: 'sales_source', label: 'Sales Source' },
        { key: 'news_source', label: 'News Source' },
        { key: 'regulatory_designations_source', label: 'Regulatory Designations Source' },
        { key: 'upcoming_clinical_source', label: 'Upcoming Clinical Source' },
        { key: 'upcoming_regulatory_source', label: 'Upcoming Regulatory Source' },
        { key: 'clinical_failure_source', label: 'Clinical Failure Source' },
        { key: 'boxed_warning_source', label: 'Boxed Warning Source' },
        { key: 'partnerships_source', label: 'Partnerships Source' }
      ]
    }
  ];

  if (hub === 'ADC') {
    sections[0].fields.splice(2, 0, { key: 'adc_structure_url', label: 'ADC Structure' });
    sections.splice(2, 0, {
      title: 'ADC Structure & Chemistry',
      fields: [
        { key: 'conjugate_type', label: 'Conjugate Type' },
        { key: 'conjugate_subtype', label: 'Conjugate Subtype' },
        { key: 'antibody_carrier', label: 'Antibody Carrier' },
        { key: 'target_synonyms', label: 'Target Synonyms' },
        { key: 'combined_target_list', label: 'Combined Target List' },
        { key: 'payload_class', label: 'Payload Class' },
        { key: 'payload_group', label: 'Payload Group' },
        { key: 'payload', label: 'Payload' },
        { key: 'linker_type', label: 'Linker Type' },
        { key: 'linker', label: 'Linker' },
        { key: 'conjugation_type', label: 'Conjugation Type' },
        { key: 'conjugation', label: 'Conjugation' },
        { key: 'dar_loading_ratio', label: 'DAR / Loading Ratio' },
        { key: 'platform_technology', label: 'Platform Technology' },
        { key: 'adc_structure_url', label: 'ADC Structure URL' }
      ]
    });
    // Add ADC-specific sources to the Sources section (avoiding duplicates)
    const sourcesSection = sections.find(s => s.title === 'Sources');
    const adcSources = [
      { key: 'antibody_target_source', label: 'Antibody / Target Source' },
      { key: 'dar_loading_ratio_source', label: 'DAR / Loading Ratio Source' },
      { key: 'platform_technology_source', label: 'Platform Technology Source' },
      { key: 'payloads_source', label: 'Payload Source' },
      { key: 'linker_source', label: 'Linker Source' },
      { key: 'conjugation_source', label: 'Conjugation Source' },
      { key: 'adc_structure_source', label: 'ADC Structure Source' },
      { key: 'boxed_warning_source', label: 'Boxed Warning Source' }
    ];
    // Add ADC sources that don't already exist
    adcSources.forEach(adcSource => {
      if (!sourcesSection.fields.find(f => f.key === adcSource.key)) {
        sourcesSection.fields.push(adcSource);
      }
    });
  }
  return sections;
}

async function openDrugDetails(drugId) {
  const [drugs, companies] = await Promise.all([
    getAllRecords('drugs'),
    getAllRecords('companies')
  ]);
  const drug = drugs.find(d => d.drug_id === drugId);
  if (!drug) return;

  const hub = getRecordHub(drug) || currentHub;
  const companyMap = {};
  companies.forEach(c => { companyMap[c.company_id] = c.company_name; });
  const sections = getDrugDetailsSections(hub);
  const slugify = (text) => String(text || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');

  let html = '<div class="details-layout">';
  html += '<div class="details-nav">';
  html += '<div class="details-nav-title">Sections</div>';
  sections.forEach((section, idx) => {
    const id = slugify(section.title);
    html += `<button class="details-nav-item ${idx === 0 ? 'active' : ''}" onclick="switchDrugDetailsSection('${id}')">${escapeHtml(section.title)}</button>`;
  });
  html += '</div>';
  html += '<div>';

  sections.forEach((section, idx) => {
    const id = slugify(section.title);
    html += `<div class="details-page ${idx === 0 ? 'active' : ''}" id="drug-details-${id}">`;
    html += `<div class="details-section"><div class="details-body">
      <div class="table-wrapper"><table>
        <thead><tr><th>Field</th><th>Value</th></tr></thead>
        <tbody id="drug-details-body-${id}"></tbody>
      </table></div>
    </div></div></div>`;
  });
  html += '</div></div>';

  document.getElementById('drugDetailsTitle').textContent = `Drug Details: ${getDrugDisplayName(drug) || drug.drug_id}`;
  document.getElementById('drugDetailsContainer').innerHTML = html;
  document.getElementById('drugDetailsModal').classList.add('show');

  window.switchDrugDetailsSection = function(sectionId) {
    document.querySelectorAll('#drugDetailsModal .details-page').forEach(p => p.classList.remove('active'));
    const target = document.getElementById('drug-details-' + sectionId);
    if (target) target.classList.add('active');
    document.querySelectorAll('#drugDetailsModal .details-nav-item').forEach(b => b.classList.remove('active'));
    const activeBtn = Array.from(document.querySelectorAll('#drugDetailsModal .details-nav-item'))
      .find(b => (b.getAttribute('onclick') || '').indexOf(`'${sectionId}'`) !== -1);
    if (activeBtn) activeBtn.classList.add('active');
  };

  sections.forEach(section => {
    const id = slugify(section.title);
    const tbody = document.getElementById('drug-details-body-' + id);
    if (!tbody) return;
    let bodyHtml = '';
    section.fields.forEach(f => {
      const rawVal = f.key === 'sponsor_id' ? (companyMap[drug.sponsor_id] || '') : drug[f.key];
      const hasVal = !(rawVal === null || rawVal === undefined ||
        (Array.isArray(rawVal) && rawVal.length === 0) ||
        (typeof rawVal === 'string' && rawVal.trim() === ''));
      const isPreclinical = section.title === 'Preclinical Evidence';
      const isSourcesSection = section.title === 'Sources';
      if (!hasVal && !isPreclinical && !isSourcesSection) return;
      let displayVal = formatDrugValue(drug, f.key, companyMap);
      if (!displayVal && (isPreclinical || isSourcesSection)) {
        displayVal = '<span style="color:#94a3b8">N/A</span>';
      }
      if (!displayVal) return;
      bodyHtml += `<tr><td>${escapeHtml(f.label)}</td><td>${displayVal}</td></tr>`;
    });
    tbody.innerHTML = bodyHtml || '<tr><td colspan="2" style="color:#64748b;font-size:12px">No data</td></tr>';
  });
}

function openTrialDetails(trialId) {
  getAllRecords('trials').then(trials => {
    const trial = trials.find(t => t.trial_id === trialId);
    if (!trial) return;

    const rows = trial.import_row_details || [];
    let html = '';
    if (!rows.length) {
      html = '<div class="alert alert-info">No imported row details found for this trial.</div>';
    } else {
      html += '<div style="margin-bottom:10px;color:#475569;font-size:12px">Select a cohort version to view all fields. Differences are highlighted vs Cohort 1.</div>';
      const base = rows[0] || {};
      const slugify = (text) => String(text || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      const detailsSections = getTrialSectionsForHub(trial.hub || currentHub);
      const sectionIds = detailsSections.map(section => ({
        section,
        id: slugify(section.title)
      }));

      html += '<div class="details-row-selector" id="detailsRowSelector">';
      rows.forEach((r, idx) => {
        const label = `Cohort ${r.row_index || idx + 1}`;
        html += `<button type="button" class="details-row-btn ${idx === 0 ? 'active' : ''}" data-row-index="${idx}" onclick="selectTrialDetailsRow(${idx})">${escapeHtml(label)}</button>`;
      });
      html += '</div>';

      html += '<div class="details-layout">';
      html += '<div class="details-nav">';
      html += '<div class="details-nav-title">Sections</div>';
      sectionIds.forEach((item, idx) => {
        html += `<button class="details-nav-item ${idx === 0 ? 'active' : ''}" onclick="switchTrialDetailsSection('${item.id}')">${escapeHtml(item.section.title)}</button>`;
      });
      html += '</div>';
      html += '<div>';

      sectionIds.forEach((item, idx) => {
        html += `<div class="details-page ${idx === 0 ? 'active' : ''}" id="details-${item.id}">`;
        html += `<div class="details-section">
          <div class="details-body">
            <div class="table-wrapper"><table>
              <thead><tr>
                <th>Field</th>
                <th>Value</th>
              </tr></thead>
              <tbody id="details-body-${item.id}"></tbody>
            </table></div>
          </div>
        </div>
        </div>`;
      });

      html += '</div></div>';
    }

    const titleBase = `Trial Details: ${trial.trial_identifier || trial.trial_id}`;
    document.getElementById('trialDetailsTitle').textContent = titleBase;
    document.getElementById('trialDetailsContainer').innerHTML = html;
    document.getElementById('trialDetailsModal').classList.add('show');
    window.switchTrialDetailsSection = function(sectionId) {
      document.querySelectorAll('.details-page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById('details-' + sectionId);
      if (target) target.classList.add('active');
      document.querySelectorAll('.details-nav-item').forEach(b => b.classList.remove('active'));
      const activeBtn = Array.from(document.querySelectorAll('.details-nav-item'))
        .find(b => (b.getAttribute('onclick') || '').indexOf(`'${sectionId}'`) !== -1);
      if (activeBtn) activeBtn.classList.add('active');
    };
    window.trialDetailsRows = rows;
    window.trialDetailsBaseRow = rows[0] || {};
    window.trialDetailsSections = getTrialSectionsForHub(trial.hub || currentHub);
    window.trialDetailsSectionIds = window.trialDetailsSections.map(section => ({
      section,
      id: String(section.title || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
    }));
    window.renderTrialDetailsRow = function(rowIndex) {
      const row = window.trialDetailsRows[rowIndex] || {};
      const baseRow = window.trialDetailsBaseRow || {};
      window.trialDetailsSectionIds.forEach(item => {
        const tbody = document.getElementById('details-body-' + item.id);
        if (!tbody) return;
        let bodyHtml = '';
        item.section.fields.forEach(f => {
          const isEfficacySafetySection = item.section.title === 'Efficacy' || item.section.title === 'Safety';
          const rawVal = getTrialRowValue(row, f.key);
          const hasVal = !(rawVal === null || rawVal === undefined ||
            (typeof rawVal === 'number' && Number.isNaN(rawVal)) ||
            (Array.isArray(rawVal) && rawVal.length === 0) ||
            (typeof rawVal === 'string' && (rawVal.trim() === '' || rawVal.trim().toLowerCase() === 'nan')));
          const isReference = isReferenceField(f.key);
          if (isEfficacySafetySection && !hasVal && !isReference) {
            return;
          }

          const baseVal = formatTrialRowValue(getTrialRowValue(baseRow, f.key));
          const isDiff = formatTrialRowValue(rawVal) && formatTrialRowValue(rawVal) !== baseVal;
          let displayVal = formatReferenceValue(rawVal, f.key) || '';
          if (!displayVal && isReference) {
            displayVal = '<span style="color:#94a3b8">N/A</span>';
          }
          bodyHtml += `<tr><td>${escapeHtml(f.label)}</td><td class="${isDiff ? 'diff-cell' : ''}">${displayVal}</td></tr>`;
        });
        tbody.innerHTML = bodyHtml || '<tr><td colspan="2" style="color:#64748b;font-size:12px">No data</td></tr>';
      });
    };
    window.selectTrialDetailsRow = function(rowIndex) {
      document.querySelectorAll('.details-row-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`.details-row-btn[data-row-index="${rowIndex}"]`);
      if (btn) btn.classList.add('active');
      const row = window.trialDetailsRows[rowIndex] || {};
      const rowLabel = row.row_index || rowIndex + 1;
      const titleEl = document.getElementById('trialDetailsTitle');
      if (titleEl) titleEl.textContent = `${titleBase} | Cohort ${rowLabel}`;
      window.renderTrialDetailsRow(rowIndex);
    };
    window.selectTrialDetailsRow(0);
  });
}

// ============ Excel Import ============
let excelHeaders = [];
let excelData = [];

async function clearStore(storeName) {
  await new Promise((resolve, reject) => {
    const store = getStore(storeName, 'readwrite');
    const req = store.clear();
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });

  await clearFirestoreCollection(storeName);
}

function normalizeHeaderName(value) {
  return String(value || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
}

function getSheetByName(workbook, targetNames) {
  const names = workbook.SheetNames || [];
  const lookup = names.map(n => n.toLowerCase());
  for (const target of targetNames) {
    const idx = lookup.indexOf(target.toLowerCase());
    if (idx !== -1) return workbook.Sheets[names[idx]];
  }
  return null;
}

async function importRegulatoryAnnouncements(workbook) {
  const sheet = getSheetByName(workbook, ['regulatory announcements', 'regulatory announcments', 'sheet2']);
  if (!sheet) return 0;

  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
  if (!rows || rows.length < 2) return 0;

  const headers = rows[0].map(h => normalizeHeaderName(h));
  const dataRows = rows.slice(1).filter(r => r.some(cell => cell !== null && cell !== ''));

  const headerIndex = (names) => {
    for (const name of names) {
      const idx = headers.indexOf(normalizeHeaderName(name));
      if (idx !== -1) return idx;
    }
    return -1;
  };

  const idxTitle = headerIndex(['title', 'news title']);
  const idxDesc = headerIndex(['discription', 'description', 'news description']);
  const idxLogo = headerIndex(['company logo', 'logo', 'company_logo']);
  const idxLink = headerIndex(['source link', 'news link', 'link', 'source']);
  const idxHub = headerIndex(['hub', 'hub name']);
  const idxDate = headerIndex(['date', 'news date', 'announcement date']);

  await clearStore('regulatory_announcements');

  let count = 0;
  for (const row of dataRows) {
    const title = idxTitle >= 0 ? String(row[idxTitle] || '').trim() : '';
    const description = idxDesc >= 0 ? String(row[idxDesc] || '').trim() : '';
    const companyLogo = idxLogo >= 0 ? String(row[idxLogo] || '').trim() : '';
    const sourceLink = idxLink >= 0 ? String(row[idxLink] || '').trim() : '';
    const hub = idxHub >= 0 ? normalizeHub(row[idxHub]) : currentHub;
    const newsDate = idxDate >= 0 ? String(row[idxDate] || '').trim() : '';

    if (!title && !description) continue;

    await addRecord('regulatory_announcements', {
      title,
      description,
      company_logo: companyLogo,
      source_link: sourceLink,
      hub,
      news_date: newsDate,
      created_at: new Date().toISOString()
    });
    count++;
  }

  // Sync all regulatory announcements to Firestore
  if (firebaseState.db && firebaseState.user && count > 0) {
    console.log('ðŸ“¤ Syncing regulatory announcements to Firestore...');
    const allNews = await getAllRecords('regulatory_announcements');
    for (const news of allNews) {
      if (news.news_id) {
        await syncRecordToFirestore('regulatory_announcements', news, news.news_id);
      }
    }
    console.log('âœ… Regulatory announcements synced to Firestore!');
  }

  return count;
}

async function handleRegulatoryNewsUpload() {
  if (!requireAdminAction()) return;
  const file = document.getElementById('newsExcelInput').files[0];
  if (!file) {
    alert('Please select an Excel file for regulatory news');
    return;
  }

  const statusDiv = document.getElementById('newsImportStatus');
  statusDiv.innerHTML = '<div class="alert alert-info" style="display: flex; align-items: center; gap: 12px;"><div class="spinner" style="width: 18px; height: 18px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div><span>Reading Excel file and importing announcements...</span></div>';

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      
      const regImportCount = await importRegulatoryAnnouncements(workbook);

      if (regImportCount > 0) {
        statusDiv.innerHTML = `<div class="alert alert-success">âœ“ Successfully imported ${regImportCount} regulatory announcement(s)!</div>`;
        document.getElementById('newsExcelInput').value = '';
        
        // Refresh dashboard if in hub mode
        if (currentHub) {
          await updateHubDashboard();
        }
      } else {
        statusDiv.innerHTML = '<div class="alert alert-warning">No regulatory announcements found in the Excel file. Please make sure the file has a sheet named "Regulatory Announcements" or "Sheet2" with the correct columns.</div>';
      }
    } catch (err) {
      statusDiv.innerHTML = `<div class="alert alert-danger">Error reading Excel: ${err.message}</div>`;
    }
  };
  reader.readAsArrayBuffer(file);
}

async function openRegulatoryNewsModal(newsId) {
  const allNews = await getAllRecords('regulatory_announcements');
  const newsItem = allNews.find(n => n.news_id === newsId);
  if (!newsItem) return;

  const modal = document.getElementById('regulatoryNewsModal');
  const body = document.getElementById('regulatoryNewsModalBody');
  if (!modal || !body) return;

  const logoHtml = newsItem.company_logo
    ? `<img src="${escapeHtml(newsItem.company_logo)}" alt="Company Logo" class="news-detail-logo" />`
    : `<div class="news-detail-logo" style="display:flex;align-items:center;justify-content:center;font-weight:700;color:#64748b;">N/A</div>`;

  const dateText = newsItem.news_date ? `<div class="dash-news-meta">${escapeHtml(newsItem.news_date)}</div>` : '';
  const linkHtml = newsItem.source_link
    ? `<a class="news-detail-link" href="${escapeHtml(newsItem.source_link)}" target="_blank" rel="noopener">Reference Link</a>`
    : '';

  body.innerHTML = `
    <div class="news-detail-header">
      ${logoHtml}
      <div>
        <h3 class="news-detail-title">${escapeHtml(newsItem.title)}</h3>
        ${dateText}
      </div>
    </div>
    <div style="margin-top: 18px;" class="news-detail-body">
      ${escapeHtml(newsItem.description).replace(/\n/g, '<br/>')}
    </div>
    ${linkHtml}
  `;

  modal.classList.add('show');
}

async function handleExcelUpload() {
  if (!requireAdminAction()) return;
  const file = document.getElementById('excelInput').files[0];
  if (!file) {
    alert('Please select an Excel file');
    return;
  }

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

      if (!rows || rows.length < 2) {
        alert('Excel file must have headers and at least one data row');
        return;
      }

      excelHeaders = rows[0].map(h => String(h || '').trim());
      excelData = rows.slice(1).filter(r => r.some(cell => cell !== null && cell !== ''));

      // Default to current hub, but allow a hub column in the file to drive per-row hub.
      const importHub = currentHub;
      window.importHubOverride = null;

      document.getElementById('importStatus').innerHTML = `<div class="alert alert-info">Loading ${excelData.length} rows. If your file has a hub column, rows will be saved to their matching hubs. Mapping columns below...</div>`;
      showMappingUI(importHub);
    } catch (err) {
      alert('Error reading Excel: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function showMappingUI(importHub = currentHub) {
  // Get hub-specific fields
  const hubDrugFields = HUB_DRUG_FIELDS[importHub] || HUB_DRUG_FIELDS.IO;
  const hubTrialFields = HUB_TRIAL_FIELDS[importHub] || HUB_TRIAL_FIELDS.IO;
  
  const fields = {
    'DRUG': hubDrugFields,
    'TRIAL': hubTrialFields
  };

  // Helper functions for auto-mapping
  function _norm(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9 ]+/g,' ').replace(/\s+/g,' ').trim(); }

  const FIELD_ALIASES = {
    product_name: ['drug name', 'product', 'product name', 'brand', 'brand name', 'io drug', 'drug', 'pd-1/l1 drug', 'pd-1 l1 drug', 'pd1/l1 drug'],
    asset_name: ['asset', 'asset name', 'adc name', 'adc', 'molecule', 'compound'],
    asset_synonyms: ['synonyms', 'alias', 'aliases', 'other names'],
    sponsor: ['company', 'sponsor', 'sponsor company', 'owner', 'manufacturer'],
    company_type: ['company type'],
    company_logo: ['company logo'],
    sponsor_logo: ['sponsor logo'],
    collaborator_logo: ['collaborator logo'],
    collaborator: ['collaborator', 'partner', 'co-developer'],
    highest_phase: ['phase', 'highest phase', 'development phase'],
    development_status: ['development status', 'dev status', 'status'],
    trial_title: ['trial title'],
    trial_acronym: ['trial acronym'],
    trial_identifier: ['trial identifier'],
    trial_design: ['trial design'],
    registrational: ['registrational (y/n)', 'registrational'],
    tumor_group: ['tumor group'],
    tumors: ['tumor', 'tumors'],
    mutation_biomarker: ['mutation/biomarker', 'mutation biomarker'],
    patient_age_group: ['patient age group'],
    patient_number: ['patient number (n)', 'patient number'],
    primary_endpoint: ['primary endpoint', 'primary endpoint '],
    secondary_endpoint: ['secondary endpoint'],
    study_start_date: ['study start date'],
    primary_completion_date: ['primary completion date'],
    study_completion_date: ['study completion date'],
    location: ['location'],
    region: ['region'],
    line_of_therapy: ['line of therapy'],
    stage: ['stage'],
    mono_combo: ['mono/combo'],
    regimens: ['regimen and dosing', 'regimen/dosing'],
    regimen_moa: ['regimen moa'],
    included_based_on_prior: ['included based on prior treatment'],
    excluded_based_on_prior: ['excluded based on prior treatment'],
    asset_status: ['asset status', 'active status'],
    active_inactive: ['active/inactive', 'active inactive', 'active'],
    drug_class: ['class', 'drug class', 'therapeutic class'],
    moa: ['moa', 'mechanism', 'mechanism of action'],
    target: ['target', 'targets', 'antigen'],
    modality: ['modality', 'drug type', 'platform type'],
    pd_l1: ['pd1', 'pd-1', 'pd-l1', 'pdl1'],
    conjugate_type: ['conjugate type', 'adc type'],
    conjugate_subtype: ['conjugate subtype', 'adc subtype'],
    payload_class: ['payload class'],
    payload_group: ['payload group'],
    payload: ['payload', 'warhead'],
    linker_type: ['linker type'],
    linker: ['linker'],
    conjugation_type: ['conjugation type'],
    conjugation: ['conjugation'],
    dar_loading_ratio: ['dar', 'loading ratio', 'dar/loading ratio'],
    platform_technology: ['platform', 'platform technology'],
    antibody_carrier: ['antibody carrier', 'antibody'],
    target_synonyms: ['target synonyms', 'target aliases'],
    combined_target_list: ['combined target list', 'target list'],
    adc_structure_url: ['adc structure', 'structure url', 'structure image'],
    antibody_target_source: ['antibody target source', 'antibody source', 'target source'],
    dar_loading_ratio_source: ['dar source', 'loading ratio source', 'dar/loading source'],
    platform_technology_source: ['platform source', 'platform technology source', 'technology source'],
    payloads_source: ['payload source', 'payloads source', 'warhead source'],
    linker_source: ['linker source'],
    conjugation_source: ['conjugation source'],
    adc_structure_source: ['adc structure source', 'structure source'],
    asset_status_source: ['asset status source', 'status source'],
    approval_year: ['approval year'],
    regulatory_agency: ['regulatory agency', 'agency', 'fda', 'ema'],
    approved_region: ['approved region', 'approval region', 'region approved'],
    regulatory_designation: ['regulatory designation', 'designation'],
    regulatory_designations: ['regulatory designations', 'designations'],
    regulatory_designations_source: ['regulatory designations source', 'designations source', 'regulatory designation source'],
    boxed_warning: ['boxed warning', 'black box warning'],
    boxed_warning_source: ['boxed warning source', 'black box source'],
    study_identifier_source: ['study identifier source', 'study id source', 'trial id source'],
    registrational_trial_source: ['registrational trial source', 'registrational source'],
    approval_labels_source: ['approval labels source', 'approval label source'],
    publication_source_clinical: ['publication source clinical', 'clinical publication source', 'publication source (clinical)'],
    publication_source_safety: ['publication source safety', 'safety publication source', 'publication source (safety)'],
    moa_modality_source: ['moa modality source', 'moa source', 'modality source'],
    evidence_vitro: ['in vitro', 'vitro', 'in vitro evidence'],
    evidence_vivo: ['in vivo', 'vivo', 'in vivo evidence'],
    clinical_preclinical: ['clinical/preclinical'],
    preclinical_pub_source: ['preclinical source', 'preclinical publication', 'preclinical ref', 'publication source (preclinical)', 'publication source preclinical'],
    sales_millions: ['sales', 'sales ($m)', 'sales million', 'sales (million)'],
    sales_source: ['sales source', 'approved assets sales source', '2024 sales source'],
    upcoming_clinical: ['upcoming clinical', 'clinical milestone', 'upcoming clinical milestone'],
    upcoming_clinical_source: ['upcoming clinical source', 'clinical milestone source', 'upcoming clinical milestone source'],
    upcoming_regulatory: ['upcoming regulatory', 'regulatory milestone', 'upcoming regulatory milestone'],
    upcoming_regulatory_source: ['upcoming regulatory source', 'regulatory milestone source', 'upcoming regulatory milestone source'],
    partnerships: ['partners', 'partnerships', 'collaborations', 'partnership and collaboration'],
    partnerships_source: ['partnerships source', 'partner source', 'collaboration source', 'partnerships (source)'],
    news_regulatory: ['regulatory news', 'news regulatory', 'news (regulatory)'],
    news_commercial: ['commercial news'],
    news_source: ['news source'],
    reference: ['reference', 'reference notes'],
    clinical_failure: ['clinical failure', 'reason for clinical failure/termination/withdrawal', 'clinical failure/termination/withdrawal'],
    clinical_failure_source: ['clinical failure source', 'clinical failure/termination/withdrawal source'],
    other_registry_trial_id: ['other registry trial id', 'other registry trial', 'other registry id'],
    efficacy_evaluable: ['evaluable patients (efficacy)'],
    safety_evaluable: ['evaluable patients (safety)'],
    data_review_committee: ['data review committee'],
    mdor_months: ['mdor (months)'],
    mos_months: ['mos (months)', 'mos'],
    os_months: ['os (months)', 'os'],
    os_percent: ['os (%pts)', 'os (%pts) '],
    mpfs_months: ['mpfs (months)', 'mpfs'],
    pfs_months: ['pfs (months)', 'pfs'],
    pfs_percent: ['pfs (%pts)', 'pfs (%pts) '],
    mdfs_months: ['mdfs (months)', 'mdfs'],
    dfs: ['dfs'],
    dfs_percent: ['dfs (%pts)', 'dfs (%pts) '],
    grade_3_ae: ['grade â‰¥3 aes', 'grade >=3 aes'],
    grade_3_traes: ['grade â‰¥3 traes', 'grade >=3 traes'],
    any_grade_aes: ['any grade aes'],
    sae: ['sae'],
    immune_related_aes: ['immune related aes'],
    safety_others: ['others (safety)'],
    deaths: ['no. of deaths (patients)', 'no of deaths (patients)'],
    tx_related_mortality: ['tx related mortality'],
    efficacy_others: ['others (efficacy)'],
    trials_with_results: ['trials with results', 'trial results'],
    remarks: ['remarks', 'comments'],
    additional_comments: ['additional comments', 'notes'],
    analyst_name: ['analyst', 'analyst name'],
    last_updated_on: ['last updated', 'updated on']
  };

  function getAliasCandidates(fieldName){
    const key = _norm(fieldName).replace(/\s+/g, '_');
    return FIELD_ALIASES[key] || [];
  }

  function bestMatchIndexForFieldName(fieldName){
    if(!excelHeaders || !excelHeaders.length) return -1;
    const target = _norm(fieldName);
    const aliases = getAliasCandidates(fieldName).map(a => _norm(a));

    for(let i=0;i<excelHeaders.length;i++){
      const h = _norm(excelHeaders[i]);
      if(h === target) return i;
      if(aliases.includes(h)) return i;
    }
    for(let i=0;i<excelHeaders.length;i++){
      const h = _norm(excelHeaders[i]);
      if(h.includes(target) || target.includes(h)) return i;
      if(aliases.some(a => h.includes(a) || a.includes(h))) return i;
    }
    const toks = new Set(target.split(' '));
    let best=-1, bestScore=0;
    for(let i=0;i<excelHeaders.length;i++){
      const h=_norm(excelHeaders[i]);
      const hT=h.split(' '); let score=0;
      hT.forEach(t=>{ if(toks.has(t)) score++; });
      if(score>bestScore){ bestScore=score; best=i; }
    }
    if(bestScore>0) return best;
    for(let i=0;i<excelHeaders.length;i++){
      const h=_norm(excelHeaders[i]);
      const parts=h.split(' ');
      for(const p of parts){ if(target.includes(p) || (p && target.indexOf(p)!==-1)) return i; }
    }
    return -1;
  }

  let html = `
    <h3>Map Excel Columns to Database Fields (${importHub} Hub)</h3>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <input id="mappingSearch" placeholder="Search fields..." style="flex:1;padding:6px;border:1px solid #e6eef8;border-radius:4px" oninput="filterMappingFields(this.value)" />
      <button type="button" class="btn btn-sm" onclick="autoMapColumns()">Auto-map</button>
      <button type="button" class="btn btn-sm btn-secondary" onclick="clearMappings()">Clear</button>
    </div>
    <div style="max-height: 600px; overflow-y: auto; border: 1px solid #e6eef8; border-radius: 6px; padding: 12px;">
  `;

  // Iterate through field categories
  Object.keys(fields).forEach(category => {
    html += `<div style="font-weight: 700; margin-top: 12px; margin-bottom: 8px; background: #f1f5f9; padding: 8px; border-radius: 4px;">${category}</div>`;
    html += '<div class="mapping-grid" style="max-height: none; border: none; padding: 0; margin-bottom: 12px;">';

    fields[category].forEach(field => {
      const selectedIdx = bestMatchIndexForFieldName(field);

      html += `<div class="mapping-row" style="display:flex;align-items:center;gap:8px;padding:6px;">
        <div style="width:40%;font-size:12px;color:#0f172a">${field}</div>
        <div style="flex:1;">
          <select id="map_${field}" class="mapping-select" style="width:100%;font-size:12px;padding:6px;border:1px solid #e6eef8;border-radius:4px;">
            <option value="-1">-- Skip --</option>
            ${excelHeaders.map((h, i) => `<option value="${i}" ${selectedIdx === i ? 'selected' : ''}>${h}</option>`).join('')}
          </select>
        </div>
      </div>`;
    });

    html += '</div>';
  });

  html += '</div>';
  
  // Add buttons at both top and bottom for better visibility
  const buttonHtml = `
    <div style="margin-top: 16px; margin-bottom: 16px; display: flex; gap: 8px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 2px solid #3b82f6; position: sticky; top: 0; z-index: 10;">
      <button class="btn btn-primary" onclick="processExcelImport()" style="font-size: 16px; padding: 12px 24px;">
        âš¡ Import Mapped Data (${excelData.length} rows)
      </button>
      <button class="btn btn-secondary" onclick="cancelImport()" style="padding: 12px 24px;">Cancel</button>
      <div id="importProgress" style="flex: 1; display: none; align-items: center; gap: 8px; font-weight: 600; color: #3b82f6;">
        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        <span id="importProgressText">Processing...</span>
      </div>
    </div>
  `;
  
  html = buttonHtml + html + buttonHtml;

  document.getElementById('mappingPreview').innerHTML = html;


  window.autoMapColumns = function(){
    document.querySelectorAll('select[id^="map_"]').forEach(sel=>{
      const field = sel.id.replace('map_','');
      const idx = bestMatchIndexForFieldName(field);
      if(idx>=0){ sel.value = String(idx); }
    });
  };

  window.clearMappings = function(){
    document.querySelectorAll('select[id^="map_"]').forEach(sel=> sel.value='-1');
  };

  window.filterMappingFields = function(q){
    q = String(q||'').toLowerCase().trim();
    document.querySelectorAll('.mapping-row').forEach((r, idx)=>{
      if(idx===0) return; // header
      const label = (r.querySelector('div')?.textContent||'').toLowerCase();
      r.style.display = (!q || label.indexOf(q)!==-1) ? 'flex' : 'none';
    });
  };
}

async function processExcelImport() {
  if (!requireAdminAction()) return;
  
  // IMPORTANT: Suppress individual Firestore writes during import
  // We'll do batch sync at the end instead (much faster)
  suppressFirestoreWrites = true;
  console.log('ðŸ”´ Firestore syncing suppressed during import');
  
  // Show progress indicator
  const progressDiv = document.getElementById('importProgress');
  const progressText = document.getElementById('importProgressText');
  if (progressDiv) {
    progressDiv.style.display = 'flex';
    if (progressText) progressText.textContent = 'Starting import...';
  }
  
  // Disable import buttons
  document.querySelectorAll('button').forEach(btn => {
    if (btn.textContent.includes('Import Mapped Data')) btn.disabled = true;
  });
  
  // Use override hub if set during auto-detection; otherwise default to current hub.
  const importHub = window.importHubOverride || currentHub;
  
  // Get hub-specific fields
  const hubDrugFields = HUB_DRUG_FIELDS[importHub] || HUB_DRUG_FIELDS.IO;
  const hubTrialFields = HUB_TRIAL_FIELDS[importHub] || HUB_TRIAL_FIELDS.IO;
  
  // Read mapping selections
  const getColumnIndex = (field) => {
    const select = document.getElementById('map_' + field);
    return select ? parseInt(select.value) : -1;
  };

  // Build mapping object with hub-specific fields
  const mapping = {};
  hubDrugFields.concat(hubTrialFields).forEach(f => mapping[f] = getColumnIndex(f));

  // Get existing data
  const companies = await getAllRecords('companies');
  const drugs = await getAllRecords('drugs');
  const companyMap = {};
  const drugMap = {};
  const companyKey = (hub, name) => `${normalizeHub(hub)}::${(name || '').toLowerCase().trim()}`;
  const drugKey = (hub, name) => `${normalizeHub(hub)}::${(name || '').toLowerCase().trim()}`;
  
  // Map companies specific to the import hub
  companies.forEach(c => {
    const cHub = normalizeHub(c.hub) || 'IO';
    companyMap[companyKey(cHub, c.company_name || '')] = c.company_id;
  });
  
  // Map drugs specific to the import hub
  drugs.forEach(d => {
    const dHub = normalizeHub(d.hub) || 'IO';
    drugMap[drugKey(dHub, d.product_name || d.asset_name || '')] = d.drug_id;
  });

  // Helper to get value from row by field mapping
  const getValue = (row, field) => {
    const idx = mapping[field];
    return idx >= 0 ? row[idx] : null;
  };

  const parseNum = (val) => val ? parseFloat(val) : null;
  const parseInt_ = (val) => val ? parseInt(val) : null;
  const parseArray = (val) => val ? String(val).split(',').map(s => s.trim()).filter(Boolean) : [];

  // Build drug data based on hub type
  const buildDrugData = (row, rowHub, sponsorId) => {
    const baseData = {
      hub: rowHub,
      sponsor_id: sponsorId,
      created_at: new Date().toISOString()
    };
    
    if (rowHub === 'ADC') {
      // ADC-specific fields
      return {
        ...baseData,
        asset_name: (getValue(row, 'asset_name') || '').toString(),
        product_name: (getValue(row, 'product_name') || '').toString(),
        asset_synonyms: parseArray(getValue(row, 'asset_synonyms')),
        sponsor: (getValue(row, 'sponsor') || '').toString(),
        collaborator: (getValue(row, 'collaborator') || '').toString(),
        sponsor_logo: (getValue(row, 'sponsor_logo') || '').toString(),
        collaborator_logo: (getValue(row, 'collaborator_logo') || '').toString(),
        highest_phase: (getValue(row, 'highest_phase') || '').toString(),
        clinical_preclinical: (getValue(row, 'clinical_preclinical') || '').toString(),
        development_status: (getValue(row, 'development_status') || '').toString(),
        asset_status: (getValue(row, 'asset_status') || '').toString(),
        active_inactive: (getValue(row, 'active_inactive') || 'Active').toString(),
        conjugate_type: (getValue(row, 'conjugate_type') || '').toString(),
        conjugate_subtype: (getValue(row, 'conjugate_subtype') || '').toString(),
        moa: (getValue(row, 'moa') || '').toString(),
        antibody_carrier: (getValue(row, 'antibody_carrier') || '').toString(),
        target: (getValue(row, 'target') || '').toString(),
        target_synonyms: parseArray(getValue(row, 'target_synonyms')),
        combined_target_list: (getValue(row, 'combined_target_list') || '').toString(),
        payload_class: (getValue(row, 'payload_class') || '').toString(),
        payload_group: (getValue(row, 'payload_group') || '').toString(),
        payload: (getValue(row, 'payload') || '').toString(),
        linker_type: (getValue(row, 'linker_type') || '').toString(),
        linker: (getValue(row, 'linker') || '').toString(),
        conjugation_type: (getValue(row, 'conjugation_type') || '').toString(),
        conjugation: (getValue(row, 'conjugation') || '').toString(),
        dar_loading_ratio: (getValue(row, 'dar_loading_ratio') || '').toString(),
        platform_technology: (getValue(row, 'platform_technology') || '').toString(),
        antibody_target_source: (getValue(row, 'antibody_target_source') || '').toString(),
        dar_loading_ratio_source: (getValue(row, 'dar_loading_ratio_source') || '').toString(),
        platform_technology_source: (getValue(row, 'platform_technology_source') || '').toString(),
        payloads_source: (getValue(row, 'payloads_source') || '').toString(),
        linker_source: (getValue(row, 'linker_source') || '').toString(),
        conjugation_source: (getValue(row, 'conjugation_source') || '').toString(),
        adc_structure_url: (getValue(row, 'adc_structure_url') || '').toString(),
        adc_structure_source: (getValue(row, 'adc_structure_source') || '').toString(),
        asset_status_source: (getValue(row, 'asset_status_source') || '').toString(),
        approved_region: (getValue(row, 'approved_region') || '').toString(),
        regulatory_agency: (getValue(row, 'regulatory_agency') || '').toString(),
        approval_year: parseInt_(getValue(row, 'approval_year')),
        regulatory_designation: (getValue(row, 'regulatory_designation') || '').toString(),
        regulatory_designations_source: (getValue(row, 'regulatory_designations_source') || '').toString(),
        boxed_warning: (getValue(row, 'boxed_warning') || '').toString(),
        boxed_warning_source: (getValue(row, 'boxed_warning_source') || '').toString(),
        evidence_vitro: (getValue(row, 'evidence_vitro') || '').toString(),
        evidence_vivo: (getValue(row, 'evidence_vivo') || '').toString(),
        preclinical_pub_source: (getValue(row, 'preclinical_pub_source') || '').toString(),
        sales_millions: parseNum(getValue(row, 'sales_millions')),
        sales_source: (getValue(row, 'sales_source') || '').toString(),
        partnerships: parseArray(getValue(row, 'partnerships')),
        partnerships_source: (getValue(row, 'partnerships_source') || '').toString(),
        upcoming_clinical: (getValue(row, 'upcoming_clinical') || '').toString(),
        upcoming_clinical_source: (getValue(row, 'upcoming_clinical_source') || '').toString(),
        upcoming_regulatory: (getValue(row, 'upcoming_regulatory') || '').toString(),
        upcoming_regulatory_source: (getValue(row, 'upcoming_regulatory_source') || '').toString(),
        news_regulatory: (getValue(row, 'news_regulatory') || '').toString(),
        news_commercial: (getValue(row, 'news_commercial') || '').toString(),
        news_source: (getValue(row, 'news_source') || '').toString(),
        trials_with_results: (getValue(row, 'trials_with_results') || '').toString(),
        clinical_failure: (getValue(row, 'clinical_failure') || '').toString(),
        clinical_failure_source: (getValue(row, 'clinical_failure_source') || '').toString(),
        remarks: (getValue(row, 'remarks') || '').toString(),
        additional_comments: (getValue(row, 'additional_comments') || '').toString(),
        last_updated_on: (getValue(row, 'last_updated_on') || '').toString(),
        analyst_name: (getValue(row, 'analyst_name') || '').toString()
      };
    } else {
      // IO and other hubs use generic drug fields
      return {
        ...baseData,
        product_name: (getValue(row, 'product_name') || '').toString(),
        pd_l1: getValue(row, 'pd_l1') || null,
        asset_synonyms: parseArray(getValue(row, 'asset_synonyms')),
        sponsor: (getValue(row, 'sponsor') || '').toString(),
        sponsor_logo: (getValue(row, 'sponsor_logo') || '').toString(),
        collaborator_logo: (getValue(row, 'collaborator_logo') || '').toString(),
        drug_class: (getValue(row, 'drug_class') || '').toString(),
        moa: (getValue(row, 'moa') || '').toString(),
        target: (getValue(row, 'target') || '').toString(),
        modality: (getValue(row, 'modality') || '').toString(),
        highest_phase: (getValue(row, 'highest_phase') || '').toString(),
        development_status: (getValue(row, 'development_status') || '').toString(),
        asset_status: (getValue(row, 'asset_status') || '').toString(),
        active_inactive: (getValue(row, 'active_inactive') || 'Active').toString(),
        moa_modality_source: (getValue(row, 'moa_modality_source') || '').toString(),
        asset_status_source: (getValue(row, 'asset_status_source') || '').toString(),
        evidence_vitro: (getValue(row, 'evidence_vitro') || '').toString(),
        evidence_vivo: (getValue(row, 'evidence_vivo') || '').toString(),
        preclinical_pub_source: (getValue(row, 'preclinical_pub_source') || '').toString(),
        sales_millions: parseNum(getValue(row, 'sales_millions')),
        sales_source: (getValue(row, 'sales_source') || '').toString(),
        upcoming_clinical: (getValue(row, 'upcoming_clinical') || '').toString(),
        upcoming_clinical_source: (getValue(row, 'upcoming_clinical_source') || '').toString(),
        upcoming_regulatory: (getValue(row, 'upcoming_regulatory') || '').toString(),
        upcoming_regulatory_source: (getValue(row, 'upcoming_regulatory_source') || '').toString(),
        partnerships: parseArray(getValue(row, 'partnerships')),
        partnerships_source: (getValue(row, 'partnerships_source') || '').toString(),
        news_regulatory: (getValue(row, 'news_regulatory') || '').toString(),
        news_commercial: (getValue(row, 'news_commercial') || '').toString(),
        news_source: (getValue(row, 'news_source') || '').toString(),
        approved_region: (getValue(row, 'approved_region') || '').toString(),
        regulatory_agency: (getValue(row, 'regulatory_agency') || '').toString(),
        approval_year: parseInt_(getValue(row, 'approval_year')),
        regulatory_designations: (getValue(row, 'regulatory_designations') || '').toString(),
        regulatory_designations_source: (getValue(row, 'regulatory_designations_source') || '').toString(),
        boxed_warning: (getValue(row, 'boxed_warning') || '').toString(),
        boxed_warning_source: (getValue(row, 'boxed_warning_source') || '').toString(),
        clinical_failure: (getValue(row, 'clinical_failure') || '').toString(),
        clinical_failure_source: (getValue(row, 'clinical_failure_source') || '').toString()
      };
    }
  };

  // Process rows: group by trial_identifier only
  const existingTrials = await getAllRecords('trials');
  const existingTrialMap = {};
  existingTrials.forEach(t => {
    const key = (t.trial_identifier || '').toString().trim().toUpperCase();
    const hubKey = `${normalizeHub(t.hub || currentHub)}::${key}`;
    if (key) existingTrialMap[hubKey] = t;
  });

  const trialGroups = {};
  const importedHubs = new Set();
  
  for (let rowIndex = 0; rowIndex < excelData.length; rowIndex++) {
    // Update progress every 200 rows (less frequent = faster)
    if (rowIndex % 200 === 0 && progressText) {
      progressText.textContent = `Processing row ${rowIndex + 1} of ${excelData.length}...`;
      await new Promise(resolve => setTimeout(resolve, 0)); // Allow UI to update
    }
    
    const row = excelData[rowIndex];
    const rowHub = normalizeHub(getValue(row, 'hub') || importHub);
    importedHubs.add(rowHub);
    const assetField = rowHub === 'ADC' ? 'asset_name' : 'product_name';
    const asset = (getValue(row, assetField) || '').toString().trim();
    const trialId = (getValue(row, 'trial_identifier') || '').toString().trim();

    // Get or create company
    let sponsorId = null;
    const sponsorName = (getValue(row, 'sponsor') || '').toString().trim();
    if (sponsorName) {
      const key = companyKey(rowHub, sponsorName);
      if (companyMap[key]) {
        sponsorId = companyMap[key];
      } else {
        const mappedCompanyType = (getValue(row, 'company_type') || '').toString().trim();
        const mappedLogo = (getValue(row, 'company_logo') || '').toString().trim();
        sponsorId = await addRecord('companies', {
          company_name: sponsorName,
          company_type: mappedCompanyType || 'Pharmaceutical',
          company_logo: mappedLogo,
          hub: rowHub,
          created_at: new Date().toISOString()
        });
        companyMap[key] = sponsorId;
      }
    }

    // Get or create drug with hub-specific fields
    let drugId = null;
    if (asset) {
      const pkey = drugKey(rowHub, asset);
      if (drugMap[pkey]) {
        drugId = drugMap[pkey];
      } else {
        const drugData = buildDrugData(row, rowHub, sponsorId);
        drugId = await addRecord('drugs', drugData);
        drugMap[pkey] = drugId;
      }
    }

    if (!trialId) {
      continue;
    }

    // Group rows by trial AND cohort signature (intelligent splitting)
    const tkey = `${rowHub}::${trialId.toUpperCase()}`;
    if (!trialGroups[tkey]) {
      trialGroups[tkey] = {
        trialIdentifier: trialId,
        drugId: drugId,
        hub: rowHub,
        rows: []
      };
    }

    if (!trialGroups[tkey].drugId && drugId) {
      trialGroups[tkey].drugId = drugId;
    }

    trialGroups[tkey].rows.push(row);
  }

  const listFields = new Set(['tumors', 'mutations', 'prospective_biomarkers', 'regimens']);
  const dateFields = new Set(['study_start_date', 'primary_completion_date', 'study_completion_date']);
  const intFields = new Set(['patient_number', 'efficacy_evaluable', 'safety_evaluable', 'approval_year', 'deaths']);
  const floatFields = new Set([
    'orr', 'dcr', 'cr', 'pr', 'sd', 'pd', 'mdor_months', 'pfs_months', 'mpfs_months',
    'os_months', 'mos_months', 'dfs', 'mdfs_months', 'pfs_hr', 'os_hr',
    'grade_3_ae', 'grade_3_traes', 'immune_related_aes', 'sae', 'any_grade_aes',
    'tx_related_mortality', 'os_percent', 'pfs_percent', 'dfs_percent'
  ]);

  const normalizeListFromValue = (val) => {
    if (!val) return [];
    return String(val)
      .split(/[,;|]/)
      .map(s => s.trim())
      .filter(Boolean);
  };

  const normalizeRowValue = (field, val) => {
    if (field === 'hub') {
      // Don't default empty hub values - let downstream logic handle it
      const normalized = normalizeHub(val);
      if (!val || val.toString().trim() === '') return ''; // Return empty if input is empty
      return normalized;
    }
    if (dateFields.has(field)) return excelDateToISO(val);
    if (intFields.has(field)) return parseInt_(val);
    if (floatFields.has(field)) return parseNum(val);
    if (listFields.has(field)) return normalizeListFromValue(val);
    return (val || '').toString().trim();
  };

  const isEmptyValue = (val) => {
    if (Array.isArray(val)) return val.length === 0;
    if (val === null || val === undefined) return true;
    if (typeof val === 'string') return val.trim() === '';
    return false;
  };

  const buildRowData = (row, trialIdentifier) => {
    const data = {};
    TRIAL_ROW_FIELDS.forEach(field => {
      data[field] = normalizeRowValue(field, getValue(row, field));
    });
    if (!data.trial_identifier) data.trial_identifier = trialIdentifier || '';
    return data;
  };

  let createdTrials = 0;
  let updatedTrials = 0;
  let addedRowVariants = 0;
  
  if (progressText) progressText.textContent = 'Creating trial records...';
  const totalTrials = Object.keys(trialGroups).length;
  let processedTrials = 0;

  for (const key of Object.keys(trialGroups)) {
    // Update progress every 25 trials (less frequent = faster)
    processedTrials++;
    if (processedTrials % 25 === 0 && progressText) {
      progressText.textContent = `Creating trials: ${processedTrials} of ${totalTrials}...`;
      await new Promise(resolve => setTimeout(resolve, 0));
    }
    const group = trialGroups[key];
    const existingTrial = existingTrialMap[key] || null;
    const baseRowData = buildRowData(group.rows[0], group.trialIdentifier);
    const getBaseValue = (field, fallback) => {
      const existingVal = existingTrial ? existingTrial[field] : null;
      return !isEmptyValue(existingVal) ? existingVal : fallback;
    };

    const tumorGroupValues = !isEmptyValue(existingTrial?.tumor_group_values)
      ? existingTrial.tumor_group_values
      : normalizeListFromValue(baseRowData.tumor_group);
    const stageValues = !isEmptyValue(existingTrial?.stage_values)
      ? existingTrial.stage_values
      : normalizeListFromValue(baseRowData.stage);
    const lineValues = !isEmptyValue(existingTrial?.line_of_therapy_values)
      ? existingTrial.line_of_therapy_values
      : normalizeListFromValue(baseRowData.line_of_therapy);
    const includedValues = !isEmptyValue(existingTrial?.included_based_on_prior_values)
      ? existingTrial.included_based_on_prior_values
      : normalizeListFromValue(baseRowData.included_based_on_prior);
    const excludedValues = !isEmptyValue(existingTrial?.excluded_based_on_prior_values)
      ? existingTrial.excluded_based_on_prior_values
      : normalizeListFromValue(baseRowData.excluded_based_on_prior);

    const existingRowDetails = Array.isArray(existingTrial?.import_row_details) ? existingTrial.import_row_details : [];
    const newRowDetails = [];

    group.rows.forEach((row, idx) => {
      const rowData = buildRowData(row, group.trialIdentifier);
      rowData.row_index = existingRowDetails.length + idx + 1;
      newRowDetails.push(rowData);
    });

    const mergedRowDetails = existingRowDetails.concat(newRowDetails);
    addedRowVariants += newRowDetails.length;

    // Explicitly use importHub (not currentHub) for consistency with row-level hub
    const trialHub = getBaseValue('hub', baseRowData.hub);
    const finalHub = (!trialHub || trialHub.toString().trim() === '') ? (group.hub || importHub) : trialHub;
    
    const trial = {
      hub: normalizeHub(finalHub),
      trial_identifier: group.trialIdentifier,
      trial_title: getBaseValue('trial_title', baseRowData.trial_title),
      trial_acronym: getBaseValue('trial_acronym', baseRowData.trial_acronym),
      trial_design: getBaseValue('trial_design', baseRowData.trial_design),
      development_status: getBaseValue('development_status', baseRowData.development_status),
      recruitment_status: getBaseValue('recruitment_status', baseRowData.recruitment_status),
      registrational: getBaseValue('registrational', baseRowData.registrational),
      other_registry_trial_id: getBaseValue('other_registry_trial_id', baseRowData.other_registry_trial_id),
      tumor_group: getBaseValue('tumor_group', baseRowData.tumor_group),
      tumor_group_values: tumorGroupValues,
      tumors: getBaseValue('tumors', baseRowData.tumors),
      patient_age_group: getBaseValue('patient_age_group', baseRowData.patient_age_group),
      patient_number: getBaseValue('patient_number', baseRowData.patient_number),
      study_start_date: getBaseValue('study_start_date', baseRowData.study_start_date),
      primary_completion_date: getBaseValue('primary_completion_date', baseRowData.primary_completion_date),
      study_completion_date: getBaseValue('study_completion_date', baseRowData.study_completion_date),
      mono_combo: getBaseValue('mono_combo', baseRowData.mono_combo),
      regimens: getBaseValue('regimens', baseRowData.regimens),
      regimen_moa: getBaseValue('regimen_moa', baseRowData.regimen_moa),
      comparator_arm: getBaseValue('comparator_arm', baseRowData.comparator_arm),
      primary_endpoint: getBaseValue('primary_endpoint', baseRowData.primary_endpoint),
      secondary_endpoint: getBaseValue('secondary_endpoint', baseRowData.secondary_endpoint),
      stage: getBaseValue('stage', baseRowData.stage),
      stage_values: stageValues,
      line_of_therapy: getBaseValue('line_of_therapy', baseRowData.line_of_therapy),
      line_of_therapy_values: lineValues,
      mutations: getBaseValue('mutations', baseRowData.mutations),
      prospective_biomarkers: getBaseValue('prospective_biomarkers', baseRowData.prospective_biomarkers),
      dx_assay: getBaseValue('dx_assay', baseRowData.dx_assay),
      dx_cutoff_value: getBaseValue('dx_cutoff_value', baseRowData.dx_cutoff_value),
      included_based_on_prior: getBaseValue('included_based_on_prior', baseRowData.included_based_on_prior),
      included_based_on_prior_values: includedValues,
      excluded_based_on_prior: getBaseValue('excluded_based_on_prior', baseRowData.excluded_based_on_prior),
      excluded_based_on_prior_values: excludedValues,
      patients_brain_cns_mets: getBaseValue('patients_brain_cns_mets', baseRowData.patients_brain_cns_mets),
      sponsor: getBaseValue('sponsor', baseRowData.sponsor),
      collaborator: getBaseValue('collaborator', baseRowData.collaborator),
      location: getBaseValue('location', baseRowData.location),
      region: getBaseValue('region', baseRowData.region),
      clinical_failure: getBaseValue('clinical_failure', baseRowData.clinical_failure),
      trials_with_results: getBaseValue('trials_with_results', baseRowData.trials_with_results),
      approved_region: getBaseValue('approved_region', baseRowData.approved_region),
      regulatory_agency: getBaseValue('regulatory_agency', baseRowData.regulatory_agency),
      approval_year: getBaseValue('approval_year', baseRowData.approval_year),
      regulatory_designation: getBaseValue('regulatory_designation', baseRowData.regulatory_designation),
      reference: getBaseValue('reference', baseRowData.reference),
      study_identifier_source: getBaseValue('study_identifier_source', baseRowData.study_identifier_source),
      registrational_trial_source: getBaseValue('registrational_trial_source', baseRowData.registrational_trial_source),
      clinical_failure_source: getBaseValue('clinical_failure_source', baseRowData.clinical_failure_source),
      approval_labels_source: getBaseValue('approval_labels_source', baseRowData.approval_labels_source),
      regulatory_designations_source: getBaseValue('regulatory_designations_source', baseRowData.regulatory_designations_source),
      data_review_committee: getBaseValue('data_review_committee', baseRowData.data_review_committee),
      efficacy_evaluable: getBaseValue('efficacy_evaluable', baseRowData.efficacy_evaluable),
      orr: getBaseValue('orr', baseRowData.orr),
      dcr: getBaseValue('dcr', baseRowData.dcr),
      cr: getBaseValue('cr', baseRowData.cr),
      pr: getBaseValue('pr', baseRowData.pr),
      sd: getBaseValue('sd', baseRowData.sd),
      pd: getBaseValue('pd', baseRowData.pd),
      mdor_months: getBaseValue('mdor_months', baseRowData.mdor_months),
      pfs_months: getBaseValue('pfs_months', baseRowData.pfs_months),
      mpfs_months: getBaseValue('mpfs_months', baseRowData.mpfs_months),
      os_months: getBaseValue('os_months', baseRowData.os_months),
      mos_months: getBaseValue('mos_months', baseRowData.mos_months),
      os_percent: getBaseValue('os_percent', baseRowData.os_percent),
      dfs: getBaseValue('dfs', baseRowData.dfs),
      mdfs_months: getBaseValue('mdfs_months', baseRowData.mdfs_months),
      dfs_percent: getBaseValue('dfs_percent', baseRowData.dfs_percent),
      pfs_percent: getBaseValue('pfs_percent', baseRowData.pfs_percent),
      pfs_hr: getBaseValue('pfs_hr', baseRowData.pfs_hr),
      os_hr: getBaseValue('os_hr', baseRowData.os_hr),
      efficacy_others: getBaseValue('efficacy_others', baseRowData.efficacy_others),
      publication_source_clinical: getBaseValue('publication_source_clinical', baseRowData.publication_source_clinical),
      safety_evaluable: getBaseValue('safety_evaluable', baseRowData.safety_evaluable),
      grade_3_ae: getBaseValue('grade_3_ae', baseRowData.grade_3_ae),
      grade_3_traes: getBaseValue('grade_3_traes', baseRowData.grade_3_traes),
      immune_related_aes: getBaseValue('immune_related_aes', baseRowData.immune_related_aes),
      sae: getBaseValue('sae', baseRowData.sae),
      any_grade_aes: getBaseValue('any_grade_aes', baseRowData.any_grade_aes),
      deaths: getBaseValue('deaths', baseRowData.deaths),
      tx_related_mortality: getBaseValue('tx_related_mortality', baseRowData.tx_related_mortality),
      safety_others: getBaseValue('safety_others', baseRowData.safety_others),
      publication_source_safety: getBaseValue('publication_source_safety', baseRowData.publication_source_safety),
      asset_id: existingTrial?.asset_id || group.drugId,
      cohorts: existingTrial?.cohorts || [],
      import_row_details: mergedRowDetails,
      created_at: existingTrial?.created_at || new Date().toISOString()
    };

    if (existingTrial) {
      trial.trial_id = existingTrial.trial_id;
      await putRecord('trials', trial);
      updatedTrials++;
    } else {
      await addRecord('trials', trial);
      createdTrials++;
    }
  }

  // Log import
  await addLog('IMPORT', 'Excel File', `Created ${createdTrials} trials, updated ${updatedTrials} trials, added ${addedRowVariants} row variants`);

  // Sync all imported data to Firestore explicitly
  if (progressText) progressText.textContent = 'Syncing data to cloud...';
  console.log('ðŸ”„ Starting Firestore sync for all imported data...');
  
  // Suppress writes during batch fetch to avoid sync loops
  suppressFirestoreWrites = true;
  let firestoreSyncSuccess = false;
  
  try {
    const allCompanies = await getAllRecords('companies');
    const allDrugs = await getAllRecords('drugs');
    const allTrials = await getAllRecords('trials');
    const allNews = await getAllRecords('regulatory_announcements');
    
    console.log('ðŸ“‹ Local data before Firestore sync:', {
      companies: allCompanies.length,
      drugs: allDrugs.length,
      trials: allTrials.length,
      news: allNews.length
    });
    
    // Re-enable writes for sync
    suppressFirestoreWrites = false;
    
    if (firebaseState.db && firebaseState.user) {
      // Filter to only sync data from the imported hubs
      const companiesToSync = allCompanies.filter(c => importedHubs.has(normalizeHub(c.hub || 'IO')));
      const drugsToSync = allDrugs.filter(d => importedHubs.has(normalizeHub(d.hub || 'IO')));
      const trialsToSync = allTrials.filter(t => importedHubs.has(normalizeHub(t.hub || 'IO')));
      const newsToSync = allNews.filter(n => importedHubs.has(normalizeHub(n.hub || 'IO')));
      
      // Prepare batch records
      const batchRecords = [];
      
      console.log('ðŸ“¤ Preparing batch sync...', {
        companies: companiesToSync.length,
        drugs: drugsToSync.length,
        trials: trialsToSync.length,
        announcements: newsToSync.length
      });
      
      for (const company of companiesToSync) {
        if (company.company_id) {
          batchRecords.push({ storeName: 'companies', data: company, id: company.company_id });
        }
      }
      
      for (const drug of drugsToSync) {
        if (drug.drug_id) {
          batchRecords.push({ storeName: 'drugs', data: drug, id: drug.drug_id });
        }
      }
      
      for (const trial of trialsToSync) {
        if (trial.trial_id) {
          batchRecords.push({ storeName: 'trials', data: trial, id: trial.trial_id });
        } else {
          console.warn('âš ï¸ Trial missing trial_id - NOT synced:', trial);
        }
      }
      console.log('ðŸ“‹ Trial sync check:', trialsToSync.length, 'total trials', 'queued for sync:', batchRecords.filter(r => r.storeName === 'trials').length);
      
      for (const news of newsToSync) {
        if (news.news_id) {
          batchRecords.push({ storeName: 'regulatory_announcements', data: news, id: news.news_id });
        }
      }
      
      // IMPORTANT: Turn suppression OFF before batch sync
      suppressFirestoreWrites = false;
      
      // Batch sync all at once (much faster than individual writes)
      if (batchRecords.length > 0) {
        const trialRecords = batchRecords.filter(r => r.storeName === 'trials');
        console.log('ðŸš€ Starting batch sync:', batchRecords.length, 'total records');
        console.log('   Companies:', batchRecords.filter(r => r.storeName === 'companies').length);
        console.log('   Drugs:', batchRecords.filter(r => r.storeName === 'drugs').length);
        console.log('   Trials:', trialRecords.length);
        console.log('   News:', batchRecords.filter(r => r.storeName === 'regulatory_announcements').length);
        
        try {
          await batchSyncToFirestore(batchRecords);
          firestoreSyncSuccess = true;
          console.log('âœ… BATCH SYNC SUCCESS! All records synced including', trialRecords.length, 'trials');
          
          // Wait a moment for Firestore to propagate
          await new Promise(resolve => setTimeout(resolve, 500));
          console.log('âœ… Firestore sync confirmed');
        } catch (batchErr) {
          console.error('âŒ BATCH SYNC FAILED:', batchErr.message);
          console.error('   Could not sync trials:', trialRecords.length);
          console.warn('âš ï¸ Data saved locally - will sync when connection recovers');
        }
      } else {
        console.warn('âš ï¸ No records prepared for sync');
      }
    } else {
      console.log('âš ï¸ Firebase not initialized - data only saved locally');
    }
  } catch (err) {
    console.error('âŒ Import Firestore sync error:', err.message);
    suppressFirestoreWrites = false;
  }

  // Clear and reset
  if (progressText) progressText.textContent = 'Finalizing...';
  
  const hubsList = Array.from(importedHubs).join(', ');
  const needsSwitchHub = !importedHubs.has(currentHub);
  
  let message = `
    <div class="alert alert-success" style="font-size: 16px; padding: 24px;">
      <h3 style="margin-top: 0; color: #16a34a;">âœ“ Import Complete!</h3>
      <ul style="margin: 12px 0; line-height: 1.8;">
        <li>Created <strong>${createdTrials}</strong> new trials</li>
        <li>Updated <strong>${updatedTrials}</strong> existing trials</li>
        <li>Added <strong>${addedRowVariants}</strong> row variants</li>
        <li>Data imported to hub(s): <strong style="color: #3b82f6;">${hubsList}</strong></li>
        <li>âœ… All data synced to Firestore (cloud) - visible to all users!</li>
      </ul>
  `;
  
  if (needsSwitchHub) {
    const firstHub = Array.from(importedHubs)[0];
    message += `
      <div style="margin-top: 16px; padding: 14px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;">
        <strong style="color: #92400e;">âš ï¸ Note:</strong> You are currently viewing the <strong>${currentHub}</strong> hub, but data was imported to <strong>${hubsList}</strong>.
        <br/><br/>
        To view your imported data, please click on the <strong style="color: #3b82f6;">${firstHub}</strong> hub card on the home page.
      </div>
    `;
  } else {
    message += `<p style="margin: 12px 0 0 0; color: #475569;">New data is now visible in the Drugs and Trials tabs.</p>`;
  }
  
  message += '</div>';
  
  document.getElementById('mappingPreview').innerHTML = message;
  document.getElementById('excelInput').value = '';
  
  // Refresh all views
  await refreshAllViews();
  
  // Update hub dashboard
  await updateDashboardStats();
}

function cancelImport() {
  document.getElementById('mappingPreview').innerHTML = '';
  document.getElementById('excelInput').value = '';
  document.getElementById('importStatus').innerHTML = '';
}

// ============ Export Functions ============
async function exportToJSON() {
  if (!requireAdminAction()) return;
  const companies = await getAllRecords('companies');
  const drugs = await getAllRecords('drugs');
  const trials = await getAllRecords('trials');
  const logs = await getAllRecords('logs');

  const hubCompanies = companies.filter(c => getRecordHub(c) === currentHub);
  const hubDrugs = drugs.filter(d => getRecordHub(d) === currentHub);
  const hubTrials = trials.filter(t => getRecordHub(t) === currentHub);

  const data = {
    exported_at: new Date().toISOString(),
    hub: currentHub,
    companies: hubCompanies,
    drugs: hubDrugs,
    trials: hubTrials,
    logs
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dklinity_' + currentHub.toLowerCase() + '_export_' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

async function exportToExcel() {
  if (!requireAdminAction()) return;
  const companies = await getAllRecords('companies');
  const drugs = await getAllRecords('drugs');
  const trials = await getAllRecords('trials');

  const hubCompanies = companies.filter(c => getRecordHub(c) === currentHub);
  const hubDrugs = drugs.filter(d => getRecordHub(d) === currentHub);
  const hubTrials = trials.filter(t => getRecordHub(t) === currentHub);

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hubCompanies), 'Companies');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hubDrugs), 'Drugs');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hubTrials), 'Trials');

  XLSX.writeFile(wb, 'dklinity_' + currentHub.toLowerCase() + '_export_' + new Date().toISOString().split('T')[0] + '.xlsx');
}

// ============ Logs Management ============
async function clearAllLogs() {
  if (confirm('Are you sure you want to clear all logs?')) {
    const logs = await getAllRecords('logs');
    for (const log of logs) {
      await deleteRecord('logs', log.log_id);
    }
    await refreshAllViews();
  }
}

// ============ Data Management ============
async function clearAllData() {
  return clearHubData();
}

async function clearHubData() {
  if (!requireAdminAction()) return;
  try {
    console.log('ðŸ”´ Starting clear hub data for:', currentHub);
    let deletedCount = 0;
    
    // Helper function to detect actual hub based on record content
    const getActualRecordHub = (record, storeName) => {
      // First check if record has explicit hub field
      if (record.hub) {
        return normalizeHub(record.hub);
      }
      
      // Detect based on content for records without explicit hub field
      if (storeName === 'drugs') {
        // ADC drugs have asset_name, IO drugs have product_name
        if (record.asset_name && (record.conjugate_type || record.payload || record.linker)) {
          return 'ADC';
        }
        if (record.product_name) {
          return 'IO';
        }
      }
      
      if (storeName === 'trials') {
        // All trials should have hub field, but default to IO if missing
        return 'IO';
      }
      
      // Default
      return 'IO';
    };
    
    // Delete all companies
    const companies = await getAllRecords('companies');
    console.log('Found companies:', companies.length);
    for (const company of companies) {
      const companyHub = company.hub ? normalizeHub(company.hub) : 'IO';
      console.log(`Company "${company.company_name}" hub: "${companyHub}" vs current: "${currentHub}"`);
      if (companyHub === currentHub) {
        await deleteRecord('companies', company.company_id);
        deletedCount++;
      }
    }

    // Delete all drugs
    const drugs = await getAllRecords('drugs');
    console.log('Found drugs:', drugs.length);
    for (const drug of drugs) {
      const drugHub = getActualRecordHub(drug, 'drugs');
      console.log(`Drug "${drug.product_name || drug.asset_name}" detected hub: "${drugHub}" vs current: "${currentHub}"`);
      if (drugHub === currentHub) {
        await deleteRecord('drugs', drug.drug_id);
        deletedCount++;
      }
    }

    // Delete all trials
    const trials = await getAllRecords('trials');
    console.log('Found trials:', trials.length);
    for (const trial of trials) {
      const trialHub = trial.hub ? normalizeHub(trial.hub) : 'IO';
      console.log(`Trial "${trial.trial_identifier}" hub: "${trialHub}" vs current: "${currentHub}"`);
      if (trialHub === currentHub) {
        await deleteRecord('trials', trial.trial_id);
        deletedCount++;
      }
    }

    // Delete regulatory announcements
    const announcements = await getAllRecords('regulatory_announcements');
    console.log('Found regulatory announcements:', announcements.length);
    for (const announcement of announcements) {
      const annHub = announcement.hub ? normalizeHub(announcement.hub) : 'IO';
      if (annHub === currentHub) {
        await deleteRecord('regulatory_announcements', announcement.news_id);
        deletedCount++;
      }
    }

    // Log the action
    await addLog('DELETE', 'Hub Data', `Cleared ${currentHub} hub: deleted ${deletedCount} records (companies, drugs, trials, announcements)`);

    // Show success message and refresh
    alert(`âœ“ ${currentHub} hub data cleared successfully! (Deleted ${deletedCount} records)`);
    console.log('âœ“ Clear complete. Deleted:', deletedCount, 'records');
    
    // Now batch delete from Firestore (much faster than individual deletes)
    console.log('âš¡ Batch deleting from Firestore...');
    if (firebaseState.db && firebaseState.user) {
      try {
        // Prepare all queries for batch deletion
        const deleteQueries = [
          firebaseState.db.collection('companies').where('hub', '==', currentHub),
          firebaseState.db.collection('drugs').where('hub', '==', currentHub),
          firebaseState.db.collection('trials').where('hub', '==', currentHub),
          firebaseState.db.collection('regulatory_announcements').where('hub', '==', currentHub)
        ];
        
        console.log('ðŸ“¦ Batch deleting all collections for hub:', currentHub);
        await batchDeleteFromFirestore(deleteQueries);
        console.log('âœ… All data deleted from Firestore for hub:', currentHub);
      } catch (err) {
        console.error('âŒ Error batch deleting from Firestore:', err);
      }
    } else {
      console.warn('âš ï¸ Firebase not ready - Firestore deletions skipped (local data cleared)');
    }
    
    await refreshAllViews();
  } catch (error) {
    alert('Error clearing data: ' + error.message);
    console.error('Clear all data error:', error);
  }
}

// ============ Utility Functions ============
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Create a Google search link for a source text and append next to input fields
function createGoogleSearchLink(text) {
  if(!text) return '';
  const t = String(text || '').trim();
  
  // Check for pipe-separated format: "description | URL"
  const pipeParts = t.split('|').map(p => p.trim());
  if (pipeParts.length === 2) {
    const desc = pipeParts[0];
    const url = pipeParts[1];
    if(/^https?:\/\//i.test(url)){
      const shortUrl = createShortUrlForReference(url);
      return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(url)}" style="margin-left:8px;color:#2563eb;font-weight:600;text-decoration:underline;font-size:12px">${escapeHtml(desc)} â†’ ${escapeHtml(shortUrl)}</a>`;
    }
  }
  
  // Check for direct URL
  if(/^https?:\/\//i.test(t)){
    const shortUrl = createShortUrlForReference(t);
    return `<a href="${escapeHtml(t)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(t)}" style="margin-left:8px;color:#2563eb;font-weight:600;text-decoration:underline;font-size:12px">${escapeHtml(shortUrl)}</a>`;
  }
  return '';
}

function attachSourceLinks(containerId){
  const container = document.getElementById(containerId);
  if(!container) return;
  // find inputs whose id contains 'Source' or 'Reference'
  const inputs = container.querySelectorAll('input, textarea');
  inputs.forEach(inp=>{
    const id = inp.id || '';
    if(/source$/i.test(id) || /reference/i.test(id)){
      // remove old link if present
      const next = inp.nextElementSibling;
      if(next && next.classList && next.classList.contains('source-link')) next.remove();
      const span = document.createElement('span'); span.className='source-link'; span.style.marginLeft='8px';
      span.innerHTML = createGoogleSearchLink(inp.value || inp.placeholder || '');
      // Only append if there is a direct link to open
      if(span.innerHTML) inp.parentNode.appendChild(span);
      // update link when value changes and refresh rendered references
      inp.addEventListener('input',()=>{ span.innerHTML = createGoogleSearchLink(inp.value); renderReferencesFromInputs(containerId); });
    }
  });
}

// Split a source string into multiple items using common delimiters
function splitSources(txt){
  if(!txt) return [];
  return String(txt).split(/\||;|,/).map(s=>s.trim()).filter(Boolean);
}

// Parse sources with pipe (|) or ampersand (&&) delimiters returning {source, url} objects
function parseSourcesWithUrls(txt) {
  if (!txt) return [];
  const results = [];
  const str = String(txt).trim();
  
  // Split by && first (higher priority)
  const doubleAmpParts = str.split('&&').map(p => p.trim());
  if (doubleAmpParts.length > 1) {
    doubleAmpParts.forEach(part => {
      const trimmed = part.trim();
      if (trimmed.match(/^https?:\/\//i)) {
        results.push({ source: '', url: trimmed });
      } else {
        results.push({ source: trimmed, url: '' });
      }
    });
    // Pair sources with URLs
    for (let i = 0; i < results.length - 1; i++) {
      if (!results[i].url && results[i + 1].url) {
        results[i].url = results[i + 1].url;
        results[i + 1].skip = true;
      }
    }
    return results.filter(r => !r.skip);
  }
  
  // Split by | (pipe)
  const pipeParts = str.split('|').map(p => p.trim());
  if (pipeParts.length === 2) {
    const part1 = pipeParts[0];
    const part2 = pipeParts[1];
    if (part2.match(/^https?:\/\//i)) {
      return [{ source: part1, url: part2 }];
    }
  }
  
  // If no delimiters found, check if it's a direct URL
  if (str.match(/^https?:\/\//i)) {
    return [{ source: '', url: str }];
  }
  
  // Otherwise treat as plain text
  return [{ source: str, url: '' }];
}

function isUrl(s){ return /^https?:\/\//i.test(String(s||'').trim()); }
function isImageUrl(s){
  const str = String(s || '').toLowerCase().trim();
  return isUrl(str) && str.match(/\.(png|jpg|jpeg|gif|webp|svg)(\?.*)?$/i);
}

// Excel serial date to JS Date -> ISO string (YYYY-MM-DD)
function excelDateToISO(val){
  if(val === null || val === undefined || val === '') return '';
  if(typeof val === 'number'){
    // Excel stores dates as days since 1899-12-31 with a bug; using 25569 offset
    const utc_days = val - 25569;
    const utc_value = utc_days * 86400; // seconds
    const date_info = new Date(utc_value * 1000);
    // correct timezone offset
    const iso = date_info.toISOString().slice(0,10);
    return iso;
  }
  // If it is already a string parseable by Date
  const d = new Date(String(val));
  if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
  return String(val || '');
}

// Render parsed reference lists inside the drug modal Reference tab with separate rows for each source+link
function renderReferencesFromInputs(containerId){
  const container = document.getElementById(containerId);
  if(!container) return;
  const refPane = container.querySelector('#tab-reference');
  if(!refPane) return;
  // Remove existing rendered references area
  const existing = refPane.querySelector('.rendered-references');
  if(existing) existing.remove();

  const fieldsToCollect = [
    {id: 'drugMoASource', label: 'MoA / Modality Sources'},
    {id: 'drugAssetStatusSource', label: 'Asset Status Sources'},
    {id: 'drugPreclinPub', label: 'Preclinical Publications'},
    {id: 'drugSalesSource', label: 'Sales Sources'},
    {id: 'drugNewsSource', label: 'News Sources'},
    {id: 'drugRegDesignationsSource', label: 'Regulatory Designation Sources'},
    {id: 'drugUpcomingClinicalSource', label: 'Upcoming Clinical Milestone Sources'},
    {id: 'drugUpcomingRegSource', label: 'Upcoming Regulatory Milestone Sources'},
    {id: 'drugAntibodyTargetSource2', label: 'Antibody / Target Sources'},
    {id: 'drugDarLoadingRatioSource2', label: 'DAR / Loading Ratio Sources'},
    {id: 'drugPlatformTechnologySource2', label: 'Platform Technology Sources'},
    {id: 'drugPayloadsSource2', label: 'Payload Sources'},
    {id: 'drugLinkerSource2', label: 'Linker Sources'},
    {id: 'drugConjugationSource2', label: 'Conjugation Sources'},
    {id: 'drugAdcStructureSource2', label: 'ADC Structure Sources'},
    {id: 'drugAssetStatusSource2', label: 'ADC Asset Status Sources'},
    {id: 'drugRegDesignationsSource2', label: 'ADC Regulatory Designation Sources'},
    {id: 'drugBoxedWarningSource', label: 'Boxed Warning Sources'},
    {id: 'drugSalesSource2', label: 'ADC Sales Sources'},
    {id: 'drugNewsSource2', label: 'ADC News Sources'},
    {id: 'drugUpcomingClinicalSource2', label: 'ADC Upcoming Clinical Sources'},
    {id: 'drugUpcomingRegSource2', label: 'ADC Upcoming Regulatory Sources'},
    {id: 'drugPreclinPubSource2', label: 'ADC Preclinical Publications'},
    {id: 'drugClinicalFailureSource', label: 'Clinical Failure Sources'},
    {id: 'drugPartnershipsSource', label: 'Partnership Sources'}
  ];

  const wrap = document.createElement('div'); wrap.className = 'rendered-references'; wrap.style.marginTop = '12px';
  wrap.style.padding = '12px'; wrap.style.background = '#f8fafc'; wrap.style.borderRadius = '6px';

  fieldsToCollect.forEach(f=>{
    const el = document.getElementById(f.id);
    if(!el || !el.value) return;
    
    const parsedItems = parseSourcesWithUrls(el.value || '');
    if(parsedItems.length){
      const sect = document.createElement('div');
      sect.style.marginBottom = '16px';
      const h = document.createElement('div'); h.style.fontWeight='700'; h.style.marginBottom='8px'; h.style.color='#1e3a8a'; h.textContent = f.label;
      sect.appendChild(h);
      
      // Create table for sources
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.fontSize = '12px';
      table.style.borderCollapse = 'collapse';
      
      const thead = document.createElement('thead');
      thead.style.background = '#e6eef8';
      const headerRow = document.createElement('tr');
      const th1 = document.createElement('th');
      th1.textContent = 'Source';
      th1.style.padding = '6px 8px';
      th1.style.textAlign = 'left';
      th1.style.borderBottom = '1px solid #bfdbfe';
      th1.style.fontWeight = '700';
      const th2 = document.createElement('th');
      th2.textContent = 'Link';
      th2.style.padding = '6px 8px';
      th2.style.textAlign = 'left';
      th2.style.borderBottom = '1px solid #bfdbfe';
      th2.style.fontWeight = '700';
      headerRow.appendChild(th1);
      headerRow.appendChild(th2);
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      const tbody = document.createElement('tbody');
      parsedItems.forEach((item, idx) => {
        const row = document.createElement('tr');
        if (idx % 2 === 1) row.style.background = '#f0f4ff';
        
        const td1 = document.createElement('td');
        td1.style.padding = '6px 8px';
        td1.style.borderBottom = '1px solid #e6eef8';
        td1.textContent = item.source || '-';
        
        const td2 = document.createElement('td');
        td2.style.padding = '6px 8px';
        td2.style.borderBottom = '1px solid #e6eef8';
        
        if (item.url) {
          const shortUrl = createShortUrlForReference(item.url);
          const link = document.createElement('a');
          link.href = item.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.style.color = '#0066cc';
          link.style.textDecoration = 'none';
          link.style.fontSize = '11px';
          link.title = item.url;
          link.textContent = shortUrl;
          td2.appendChild(link);
        } else {
          td2.textContent = '-';
        }
        
        row.appendChild(td1);
        row.appendChild(td2);
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      sect.appendChild(table);
      wrap.appendChild(sect);
    }
  });

  if(wrap.childElementCount) refPane.appendChild(wrap);
}

// ============ Initialization ============
window.addEventListener('DOMContentLoaded', async () => {
  await initDB();
  await initAuth();
  await ensureHubFieldsOnRecords();
  await initFirebaseForHub(currentHub);
  await refreshAllViews();

  let savedTab = null;
  let savedHub = null;
  let wasInHub = false;
  try {
    savedTab = localStorage.getItem('dklinity.activeTab');
    savedHub = localStorage.getItem('dklinity.activeHub');
    wasInHub = sessionStorage.getItem('dklinity.inHub') === 'true';
  } catch (e) {}

  if (wasInHub && savedHub && currentUser) {
    await enterHub(savedHub, savedTab || 'dashboard');
  } else {
    setNavTabsVisible(false);
    activateTab('dashboard');
  }

  const loginOverlay = document.getElementById('loginOverlay');
  if (loginOverlay) {
    loginOverlay.addEventListener('click', (event) => {
      if (event.target === loginOverlay) {
        hideLoginOverlay();
      }
    });
    const loginCard = loginOverlay.querySelector('.login-card');
    if (loginCard) {
      loginCard.addEventListener('click', (event) => event.stopPropagation());
    }
  }
});

// Close modals on background click
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    closeAllModals();
  }
});
</script>

<!-- Scroll Reveal Animation Script -->
<script>
function revealOnScroll() {
  const reveals = document.querySelectorAll('.reveal');
  reveals.forEach(section => {
    const windowHeight = window.innerHeight;
    const revealTop = section.getBoundingClientRect().top;
    const revealPoint = 100;
    
    if (revealTop < windowHeight - revealPoint) {
      section.classList.add('active');
    }
  });
}

// Run on scroll
window.addEventListener('scroll', revealOnScroll);

// Run on load
revealOnScroll();
</script>

<footer class="site-footer">
  Dklinity Â© 2025 Clinical Trials and Drugs
</footer>

</body>
</html>
